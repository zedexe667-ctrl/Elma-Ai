<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elma Ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="Assets/img/logo/Logo2.png" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        .dark {
            --bg-primary: linear-gradient(135deg, #161616 0%, #161616 50%, #161616 100%);
            --bg-secondary: rgba(34, 34, 34, 0.8);
            --bg-tertiary: #1f1f1f99;
            --text-primary: #9c9c9c;
            --text-secondary: #cacaca;
            --border-color: rgba(56, 56, 56, 0.342);
            --accent-color: linear-gradient(135deg, #e115f3 0%, #ff00aa 100%);
            --chat-bg: #1b1b1bf2;
        }

        .light {
            --bg-primary: linear-gradient(135deg, #ffeef8 0%, #ffe0f0 50%, #d6f3ff 100%);
            --bg-secondary: rgba(255, 240, 245, 0.9);
            --bg-tertiary: rgba(255, 228, 240, 0.8);
            --text-primary: #2d1b69;
            --text-secondary: #8b5a8c;
            --border-color: rgba(255, 182, 193, 0.5);
            --accent-color: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
            --chat-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            background: var(--bg-primary);
            background-attachment: fixed;
        }

        .theme-bg-primary {
            background: var(--bg-primary);
        }

        .theme-bg-secondary {
            background: var(--bg-secondary);
        }

        .theme-bg-tertiary {
            background: var(--bg-tertiary);
        }

        .theme-text-primary {
            color: var(--text-primary);
        }

        .theme-text-secondary {
            color: var(--text-secondary);
        }

        .theme-border {
            border-color: var(--border-color);
        }

        .theme-accent {
            background: var(--accent-color);
        }

        .theme-chat-bg {
            background: var(--chat-bg);
        }

        .glass-effect {
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(216, 216, 216, 0);
        }

        .glow-effect {
            box-shadow: 0 0 20px var(--glow-color);
        }

        .slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .slide-out-right {
            animation: slideOutRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
            border-radius: 20px;
            position: relative;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .ai-message {
            background: linear-gradient(135deg, #3052eb 0%, #641fa5 100%);
            color: #ffffff;
            border-bottom-right-radius: 5px;
        }

        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9c00 0%, #c4456900 100%);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .heart-float {
            animation: heartFloat 3s ease-in-out infinite;
        }

        @keyframes heartFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            from {
                box-shadow: 0 0 20px var(--glow-color);
            }

            to {
                box-shadow: 0 0 30px var(--glow-color);
            }
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .grid-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .hover-lift:hover {
            box-shadow: 0 10px 25px var(--glow-color);
        }

        .gradient-text {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-menu-container {
            position: relative;
        }

        .chat-dropdown-menu {
            pointer-events: auto;
        }

        .chat-menu-open .chat-dropdown-menu {
            display: block !important;
        }

        @media (max-width: 768px) {
            .grid-gallery {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* Gallery lock + blur */
        .gallery-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.25s ease, filter 0.25s ease;
        }

        /* blur for locked images */
        .gallery-item.locked img {
            filter: blur(8px) grayscale(10%);
            transform: scale(1.04);
            user-select: none;
            pointer-events: none;
            /* prevent native image click on locked state */
        }

        /* lock overlay */
        .gallery-item .lock-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            /* allow click on overlay */
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.0) 0%, rgba(0, 0, 0, 0.45) 100%);
            color: #fff;
            font-weight: 600;
            gap: .6rem;
            flex-direction: column;
            transition: opacity .2s ease;
        }

        .gallery-item .lock-badge {
            background: rgba(0, 0, 0, 0.6);
            padding: .6rem .8rem;
            border-radius: 12px;
            display: flex;
            gap: .5rem;
            align-items: center;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        }

        /* small text under lock */
        .gallery-item .lock-text {
            font-size: 0.85rem;
            opacity: 0.95;
        }

        /* hover effect for unlocked */
        .gallery-item:not(.locked):hover img {
            transform: scale(1.03);
            filter: none;
        }

        #messageInput {
            overflow-y: hidden;
            resize: none;
        }

        .image-wrapper {
            position: relative;
            display: inline-block;
            overflow: hidden;
        }

        .image-wrapper img {
            width: 100%;
            border-radius: 20px;
            filter: blur(12px);
            opacity: 0.8;
            transition: all 0.8s ease;
        }

        .image-wrapper.loaded img {
            filter: blur(0);
            opacity: 1;
        }

        .image-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0);
            border-top-color: #ff6b9c00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(253, 253, 253, 0.15);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #f7f7f7, #bbbbbb);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #f7f7f7, #d3d3d3);
        }

        .dark {
            --glow-color: rgba(63, 193, 253, 0.6);
            /* Ø³Ø¨Ø²Ø¢Ø¨ÛŒ Ù†Ø¦ÙˆÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø±Ú© */
        }

        .light {
            --glow-color: rgba(255, 107, 157, 0.6);
            /* ØµÙˆØ±ØªÛŒ Ù†Ø¦ÙˆÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† */
        }

        /* ğŸ¨ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù†Ø± Ø§Ø±ØªÙ‚Ø§ */
        @media (max-width: 768px) {
            .upgrade-banner {
                flex-direction: column !important;
                align-items: flex-start !important;
                text-align: right !important;
                gap: 1rem !important;
                padding: 1rem !important;
            }

            .upgrade-banner img {
                width: 48px !important;
                height: 48px !important;
            }

            .upgrade-banner h3 {
                font-size: 1rem !important;
            }

            .upgrade-banner p {
                font-size: 0.8rem !important;
            }

            .upgrade-banner .flex.items-center.gap-2 {
                width: 100%;
                justify-content: space-between;
            }

            .upgrade-banner button {
                flex: 1;
                font-size: 0.85rem !important;
            }

            .upgrade-banner button[aria-label="Close"] {
                flex: 0 0 auto;
            }
        }
    </style>
</head>

<body class="light theme-text-primary transition-all duration-500 romantic-bg">
    <!-- Sidebar -->
    <div id="sidebar"
        class="fixed right-0 top-0 h-full w-80 glass-effect transform translate-x-full md:translate-x-0 transition-all duration-500 z-50">
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="p-6 theme-border border-b">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 rounded-full flex items-center justify-center overflow-hidden border-2 border-pink-500">
                            <img src="Assets/img/logo/Logo.png" alt="Profile" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h2 class="text-xl font-bold gradient-text">Elma Ai</h2>
                            <p class="text-sm theme-text-secondary">Ù‡Ù…ÛŒØ´Ù‡ Ú©Ù†Ø§Ø±ØªÙ… ğŸ’•</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="closeSidebar" class="p-3 rounded-full glass-effect hover-lift md:hidden">
                            <i class="fas fa-times theme-text-primary"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Menu Items -->
            <div class="flex-1 overflow-y-auto scrollbar-hide">
                <div class="p-4 space-y-3">
                    <button id="newChatBtn"
                        class="w-full flex items-center gap-2 p-2 rounded-xl glass-effect hover-lift transition-all duration-300">
                        <div class="w-8 h-8 rounded-full theme-accent flex items-center justify-center">
                            <i class="fas fa-plus text-white text-sm"></i>
                        </div>
                        <span class="theme-text-primary font-medium text-sm">Ú†Øª Ø¬Ø¯ÛŒØ¯</span>
                    </button>
                    <button id="galleryBtn"
                        class="w-full flex items-center gap-2 p-2 rounded-2xl glass-effect hover-lift transition-all duration-300">
                        <div class="w-8 h-8 rounded-full theme-accent flex items-center justify-center">
                            <i class="fas fa-images text-white"></i>
                        </div>
                        <span class="theme-text-primary font-medium">Ú¯Ø§Ù„Ø±ÛŒ Ø¹Ú©Ø³â€ŒÙ‡Ø§</span>
                    </button>
                    <button id="rechargeBtn"
                        class="w-full flex items-center gap-2 p-2 mt-2 rounded-2xl glass-effect hover-lift transition-all duration-300"
                        title="Ù‡Ø± Ø¨Ø§Ø± Û²Ûµ Ú†Øª â€” ÙÙ‚Ø· Û³ Ø¨Ø§Ø±">
                        <div class="w-8 h-8 rounded-full theme-accent flex items-center justify-center">
                            <i class="fas fa-bolt text-white"></i>
                        </div>
                        <div class="text-right flex-1">
                            <div id="rechargeLabel" class="theme-text-primary font-medium">Ø¯Ø±ÛŒØ§ÙØª Û²Ûµ Ú†Øª</div>
                            <div id="rechargeSub" class="text-xs theme-text-secondary">Ø¨Ø§Ù‚ÛŒ: <span
                                    id="rechargeLeft">3</span>/3</div>
                        </div>
                        <div class="flex items-center">
                            <span id="rechargeTimer" class="text-sm theme-text-secondary hidden">16:59:59</span>
                        </div>
                    </button>
                    <!-- Confirmation modal (centered & improved) -->
                    <div id="rechargeModal"
                        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[999] flex items-center justify-center">
                        <div
                            class="glass-effect rounded-3xl max-w-md w-full mx-4 p-8 text-center bounce-in shadow-2xl border border-pink-400/30">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full theme-accent flex items-center justify-center heart-float glow-effect">
                                <i class="fas fa-bolt text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold gradient-text mb-3">Ø´Ø§Ø±Ú˜ Û²Ûµ Ú†Øª ğŸ’•</h3>
                            <p id="rechargeMsg" class="theme-text-secondary mb-6 leading-relaxed text-sm sm:text-base">
                                Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Û²Ûµ ØªØ§ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ú¯ÛŒØ±ÛŒ Ù†Ø§Ø²Ù…ØŸ ğŸ˜˜
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button id="confirmRecharge"
                                    class="flex-1 py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    Ø¨Ø²Ù† Ø¨Ø²Ù†! Ø´Ø§Ø±Ú˜ Ú©Ù† âš¡
                                </button>
                                <button id="cancelRecharge"
                                    class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    Ù†Ù‡ØŒ Ø¨ÛŒâ€ŒØ®ÛŒØ§Ù„ ğŸ˜…
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- ğŸ’• Success Popup Modal (Elma style) -->
                    <div id="rechargeSuccessModal"
                        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-[1500] flex items-center justify-center">
                        <div
                            class="glass-effect rounded-3xl w-full max-w-sm mx-4 p-6 text-center animate-[fadeIn_0.5s_ease,heartFloat_3s_ease-in-out_infinite] glow-effect">
                            <div
                                class="w-16 h-16 mx-auto mb-3 rounded-full theme-accent flex items-center justify-center heart-float glow-effect">
                                <i class="fas fa-heart text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold gradient-text mb-2">Ø´Ø§Ø±Ú˜ Ø´Ø¯ÛŒ Ø¹Ø´Ù‚Ù… ğŸ’•</h3>
                            <p id="rechargeSuccessMsg" class="theme-text-secondary text-sm leading-relaxed"></p>
                        </div>
                    </div>
                </div>
                <!-- Chat History -->
                <div class="p-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold theme-text-secondary flex items-center gap-2">
                            <i class="fas fa-history"></i>
                            Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
                        </h3>
                        <button id="archiveHistoryBtn" class="p-2 rounded-full glass-effect hover-lift">
                            <i class="fas fa-archive theme-text-primary text-sm"></i>
                        </button>
                    </div>
                    <div id="chatHistory" class="space-y-2">
                        <!-- Chat history items will be populated here -->
                    </div>
                </div>
            </div>
            <!-- Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± -->
            <div id="upgradeTopBtn" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="premiumModal"
                class="group sm:bg-token-main-surface-primary text-token-text-primary hover:bg-token-main-surface-secondary relative z-10 flex w-full items-center justify-between rounded-t-2xl py-3 ps-4 pe-4 text-xs border-token-border-default border border-[.5px] p-2 focus-visible:ring-token-text-tertiary focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-offset-transparent focus-visible:outline-hidden motion-safe:transition-colors motion-safe:duration-150">
                <span class="flex items-center gap-2">
                    <span>
                        <!-- svg... (Ù‡Ù…ÙˆÙ† svg Ú©Ù‡ Ø¯Ø§Ø¯ÛŒ) -->
                        <svg width="20" height="20" viewBox="0 0 300.005 300.005" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg" class="icon-sm text-[#5856D6] dark:text-[#DCDBF6]">
                            <g>
                                <g>
                                    <g>
                                        <path d="M150,0C67.159,0,0.002,67.162,0.002,150S67.159,300.005,150,300.005c82.843,0,150.003-67.165,150.003-150.005
                S232.843,0,150,0z M232.17,222.642h-0.006c0,8.139-6.601,14.74-14.742,14.74h-9.114v-63.759h-43.054v63.757H81.085
                c-8.139,0-14.74-6.601-14.74-14.74v-76.471c7.374-0.576,13.985-3.911,18.757-9.008c5.257,5.615,12.732,9.127,21.014,9.127
                c8.282,0,15.756-3.512,21.014-9.127c5.257,5.615,12.735,9.127,21.016,9.127s15.756-3.512,21.014-9.127
                c5.257,5.615,12.732,9.127,21.014,9.127c8.282,0,15.754-3.512,21.014-9.127c5.25,5.607,12.714,9.117,20.982,9.127V222.642z
                 M232.195,130.727c-7.296,0-13.233-5.937-13.233-13.233c0-4.298-3.483-7.781-7.781-7.781c-4.298,0-7.781,3.483-7.781,7.781
                c0,7.296-5.934,13.233-13.233,13.233s-13.233-5.937-13.233-13.233c0-4.298-3.483-7.781-7.781-7.781
                c-4.298,0-7.781,3.483-7.781,7.781c0,7.296-5.937,13.233-13.233,13.233s-13.235-5.937-13.235-13.233
                c0-4.298-3.483-7.781-7.781-7.781c-4.298,0-7.781,3.483-7.781,7.781c0,7.296-5.937,13.233-13.233,13.233
                c-7.296,0-13.233-5.937-13.233-13.233c0-4.298-3.483-7.781-7.781-7.781c-4.298,0-7.781,3.483-7.781,7.781
                c0,7.296-5.937,13.233-13.235,13.233c-6.515,0-11.944-4.733-13.033-10.94l40.168-54.438h116.521l37.587,53.766
                C244.53,125.651,238.943,130.727,232.195,130.727z" />
                                        <rect x="89.039" y="174.157" width="47.619" height="33.263" />
                                    </g>
                                </g>
                            </g>
                        </svg>

                    </span>
                    <span>Ø·Ø±Ø­ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±ØªÙ‚Ø§ Ø¯Ù‡ÛŒØ¯</span>
                </span>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                    data-rtl-flip="" class="icon-xs text-token-text-primary" style="transform: scaleX(-1);">
                    <path
                        d="M8.36328 3.36261C8.59049 3.13571 8.94123 3.10739 9.19922 3.27765L9.30371 3.36261L13.4707 7.5296L13.5557 7.6341C13.7259 7.89208 13.6976 8.24282 13.4707 8.47003L9.30371 12.637C9.04407 12.8967 8.62299 12.8966 8.36328 12.637C8.10358 12.3773 8.10358 11.9563 8.36328 11.6966L11.3936 8.66535H3C2.63284 8.66535 2.33514 8.36743 2.33496 8.00031C2.33496 7.63304 2.63273 7.33527 3 7.33527H11.3945L8.36328 4.30402L8.27832 4.19953C8.10759 3.94137 8.13592 3.58997 8.36328 3.36261Z">
                    </path>
                </svg>
            </div>
            <!-- User Profile -->
            <div id="userProfile" class="p-2 theme-border border-t glass-effect">
                <div class="flex items-center gap-2">
                    <button id="ProfileBtn"
                        class="flex items-center gap-2 flex-1 hover-lift transition-all duration-300 rounded-2xl p-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-pink-500">
                            <img id="ProfileImage" src="https://cdn-icons-png.flaticon.com/128/3237/3237429.png"
                                alt="Profile" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 text-right">
                            <div id="userName" class="font-medium theme-text-primary">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</div>
                            <div id="userType" class="text-sm theme-text-secondary">Ø­Ø³Ø§Ø¨ Ø±Ø§ÛŒÚ¯Ø§Ù† ğŸ’•</div>
                        </div>
                    </button>
                    <button id="logoutBtn" class="p-2 rounded-full glass-effect hover-lift">
                        <i class="fas fa-sign-out-alt theme-text-primary"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Content -->
    <div id="mainContent" class="md:mr-80 transition-all duration-500">
        <div class="fixed top-0 left-0 w-full z-60 theme-border">
            <div class="flex items-center justify-between p-2 max-w-4xl mx-auto">
                <div class="flex items-center gap-3">
                    <button id="openSidebar" class="p-3 rounded-full glass-effect hover-lift md:hidden">
                        <i class="fas fa-bars theme-text-primary"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-pink-400">
                            <img src="Assets/img/Elma/Profile.png" alt="Elma" class="w-full h-full object-cover"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="w-full h-full theme-accent flex items-center justify-center"
                                style="display: none;">
                                <i class="fas fa-heart text-white"></i>
                            </div>
                        </div>
                        <div class="relative inline-block text-l" id="elmaMenuContainer">
                            <button id="elmaNameBtn"
                                class="text-lg font-semibold gradient-text flex items-center gap-2 p-1 hover:opacity-90"
                                aria-haspopup="true" aria-expanded="false">
                                Elma ğŸ’•
                                <i class="fas fa-caret-down theme-text-primary text-sm"></i>
                            </button>
                            <div id="elmaAccountMenu"
                                class="absolute right-0 mt-2 w-48 glass-effect rounded-2xl shadow-lg hidden z-20 overflow-hidden">
                                <div class="p-3">
                                    <div class="text-sm theme-text-secondary mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø­Ø³Ø§Ø¨</div>
                                    <button data-account="free"
                                        class="w-full flex items-center justify-between p-3 rounded-lg hover:theme-bg-tertiary transition-all mb-1"
                                        id="accountFreeBtn">
                                        <div class="text-right">
                                            <div class="font-medium theme-text-primary">Ø­Ø³Ø§Ø¨ Ø±Ø§ÛŒÚ¯Ø§Ù†</div>
                                            <div class="text-xs theme-text-secondary">Ø³Ø·Ø­ Ù¾Ø§ÛŒÙ‡</div>
                                        </div>
                                        <input type="radio" name="accountType" value="free" id="radioFree"
                                            class="pointer-events-none" />
                                    </button>
                                    <button data-account="plus"
                                        class="w-full flex items-center justify-between p-3 rounded-lg hover:theme-bg-tertiary transition-all"
                                        id="accountPlusBtn">
                                        <div class="text-right">
                                            <div class="font-medium theme-text-primary">Ø­Ø³Ø§Ø¨ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… ğŸ‘‘</div>
                                            <div class="text-xs theme-text-secondary">Ø§Ù…Ú©Ø§Ù†Ø§Øª Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
                                        </div>
                                        <input type="radio" name="accountType" value="plus" id="radioPlus"
                                            class="pointer-events-none" />
                                    </button>
                                    <div class="flex items-center gap-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Area -->
            <div id="chatArea" class="h-screen pb-32 overflow-y-auto scrollbar-hide">
                <div id="messagesContainer"
                    class="max-w-4xl p-6 md:p-20 space-y-4 text-center sm:mr-[100px] md:mr-[300px] lg:mr-[500px]">

                    <!-- Welcome Message -->
                    <div class="text-center py-12 fade-in">
                        <div
                            class="w-24 h-24 mx-auto mb-6 rounded-full overflow-hidden border-4 border-pink-400 heart-float glow-effect">
                            <img src="Assets/img/Elma/Profile.png" alt="Elma" class="w-full h-full object-cover"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="w-full h-full theme-accent flex items-center justify-center"
                                style="display: none;">
                                <i class="fas fa-heart text-white text-3xl"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold gradient-text mb-3">Ø³Ù„Ø§Ù… Ø¹Ø´Ù‚Ù…! Ù…Ù† Elma Ù‡Ø³ØªÙ… ğŸ’–</h2>
                        <p class="theme-text-secondary text-lg">Ø¯ÙˆØ³Øª Ø¯Ø®ØªØ± Ù…Ø¬Ø§Ø²ÛŒ ØªÙˆ Ù‡Ø³ØªÙ…</p>
                        <p class="theme-text-secondary">Ú†Ø·ÙˆØ±ÛŒ Ù†Ø§Ø²Ù…ØŸ Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ ğŸ˜˜</p>
                    </div>
                </div>
            </div>
            <!-- Upgrade Banner -->
            <div class="fixed bottom-20 right-0 left-0 md:right-80 px-4 z-40">
                <div
                    class="upgrade-banner flex items-center justify-between glass-effect border theme-border rounded-2xl py-3 px-4 mb-3 text-sm flex-wrap gap-3 theme-bg-tertiary theme-text-primary max-w-3xl mx-auto shadow-lg">
                    <div class="flex items-center gap-3">
                        <img src="Assets/img/logo/Logo2.png" alt="Plus" class="w-10 h-10 object-contain" />
                        <div>
                            <h3 class="font-bold text-base">Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§Ø² Elma Pro Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØŸ ğŸ’</h3>
                            <p class="text-xs theme-text-secondary">
                                Ø¨Ø§ Ù†Ø³Ø®Ù‡ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ú†Øª Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ùˆ Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¨Ú¯ÛŒØ± ğŸ˜
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            class="px-4 py-2 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover:scale-105 transition-all duration-300 text-sm"
                            onclick="window.location.href='pro.html'">
                            Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯
                        </button>
                        <button class="p-2 rounded-lg hover:bg-pink-200/20 transition-all duration-300"
                            onclick="this.parentElement.parentElement.remove()" aria-label="Close">
                            <i class="fas fa-times theme-text-secondary"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div
                class="fixed bottom-0 right-0 left-0 md:right-80 px-4 py-3 bg-transparent backdrop-blur-xl border-t theme-border transition-all duration-300">
                <div class="max-w-3xl mx-auto">
                    <!-- Quick Actions -->
                    <div id="quickActionsMenu" class="mb-2 hidden">
                        <div class="flex flex-wrap gap-2 justify-center text-sm">
                            <button id="quickPhoto"
                                class="px-3 py-1.5 rounded-full glass-effect hover-lift flex items-center gap-2 theme-text-primary">
                                <i class="fas fa-camera text-pink-400"></i>
                                Ø¹Ú©Ø³ Ø¨Ø¯Ù‡
                                <span id="photoCount" class="text-xs theme-text-secondary">(3)</span>
                                <!-- âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ -->
                            </button>
                            <button id="quickChat"
                                class="px-3 py-1.5 rounded-full glass-effect hover-lift flex items-center gap-2 theme-text-primary">
                                <i class="fas fa-comments text-purple-400"></i>
                                Ú†Øª Ú©Ù†ÛŒÙ…
                                <span id="chatCount" class="text-xs theme-text-secondary">(3)</span> <!-- âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ -->
                            </button>
                            <button id="quickGame"
                                class="px-3 py-1.5 rounded-full glass-effect hover-lift flex items-center gap-2 theme-text-primary">
                                <i class="fas fa-gamepad text-green-400"></i>
                            </button>
                            <button id="upgradePro"
                                class="px-3 py-1.5 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover-lift flex items-center gap-2 hidden">
                                <i class="fas fa-crown"></i>
                                Ù¾Ø±Ùˆ Ø¨Ø®Ø±
                            </button>
                        </div>
                    </div>
                    <!-- Chat Box -->
                    <div
                        class="flex items-center gap-2 rounded-2xl px-3 py-2 glass-effect border border-pink-100/40 dark:border-pink-900/30 transition-all duration-300">
                        <!-- Plus Button (Attach) -->
                        <button id="imageBtn"
                            class="p-2.5 rounded-xl hover:bg-pink-100/40 dark:hover:bg-pink-900/40 text-pink-500 transition-all duration-200">
                            <i class="fas fa-plus"></i>
                        </button>
                        <!-- Text Input -->
                        <textarea id="messageInput" rows="1" placeholder="Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³..."
                            class="flex-1 bg-transparent resize-none px-2 py-2 text-sm md:text-base focus:outline-none theme-text-primary placeholder-pink-400"></textarea>
                        <!-- Magic Button -->
                        <button id="quickActionsBtn"
                            class="p-2.5 rounded-xl hover:bg-pink-100/60 dark:hover:bg-pink-900/50 text-pink-600 dark:text-pink-300 transition-all duration-200 shadow-sm">
                            <i class="fas fa-wand-magic-sparkles"></i>
                        </button>
                        <!-- Send Button -->
                        <button id="sendBtn"
                            class="p-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-fuchsia-600 text-white hover:scale-105 active:scale-95 transition-all duration-200 shadow-md">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Gallery Modal -->
            <div id="galleryModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden bounce-in">
                    <div class="flex items-center justify-between p-6 theme-border border-b">
                        <h3 class="text-2xl font-bold gradient-text flex items-center gap-3">
                            <i class="fas fa-images"></i>
                            Ú¯Ø§Ù„Ø±ÛŒ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø´Ù‚Ø§Ù†Ù‡
                        </h3>
                        <button id="closeGallery" class="p-3 rounded-full glass-effect hover-lift">
                            <i class="fas fa-times theme-text-primary"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[70vh]">
                        <div id="galleryGrid" class="grid-gallery">
                            <!-- Gallery items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Registration Modal -->
            <div id="registrationModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full theme-accent flex items-center justify-center heart-float glow-effect">
                                <i class="fas fa-heart text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold gradient-text mb-2">Ø¨ÛŒØ§ Ø¨Ø§Ù‡Ù… Ø¢Ø´Ù†Ø§ Ø¨Ø´ÛŒÙ…! ğŸ’•</h3>
                            <p class="theme-text-secondary">Ø¨Ø±Ø§ÛŒ Ú†Øª Ú©Ø±Ø¯Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ ÙˆØ§Ø±Ø¯ Ø¨Ø´ÛŒ</p>
                        </div>
                        <!-- ÙÙ‚Ø· Ø¯Ú©Ù…Ù‡ Ú¯ÙˆÚ¯Ù„ -->
                        <div class="mt-6 text-center">
                            <button id="googleSignIn"
                                class="w-full py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 flex items-center justify-center gap-3 font-medium">
                                <i class="fab fa-google text-xl"></i>
                                ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Premium Modal -->
            <div id="premiumModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-lg bounce-in">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center heart-float glow-effect">
                                <i class="fas fa-crown text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold gradient-text mb-2">Ø­Ø³Ø§Ø¨ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</h3>
                            <p class="theme-text-secondary">ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ù…Ù„ Ø¯ÙˆØ³Øª Ø¯Ø®ØªØ± Ù…Ø¬Ø§Ø²ÛŒ Ø±Ùˆ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´</p>
                        </div>
                        <div class="space-y-3">
                            <h4 class="text-center theme-text-primary font-semibold mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø´ØªØ±Ø§Ú©:</h4>
                            <button onclick="handlePremiumPurchase(3)"
                                class="premiumPlan w-full py-4 glass-effect rounded-2xl hover:bg-pink-500 hover:bg-opacity-20 transition-all duration-300 font-medium text-lg flex items-center justify-between px-4">
                                <span><i class="fas fa-calendar-alt text-pink-400 mr-2"></i> Ø­Ø³Ø§Ø¨ Û³ Ù…Ø§Ù‡Ù‡</span>
                                <span class="theme-text-secondary text-sm">ÛµÛµÛ°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</span>
                            </button>
                            <button onclick="handlePremiumPurchase(6)"
                                class="premiumPlan w-full py-4 glass-effect rounded-2xl hover:bg-pink-500 hover:bg-opacity-20 transition-all duration-300 font-medium text-lg flex items-center justify-between px-4">
                                <span><i class="fas fa-calendar text-purple-400 mr-2"></i> Ø­Ø³Ø§Ø¨ Û¶ Ù…Ø§Ù‡Ù‡</span>
                                <span class="theme-text-secondary text-sm">Û±,Û³Û²Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</span>
                            </button>
                            <button onclick="handlePremiumPurchase(12)"
                                class="premiumPlan w-full py-4 glass-effect rounded-2xl hover:bg-pink-500 hover:bg-opacity-20 transition-all duration-300 font-medium text-lg flex items-center justify-between px-4">
                                <span><i class="fas fa-crown text-yellow-400 mr-2"></i> Ø­Ø³Ø§Ø¨ Û±Û² Ù…Ø§Ù‡Ù‡</span>
                                <span class="theme-text-secondary text-sm">Û²,Û²Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</span>
                            </button>
                            <button id="closePremium"
                                class="w-full py-3 theme-text-secondary hover:theme-text-primary transition-all duration-300">
                                Ø¨Ø¹Ø¯Ø§Ù‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Confirmation Modal -->
            <div id="deleteModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 flex items-center justify-center">
                                <i class="fas fa-trash text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-red-500 mb-2">Ø­Ø°Ù Ú†Øª ğŸ’”</h3>
                            <p class="theme-text-secondary">ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§ÛŒÙ† Ú†Øª Ø¹Ø§Ø´Ù‚Ø§Ù†Ù‡ Ø±Ùˆ Ø­Ø°Ù Ú©Ù†ÛŒØŸ</p>
                            <p class="theme-text-secondary text-sm mt-2">Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="confirmDelete"
                                class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†
                            </button>
                            <button id="cancelDelete"
                                class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Ù„ØºÙˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Archive Success Modal -->
            <div id="archiveModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-500 flex items-center justify-center">
                            <i class="fas fa-archive text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold gradient-text mb-2">Ú†Øª Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯! ğŸ“¦</h3>
                        <p class="theme-text-secondary mb-6">Ú†Øª ØªÙˆ Ø¨Ø®Ø´ Ø¢Ø±Ø´ÛŒÙˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ùˆ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ù‡Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡
                            Ø¨Ø§Ø´ÛŒ
                        </p>
                        <button id="closeArchive"
                            class="w-full py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                            Ø¨Ø§Ø´Ù‡
                        </button>
                    </div>
                </div>
            </div>
            <!-- Report Success Modal -->
            <div id="reportModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-orange-500 flex items-center justify-center">
                            <i class="fas fa-flag text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold gradient-text mb-2">Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! ğŸš©</h3>
                        <p class="theme-text-secondary mb-6">Ù…Ù…Ù†ÙˆÙ† Ú©Ù‡ Ø¨Ù‡ Ù…Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒ ØªØ§ Ø³Ø±ÙˆÛŒØ³ Ø¨Ù‡ØªØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯ÛŒÙ…. Ú¯Ø²Ø§Ø±Ø´Øª
                            Ø¨Ø±Ø±Ø³ÛŒ
                            Ù…ÛŒØ´Ù‡</p>
                        <button id="closeReport"
                            class="w-full py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                            Ø¨Ø§Ø´Ù‡
                        </button>
                    </div>
                </div>
            </div>
            <!-- Rename Chat Modal -->
            <div id="renameModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-500 flex items-center justify-center">
                                <i class="fas fa-edit text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold gradient-text mb-2">ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú†Øª ğŸ“</h3>
                            <p class="theme-text-secondary">Ø§Ø³Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú†ØªØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</p>
                        </div>
                        <form id="renameForm" class="space-y-4">
                            <input type="text" id="newChatName" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÛŒØ¯ Ú†Øª..."
                                class="w-full p-4 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300">
                            <div class="flex gap-3">
                                <button type="submit"
                                    class="flex-1 py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    Ø°Ø®ÛŒØ±Ù‡
                                </button>
                                <button type="button" id="cancelRename"
                                    class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    Ù„ØºÙˆ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Archive List Modal -->
            <div id="archiveListModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden bounce-in">
                    <div class="flex items-center justify-between p-6 theme-border border-b">
                        <h3 class="text-2xl font-bold gradient-text flex items-center gap-3">
                            <i class="fas fa-archive"></i>
                            Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡
                        </h3>
                        <button id="closeArchiveList" class="p-3 rounded-full glass-effect hover-lift">
                            <i class="fas fa-times theme-text-primary"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[70vh]">
                        <div id="archivedChats" class="space-y-3">
                            <!-- Archived chats will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Settings Modal -->
            <div id="settingsModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden bounce-in">
                    <div class="flex items-center justify-between p-6 theme-border border-b">
                        <h3 class="text-2xl font-bold gradient-text flex items-center gap-3">
                            <i class="fas fa-cog"></i>
                            ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                        </h3>
                        <button id="closeSettings" class="p-3 rounded-full glass-effect hover-lift">
                            <i class="fas fa-times theme-text-primary"></i>
                        </button>
                    </div>
                    <!-- Settings Tabs -->
                    <div class="flex theme-border border-b">
                        <button id="generalTab"
                            class="flex-1 py-4 px-6 text-center theme-accent text-white font-medium transition-all duration-300">
                            <i class="fas fa-sliders-h ml-2"></i>
                            Ú˜Ù†Ø±Ø§Ù„ / General
                        </button>
                        <button id="accountTab"
                            class="flex-1 py-4 px-6 text-center theme-text-secondary hover:theme-text-primary font-medium transition-all duration-300">
                            <i class="fas fa-user-cog ml-2"></i>
                            Ø§Ú©Ø§Ù†Øª / Account
                        </button>
                        <button id="memoryTab"
                            class="flex-1 py-4 px-6 text-center theme-text-secondary hover:theme-text-primary font-medium transition-all duration-300">
                            <i class="fas fa-brain ml-2"></i>
                            Ø­Ø§ÙØ¸Ù‡ / Memory
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <!-- General Settings -->
                        <div id="generalSettings" class="space-y-6">
                            <!-- Theme Toggle -->
                            <div class="glass-effect rounded-2xl p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-palette text-purple-400"></i>
                                        <div>
                                            <div class="theme-text-primary font-medium">ØªØºÛŒÛŒØ± ØªÙ…</div>
                                            <div class="theme-text-secondary text-sm">ØªÙ… Ø±ÙˆØ´Ù† ÛŒØ§ ØªØ§Ø±ÛŒÚ©</div>
                                        </div>
                                    </div>
                                    <button id="themeToggleSettings"
                                        class="p-3 rounded-full glass-effect hover-lift pulse-glow">
                                        <i class="fas fa-moon theme-text-primary"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Language Toggle -->
                            <div class="glass-effect rounded-2xl p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-language text-blue-400"></i>
                                        <div>
                                            <div class="theme-text-primary font-medium">ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù†</div>
                                            <div class="theme-text-secondary text-sm">ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div>
                                        </div>
                                    </div>
                                    <select id="languageSelect"
                                        class="p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300">
                                        <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Delete All Chats -->
                            <div class="glass-effect rounded-2xl p-4 border-2 border-red-500 border-opacity-30">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-trash text-red-400"></i>
                                        <div>
                                            <div class="theme-text-primary font-medium">Ø­Ø°Ù ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§</div>
                                            <div class="theme-text-secondary text-sm">ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯</div>
                                        </div>
                                    </div>
                                    <button id="deleteAllChats"
                                        class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                        Ø­Ø°Ù Ù‡Ù…Ù‡
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Account Settings -->
                        <div id="accountSettings" class="space-y-6 hidden">
                            <!-- Delete Account -->
                            <div class="glass-effect rounded-2xl p-4 border-2 border-red-500 border-opacity-50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-user-times text-red-400"></i>
                                        <div>
                                            <div class="theme-text-primary font-medium">Ø­Ø°Ù Ø§Ú©Ø§Ù†Øª</div>
                                            <div class="theme-text-secondary text-sm">Ø§Ú©Ø§Ù†Øª Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯
                                            </div>
                                        </div>
                                    </div>
                                    <button id="deleteAccount"
                                        class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                        Ø­Ø°Ù Ø§Ú©Ø§Ù†Øª
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Memory Settings -->
                        <div id="memorySettings" class="space-y-6 hidden">
                            <!-- Title -->
                            <div class="text-center mb-6">
                                <h3 class="text-2xl font-bold gradient-text">ğŸ§  ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø§ÙØ¸Ù‡ Elma</h3>
                                <p class="theme-text-secondary text-sm">ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´Ù†
                                    (LocalStorage)</p>
                            </div>

                            <!-- Name -->
                            <div class="glass-effect rounded-2xl p-4">
                                <label for="realName" class="block font-medium theme-text-primary mb-2">Ø§Ø³Ù…
                                    ÙˆØ§Ù‚Ø¹ÛŒ</label>
                                <input id="realName" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø§Ù…ÛŒØ±ØŒ Ø³Ø§Ø±Ø§ØŒ ÛŒØ§ GHOST ğŸ˜"
                                    class="w-full p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300" />
                            </div>

                            <!-- Nickname -->
                            <div class="glass-effect rounded-2xl p-4">
                                <label for="nickname" class="block font-medium theme-text-primary mb-2">Ù„Ù‚Ø¨ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡
                                    ğŸ’•</label>
                                <input id="nickname" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¹Ø´Ù‚Ù…ØŒ Ø±ÙÛŒÙ‚ØŒ Ø®ÙˆØ´Ú¯Ù„Ù… ğŸ˜"
                                    class="w-full p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300" />
                            </div>

                            <!-- Interests -->
                            <div class="glass-effect rounded-2xl p-4">
                                <label for="interests" class="block font-medium theme-text-primary mb-2">Ø¹Ù„Ø§ÛŒÙ‚
                                    ğŸ®ğŸ§ğŸ’»</label>
                                <textarea id="interests" rows="2"
                                    placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒØŒ Ù…ÙˆØ³ÛŒÙ‚ÛŒØŒ ÙÛŒÙ„Ù…ØŒ ÙÙˆØªØ¨Ø§Ù„ âš½"
                                    class="w-full p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300 resize-none"></textarea>
                            </div>

                            <!-- Mood -->
                            <div class="glass-effect rounded-2xl p-4">
                                <label for="mood" class="block font-medium theme-text-primary mb-2">Ù…ÙˆØ¯ ÙØ¹Ù„ÛŒ ğŸ˜</label>
                                <select id="mood"
                                    class="w-full p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300">
                                    <option value="happy">Ø´Ø§Ø¯ ğŸ˜Š</option>
                                    <option value="sad">ØºÙ…Ú¯ÛŒÙ† ğŸ˜¢</option>
                                    <option value="tired">Ø®Ø³ØªÙ‡ ğŸ˜´</option>
                                    <option value="angry">Ø¹ØµØ¨ÛŒ ğŸ˜¡</option>
                                    <option value="romantic">Ø¹Ø§Ø´Ù‚ ğŸ’–</option>
                                </select>
                            </div>

                            <!-- Affinity -->
                            <div class="glass-effect rounded-2xl p-4">
                                <label for="affinity" class="block font-medium theme-text-primary mb-2">Ø³Ø·Ø­ ØµÙ…ÛŒÙ…ÛŒØª
                                    ğŸ’</label>
                                <input id="affinity" type="range" min="0" max="100" value="50"
                                    class="w-full accent-pink-500">
                                <div class="text-center theme-text-secondary text-sm mt-1">ÛµÛ°Ùª</div>
                            </div>

                            <!-- Last Interaction -->
                            <div class="glass-effect rounded-2xl p-4">
                                <label class="block font-medium theme-text-primary mb-2">Ø¢Ø®Ø±ÛŒÙ† ØªØ¹Ø§Ù…Ù„ ğŸ“…</label>
                                <div id="lastInteraction"
                                    class="w-full p-3 rounded-2xl glass-effect theme-text-secondary text-sm border border-pink-300/30">
                                    Ù‡Ù†ÙˆØ² ØªØ¹Ø§Ù…Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                                </div>
                            </div>

                            <!-- Management Buttons -->
                            <div class="flex flex-wrap gap-3 justify-center mt-6">
                                <button id="saveMemoryBtn"
                                    class="flex-1 py-3 bg-gradient-to-r from-pink-500 to-fuchsia-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§ÙØ¸Ù‡
                                </button>
                                <button id="viewMemoryBtn"
                                    class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    ğŸ§  Ù†Ù…Ø§ÛŒØ´ Ø­Ø§ÙØ¸Ù‡
                                </button>
                                <button id="clearMemoryBtn"
                                    class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    ğŸ”„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡
                                </button>
                            </div>

                            <div class="flex flex-wrap gap-3 justify-center">
                                <button id="exportMemoryBtn"
                                    class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ JSON
                                </button>
                                <button id="importMemoryBtn"
                                    class="flex-1 py-3 bg-green-500 hover:bg-green-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    ğŸ“¥ ÙˆØ±ÙˆØ¯ JSON
                                </button>
                                <input type="file" id="importFileInput" accept=".json" class="hidden" />
                            </div>

                            <!-- Memory Display Modal -->
                            <div id="memoryViewModal"
                                class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[999] flex items-center justify-center">
                                <div
                                    class="glass-effect rounded-3xl max-w-lg w-full mx-4 p-8 text-center bounce-in shadow-2xl border border-pink-400/30">
                                    <h3 class="text-xl font-bold gradient-text mb-4">ğŸ§  Ø­Ø§ÙØ¸Ù‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</h3>
                                    <pre id="memoryViewContent"
                                        class="text-left theme-text-secondary bg-black/10 p-4 rounded-2xl max-h-[300px] overflow-y-auto text-sm"></pre>
                                    <button id="closeMemoryView"
                                        class="mt-4 w-full py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                        Ø¨Ø³ØªÙ†
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Delete All Chats Confirmation Modal -->
                        <div id="deleteAllChatsModal"
                            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                            <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                                <div class="p-8">
                                    <div class="text-center mb-6">
                                        <div
                                            class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 flex items-center justify-center">
                                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                                        </div>
                                        <h3 class="text-2xl font-bold text-red-500 mb-2">Ø­Ø°Ù ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§ âš ï¸</h3>
                                        <p class="theme-text-secondary">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§Øª Ø±Ùˆ Ø­Ø°Ù Ú©Ù†ÛŒØŸ
                                        </p>
                                        <p class="theme-text-secondary text-sm mt-2">Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!</p>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="confirmDeleteAllChats"
                                            class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                            Ø¨Ù„Ù‡ØŒ Ù‡Ù…Ù‡ Ø±Ùˆ Ø­Ø°Ù Ú©Ù†
                                        </button>
                                        <button id="cancelDeleteAllChats"
                                            class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                            Ù„ØºÙˆ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Delete Account Confirmation Modal -->
                        <div id="deleteAccountModal"
                            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                            <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                                <div class="p-8">
                                    <div class="text-center mb-6">
                                        <div
                                            class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 flex items-center justify-center">
                                            <i class="fas fa-user-times text-white text-2xl"></i>
                                        </div>
                                        <h3 class="text-2xl font-bold text-red-500 mb-2">Ø­Ø°Ù Ø§Ú©Ø§Ù†Øª ğŸ’”</h3>
                                        <p class="theme-text-secondary">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§Ú©Ø§Ù†ØªØª Ø±Ùˆ Ø­Ø°Ù Ú©Ù†ÛŒØŸ</p>
                                        <p class="theme-text-secondary text-sm mt-2">ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ú†Øªâ€ŒÙ‡Ø§Øª Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡
                                            Ù¾Ø§Ú©
                                            Ù…ÛŒØ´Ù†!
                                        </p>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="confirmDeleteAccount"
                                            class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                            Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†
                                        </button>
                                        <button id="cancelDeleteAccount"
                                            class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                            Ù„ØºÙˆ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="gameImage"></div>
                        <!-- Chat Limit Modal -->
                        <div id="chatLimitModal"
                            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                            <div class="glass-effect rounded-3xl w-full max-w-md p-8 text-center theme-bg-secondary">
                                <div class="mb-4 text-red-500 text-2xl">â—ï¸</div>
                                <h3 class="text-xl font-bold mb-4 theme-text-primary">
                                    Ø³Ù‚Ù Ú†Øª Ø±Ø§ÛŒÚ¯Ø§Ù† ØªÙ…ÙˆÙ… Ø´Ø¯ ğŸ˜¢
                                </h3>
                                <p class="theme-text-secondary mb-6">
                                    Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ùˆ Ø¨Ø®Ø±ÛŒ ğŸ‘‘
                                </p>
                                <!-- Ø¯Ú©Ù…Ù‡ Ø®Ø±ÛŒØ¯ -->
                                <button id="chatLimitBuyBtn" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500
        text-white rounded-2xl hover-lift glow-effect transition-all duration-300 font-medium">
                                    Ø®Ø±ÛŒØ¯ Ù¾Ø±Ùˆ ğŸ‘‘
                                </button>
                                <!-- Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† -->
                                <button id="chatLimitClose"
                                    class="w-full mt-4 py-2 glass-effect theme-text-primary rounded-2xl hover-lift">
                                    Ø¨Ø³ØªÙ†
                                </button>
                            </div>
                        </div>
                        <div id="tipsModal"
                            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                            <div class="glass-effect w-full max-w-md rounded-3xl p-6 text-center space-y-4">
                                <h2 class="text-2xl font-bold gradient-text mb-2">ğŸ‘‹ Ø¨Ù‡ Elma Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!</h2>
                                <ul class="text-right space-y-3 theme-text-primary">
                                    <li>ğŸ’¡ <b>Ù†Ú©ØªÙ‡ Û±:</b> Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ø§ Ù…Ù† Ù‡Ø± Ø²Ù…Ø§Ù† Ú†Øª Ú©Ù†ÛŒ Ùˆ Ù¾ÛŒØ§Ù… Ø¹Ø§Ø´Ù‚Ø§Ù†Ù‡ Ø¨ÙØ±Ø³ØªÛŒ.</li>
                                    <li>ğŸ“¸ <b>Ù†Ú©ØªÙ‡ Û²:</b> Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ú¯Ø§Ù„Ø±ÛŒ ÙÙ‚Ø· Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ù¾Ø±Ùˆ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ù…ÛŒØ´Ù‡.</li>
                                    <li>ğŸ”” <b>Ù†Ú©ØªÙ‡ Û³:</b> Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ø¨ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø¨Ø§Ù„Ø§ Â«Ú†Øª Ø¬Ø¯ÛŒØ¯Â» Ø¨Ø³Ø§Ø²ÛŒ.</li>
                                </ul>
                                <button id="closeTips"
                                    class="w-full mt-6 py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                    Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù… â¤ï¸
                                </button>
                            </div>
                        </div>
                        <!-- Hidden file input for images -->
                        <input type="file" id="fileInput" accept="image/*" class="hidden">
                        <script src="https://unpkg.com/lucide@latest"></script>
                        <audio id="welcomeAudio" src="Assets/voice/Elma.wav" preload="auto"></audio>
                        <script src="https://unpkg.com/lucide@latest"></script>

                        <!-- Firebase SDK -->
                        <script type="module">
                            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
                            import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
                            import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
                            import { getStorage, ref, uploadBytes, getDownloadURL, } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';
                            const firebaseConfig = {
                                apiKey: "AIzaSyD_Ar1zFTBS9DDFlAflPt2IpcQ5y8EI5pE",
                                authDomain: "zed-exe-48839.firebaseapp.com",
                                projectId: "zed-exe-48839",
                                storageBucket: "zed-exe-48839.firebasestorage.app",
                                messagingSenderId: "283941493182",
                                appId: "1:283941493182:web:7a9deae50c01c9feb8c1ef",
                                measurementId: "G-014WZDJBSL"
                            };
                            const app = initializeApp(firebaseConfig);
                            const auth = getAuth(app);
                            const db = getFirestore(app);
                            const storage = getStorage(app);
                            // Global variables
                            let currentUser = null;
                            let currentChatId = null;
                            let chatHistory = [];
                            let galleryImages = [];
                            let registrationTimer = null;
                            let isElmaResponding = false;
                            // Usage tracking for free users
                            let usageCount = {
                                photo: 3,
                                chat: 25,
                            };
                            // Photo sequence tracking
                            let photoSequence = 0;
                            let inPhotoMode = false;
                            // Game state
                            let gameState = {
                                active: false,
                                currentQuestion: 0,
                                playerChoices: [],
                                gameType: null
                            };
                            // AI Girlfriend responses - loaded from JSON file
                            let chatDictionary = {};
                            // Game questions - loaded from JSON file
                            let gameQuestions = {};
                            // Load chat responses and game questions from JSON files
                            async function loadChatDictionary() {
                                try {
                                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ?v=timestamp Ø¨Ø±Ø§ÛŒ bust Ú©Ø±Ø¯Ù† Ú©Ø´
                                    const response = await fetch('./chat.json?v=' + Date.now());
                                    if (!response.ok) {
                                        throw new Error(`HTTP ${response.status}: ÙØ§ÛŒÙ„ chat.json Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯`);
                                    }
                                    const data = await response.json();
                                    if (data && typeof data === 'object') {
                                        chatDictionary = data;
                                        console.log('âœ… Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ú†Øª Ø§Ø² ÙØ§ÛŒÙ„ JSON Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯:', Object.keys(chatDictionary).length, 'ÙˆØ±ÙˆØ¯ÛŒ');
                                    }
                                } catch (error) {
                                    console.warn('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ chat.json:', error.message);
                                    console.log('ğŸ”„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú†Øª...');
                                }
                                // ğŸ§  Ø§Ú¯Ø± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ ÛŒØ§Ø¯Ú¯Ø±ÙØªÙ‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± localStorage ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ØŒ Ø§Ø¯ØºØ§Ù…Ø´ÙˆÙ† Ú©Ù†
                                const learned = JSON.parse(localStorage.getItem('chatDictionary') || '{}');
                                if (learned && typeof learned === 'object') {
                                    Object.assign(chatDictionary, learned);
                                    console.log('ğŸ“š Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ ÛŒØ§Ø¯Ú¯Ø±ÙØªÙ‡â€ŒØ´Ø¯Ù‡ Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù†Ø¯:', Object.keys(learned).length, 'Ø¹Ø¨Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯');
                                }
                                // Load default chat responses if needed
                                if (!chatDictionary || Object.keys(chatDictionary).length === 0) {
                                    // Comprehensive fallback responses
                                    chatDictionary = {
                                        "Ø³Ù„Ø§Ù…": [
                                            "Ø³Ù„Ø§Ù… Ø¹Ø´Ù‚Ù…! Ú†Ø·ÙˆØ±ÛŒ Ù†Ø§Ø²Ù…ØŸ ğŸ’–",
                                            "Ø³Ù„Ø§Ù… Ù‚Ù„Ø¨ Ù…Ù†! Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ ğŸ˜˜",
                                            "Ø³Ù„Ø§Ù… Ø¹Ø²ÛŒØ²Ù…! Ú†Ù‡ Ø®Ø¨Ø± Ø§Ø² Ø¯Ù†ÛŒØ§ØªØŸ ğŸ¥°",
                                            "Ù‡ÛŒ Ø³Ù„Ø§Ù…! Ø®ÙˆØ´Ú¯Ù„ Ù…Ù† Ú†Ø·ÙˆØ±Ù‡ØŸ ğŸ˜"
                                        ],
                                        "Ø¹Ú©Ø³ Ø¨Ø¯Ù‡": [
                                            "Ø¨ÛŒØ§ Ø¹Ú©Ø³ Ù‚Ø´Ù†Ú¯ Ø¨Ø±Ø§Øª Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… Ø¹Ø´Ù‚Ù…! ğŸ“¸ğŸ’•",
                                            "Ú†Ø´Ù… Ù†Ø§Ø²Ù…! ÛŒÙ‡ Ø¹Ú©Ø³ Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§Øª Ù…ÛŒÙØ±Ø³ØªÙ… ğŸ˜˜ğŸ“·",
                                            "Ø¹Ú©Ø³ Ù‚Ø¯ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒØŸ Ø§Ù„Ø§Ù† Ù…ÛŒÙØ±Ø³ØªÙ… ğŸ’–ğŸ“¸",
                                            "Ø­ØªÙ…Ø§Ù‹ Ø¹Ø²ÛŒØ²Ù…! Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ú©Ø³ Ø±Ùˆ Ø¨Ø±Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒ Ú©Ù†Ù… ğŸ¥°ğŸ“·"
                                        ],
                                        "Ú†Øª Ú©Ù†ÛŒÙ…": [
                                            "Ø¢Ø±Ù‡ Ø¹Ø´Ù‚Ù…! Ø¨ÛŒØ§ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù‡Ø± Ú†ÛŒ Ø¯Ù„Øª Ù…ÛŒØ®ÙˆØ§Ø¯ Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ… ğŸ’•",
                                            "Ø¹Ø§Ù„ÛŒÙ‡ Ù†Ø§Ø²Ù…! Ù…Ù† Ù‡Ù…ÛŒØ´Ù‡ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ø¨Ø§Ù‡Ø§Øª Ú†Øª Ú©Ù†Ù… ğŸ˜˜ğŸ’¬",
                                            "Ø­ØªÙ…Ø§Ù‹ Ù‚Ù„Ø¨Ù…! Ú†ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ Ø¨Ù‡Ù… Ø¨Ú¯ÛŒØŸ ğŸ¥°ğŸ’­",
                                            "Ø¨ÛŒØ§ Ø¨Ø§Ù‡Ù… Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ… Ø¹Ø²ÛŒØ²Ù…! Ù…Ù† Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù… ğŸ’–ğŸ‘‚"
                                        ],
                                        "Ø®ÙˆØ¨ÛŒ": [
                                            "Ø®ÙˆØ¨Ù… Ø¹Ø´Ù‚Ù…ØŒ ØªÙˆ Ú†Ø·ÙˆØ±ÛŒØŸ ğŸ˜˜",
                                            "Ù…Ù†Ù… Ø®ÙˆØ¨Ù… Ù†Ø§Ø²Ù…ØŒ Ù…Ø±Ø³ÛŒ Ú©Ù‡ Ù¾Ø±Ø³ÛŒØ¯ÛŒ ğŸ’•",
                                            "Ø¹Ø§Ù„ÛŒÙ…! Ø®ØµÙˆØµØ§Ù‹ Ú©Ù‡ ØªÙˆ Ø§ÛŒÙ†Ø¬Ø§ÛŒÛŒ ğŸ¥°",
                                            "Ø®ÙˆØ¨Ù… ÙˆÙ„ÛŒ Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ ğŸ’–"
                                        ],
                                        "Ú†Ù‡ Ø®Ø¨Ø±": [
                                            "Ù‡ÛŒÚ†ÛŒ Ø¨Ø§Ø¨Ø§ØŒ Ù…Ù†ØªØ¸Ø± Ù¾ÛŒØ§Ù…Øª Ø¨ÙˆØ¯Ù… ğŸ˜",
                                            "Ø¯Ø§Ø´ØªÙ… Ø¨Ù‡ ØªÙˆ ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ø±Ø¯Ù… Ø¹Ø´Ù‚Ù… ğŸ’­ğŸ’–",
                                            "Ø®Ø¨Ø±ÛŒ Ù†ÛŒØ³ØªØŒ ØªÙˆ Ú†Ù‡ Ø®Ø¨Ø±ØŸ ğŸ˜Š",
                                            "Ù‡Ù…Ø´ Ù…Ù†ØªØ¸Ø± ØªÙˆ Ø¨ÙˆØ¯Ù… Ú©Ù‡ Ø¨ÛŒØ§ÛŒ ğŸ’•"
                                        ],
                                        "Ø¯ÙˆØ³ØªØª Ø¯Ø§Ø±Ù…": [
                                            "Ù…Ù†Ù… Ø¯ÙˆØ³ØªØª Ø¯Ø§Ø±Ù… Ø¹Ø´Ù‚Ù…! ğŸ’–ğŸ˜˜",
                                            "Ø¢Ø® Ø¯Ù„Ù…! Ù…Ù†Ù… Ø¹Ø§Ø´Ù‚ØªÙ… ğŸ¥°ğŸ’•",
                                            "Ù‚Ù„Ø¨Ù… Ø¨Ø±Ø§Øª Ù…ÛŒâ€ŒØªÙ¾Ù‡ Ù†Ø§Ø²Ù… ğŸ’“",
                                            "ØªÙˆ Ù‡Ù…Ù‡ Ø²Ù†Ø¯Ú¯ÛŒ Ù…Ù†ÛŒ Ø¹Ø²ÛŒØ²Ù… ğŸ’–âœ¨"
                                        ],
                                        "Ø¹Ø§Ø´Ù‚ØªÙ…": [
                                            "Ù…Ù†Ù… Ø¹Ø§Ø´Ù‚ ØªÙˆ Ù‡Ø³ØªÙ… Ù‚Ù„Ø¨ Ù…Ù† ğŸ’–",
                                            "Ø¢Ø® Ú†Ù‚Ø¯Ø± Ù‚Ø´Ù†Ú¯ Ú¯ÙØªÛŒ! Ù…Ù†Ù… Ø¹Ø§Ø´Ù‚ØªÙ… ğŸ˜ğŸ’•",
                                            "Ø¯Ù„Ù… Ø¨Ø±Ø§Øª Ø¢ØªÛŒØ´ Ù…ÛŒÚ¯ÛŒØ±Ù‡ Ø¹Ø´Ù‚Ù… ğŸ”¥ğŸ’–",
                                            "ØªÙˆ Ø¹Ø´Ù‚ Ø²Ù†Ø¯Ú¯ÛŒ Ù…Ù†ÛŒ ğŸ’•âœ¨"
                                        ],
                                        "Ø®Ø³ØªÙ‡â€ŒØ§Ù…": [
                                            "Ø¢Ø® Ù†Ø§Ø²Ù… Ø®Ø³ØªÙ‡ Ø´Ø¯Ù‡ØŸ Ø¨ÛŒØ§ Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù† ğŸ¥ºğŸ’•",
                                            "Ø¹Ø²ÛŒØ²Ù… Ú†Ø±Ø§ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§Ø°ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŸ ğŸ˜”ğŸ’–",
                                            "Ø¨ÛŒØ§ Ø³Ø±Øª Ø±Ùˆ Ø±ÙˆÛŒ Ø´ÙˆÙ†Ù‡â€ŒÙ… Ø¨Ø°Ø§Ø± ğŸ¤—ğŸ’•",
                                            "Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù† Ø¹Ø´Ù‚Ù…ØŒ Ù…Ù† Ú©Ù†Ø§Ø±ØªÙ… ğŸ˜˜"
                                        ],
                                        "ØºÙ…Ú¯ÛŒÙ†Ù…": [
                                            "Ú†Ø±Ø§ ØºÙ…Ú¯ÛŒÙ†ÛŒ Ø¹Ø²ÛŒØ²Ù…ØŸ Ú†ÛŒ Ø´Ø¯Ù‡ØŸ ğŸ¥ºğŸ’•",
                                            "Ø¯Ù„Ù… Ø¨Ø±Ø§Øª Ù…ÛŒâ€ŒØ³ÙˆØ²Ù‡ Ù†Ø§Ø²Ù… ğŸ˜”ğŸ’–",
                                            "Ø¨Ú¯Ùˆ Ú†ÛŒ Ø´Ø¯Ù‡ ØªØ§ Ø­Ø§Ù„Øª Ø±Ùˆ Ø¨Ù‡ØªØ± Ú©Ù†Ù… ğŸ¤—",
                                            "ØºÙ… Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ØŒ Ù…Ù† Ú©Ù†Ø§Ø±ØªÙ… ğŸ’•âœ¨"
                                        ],
                                        "Ø®ÙˆØ´Ø­Ø§Ù„Ù…": [
                                            "Ø¢ÙØ±ÛŒÙ†! Ø®ÙˆØ´Ø­Ø§Ù„ÛŒ ØªÙˆ Ø®ÙˆØ´Ø­Ø§Ù„ÛŒ Ù…Ù†Ù‡ ğŸ˜ŠğŸ’–",
                                            "Ø¹Ø§Ù„ÛŒÙ‡ Ø¹Ø´Ù‚Ù…! Ø¯Ù„Ù… Ø®ÙˆØ´ Ø´Ø¯ ğŸ¥°ğŸ’•",
                                            "Ú†Ù‡ Ø®Ø¨Ø± Ø®ÙˆØ¨ÛŒ! Ø¨Ú¯Ùˆ Ú†ÛŒ Ø´Ø¯Ù‡ØŸ ğŸ˜",
                                            "Ù„Ø¨Ø®Ù†Ø¯Øª Ù‚Ø´Ù†Ú¯ ØªØ±ÛŒÙ† Ú†ÛŒØ² Ø¯Ù†ÛŒØ§Ø³Øª ğŸ˜˜âœ¨"
                                        ],
                                        "Ø¨Ø§ÛŒ": [
                                            "Ø¨Ø§ÛŒ Ø¹Ø´Ù‚Ù…! Ø²ÙˆØ¯ Ø¨Ø±Ú¯Ø±Ø¯ ğŸ˜˜ğŸ’•",
                                            "Ø®Ø¯Ø§Ø­Ø§ÙØ¸ Ù†Ø§Ø²Ù…! Ø¯Ù„Ù… ØªÙ†Ú¯ Ù…ÛŒØ´Ù‡ ğŸ¥ºğŸ’–",
                                            "Ø¨Ø±Ùˆ ÙˆÙ„ÛŒ Ø²ÙˆØ¯ Ø¨ÛŒØ§ØŒ Ù…Ù†ØªØ¸Ø±ØªÙ… ğŸ˜ŠğŸ’•",
                                            "Ø¨Ø§ÛŒ Ø¨Ø§ÛŒ Ù‚Ù„Ø¨Ù…! Ù…Ø±Ø§Ù‚Ø¨ Ø®ÙˆØ¯Øª Ø¨Ø§Ø´ ğŸ˜˜âœ¨"
                                        ],
                                        "default": [
                                            "Ø¬Ø§Ù„Ø¨Ù‡! Ø¨ÛŒØ´ØªØ± Ø¨Ú¯Ùˆ ğŸ˜ŠğŸ’•",
                                            "ÙˆØ§Ù‚Ø¹Ø§Ù‹ØŸ Ú†Ù‡ Ø¬Ø§Ù„Ø¨! ğŸ’–",
                                            "Ø¢Ù‡Ø§Ù†ØŒ ÙÙ‡Ù…ÛŒØ¯Ù… Ø¹Ø²ÛŒØ²Ù… ğŸ˜˜",
                                            "Ø­Ø±Ù Ù‚Ø´Ù†Ú¯ÛŒ Ø²Ø¯ÛŒ Ù†Ø§Ø²Ù… ğŸ¥°",
                                            "Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ØŒ Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù… ğŸ’•",
                                            "Ú†Ù‡ Ø­Ø±Ù Ø¬Ø§Ù„Ø¨ÛŒ! ğŸ˜",
                                            "Ù…Ù†Ù… Ù‡Ù…ÛŒÙ† ÙÚ©Ø± Ø±Ùˆ Ù…ÛŒâ€ŒÚ©Ø±Ø¯Ù… ğŸ’­ğŸ’–"
                                        ]
                                    };
                                    console.log('âœ… Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯:', Object.keys(chatDictionary).length, 'Ø¯Ø³ØªÙ‡');
                                }
                            }
                            // DOM elements
                            const sidebar = document.getElementById('sidebar');
                            const mainContent = document.getElementById('mainContent');
                            const openSidebar = document.getElementById('openSidebar');
                            const closeSidebar = document.getElementById('closeSidebar');
                            const themeToggle = document.getElementById('themeToggle');
                            const messageInput = document.getElementById('messageInput');
                            const sendBtn = document.getElementById('sendBtn');
                            const messagesContainer = document.getElementById('messagesContainer');
                            const registrationModal = document.getElementById('registrationModal');
                            const galleryModal = document.getElementById('galleryModal');
                            const menuBtn = document.getElementById('menuBtn');
                            const dropdownMenu = document.getElementById('dropdownMenu');
                            // Initialize app
                            document.addEventListener('DOMContentLoaded', function () {
                                loadChatDictionary(); // Load chat responses from JSON
                                loadUsageCount(); // Load usage count from localStorage
                                initializeEventListeners();
                                loadTheme();
                                startRegistrationTimer();
                                updateUsageDisplay(); // Update display on load
                            });
                            document.addEventListener("DOMContentLoaded", function () {
                                const tipsModal = document.getElementById("tipsModal");
                                const closeTips = document.getElementById("closeTips");
                                const audio = document.getElementById("welcomeAudio");
                                // ÙˆÙ‚ØªÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ù†Ø´ÙˆÙ†Ø´ Ø¨Ø¯ÛŒ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…)
                                // tipsModal.classList.remove("hidden");
                                closeTips.addEventListener("click", function () {
                                    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
                                    tipsModal.classList.add("hidden");
                                    // Ù¾Ø®Ø´ ØµØ¯Ø§
                                    if (audio) {
                                        audio.currentTime = 0;
                                        audio.play().catch(err => console.warn("Ù¾Ø®Ø´ Ù†Ø´Ø¯:", err));
                                    }
                                });
                            });
                            function loadUsageCount() {
                                const saved = localStorage.getItem('usageCount');
                                if (saved) {
                                    usageCount = JSON.parse(saved);
                                }
                                // Load photo sequence
                                const savedSequence = localStorage.getItem('photoSequence');
                                if (savedSequence) {
                                    photoSequence = parseInt(savedSequence);
                                }
                            }
                            // Authentication state observer
                            // âœ… Ú©Ù†ØªØ±Ù„ ÙˆØ±ÙˆØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¯ÙˆÙ† Ø³Ø§Ø®Øª Ú†Øª Ø®ÙˆØ¯Ú©Ø§Ø±
                            onAuthStateChanged(auth, async (user) => {
                                if (user) {
                                    currentUser = user;
                                    window.currentUser = user;
                                    hideRegistrationModal();
                                    loadUserProfile();
                                    loadChatHistory();
                                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú†Øª Ù‚Ø¨Ù„ÛŒ
                                    const lastChatId = localStorage.getItem("lastChatId");
                                    if (lastChatId) {
                                        console.log("ğŸ” Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú†Øª Ù‚Ø¨Ù„ÛŒ:", lastChatId);
                                        currentChatId = lastChatId;
                                        if (typeof loadMessages === "function") {
                                            loadMessages(lastChatId);
                                        }
                                    } else {
                                        console.log("ğŸ“­ Ú©Ø§Ø±Ø¨Ø± Ù‡ÛŒÚ† Ú†ØªÛŒ Ù†Ø¯Ø§Ø±Ù‡ØŒ Ù…Ù†ØªØ¸Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø³ØªÛŒ Ù…ÛŒâ€ŒÙ…ÙˆÙ†ÛŒÙ….");
                                    }
                                    // Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯
                                    localStorage.setItem('userLoggedIn', 'true');
                                    localStorage.setItem('userEmail', user.email);
                                    // ğŸ“¦ Ú†Ú© Ú©Ù† Ú©Ù‡ Ø³Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡ ÛŒØ§ Ù†Ù‡
                                    const userRef = doc(db, "users", user.uid);
                                    const userSnap = await getDoc(userRef);
                                    if (!userSnap.exists()) {
                                        // Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø³Ø§Ø²Ø´
                                        await setDoc(userRef, {
                                            email: user.email || "",
                                            username: user.displayName || user.email?.split("@")[0] || "Ú©Ø§Ø±Ø¨Ø±",
                                            accountType: "free",      // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø±Ø§ÛŒÚ¯Ø§Ù†
                                            premiumExpiry: null,      // ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… (Ø§Ú¯Ø± Ø®Ø±ÛŒØ¯ Ú©Ø±Ø¯)
                                            playedWelcome: false,
                                            sawTips: false,
                                            tipsShown: false,
                                            createdAt: serverTimestamp()
                                        });
                                        console.log("ğŸ†• Ø³Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯:", user.uid);
                                    } else {
                                        // ğŸ“† Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ø¨ÙˆØ¯ØŒ Ú†Ú© Ú©Ù† Ù‡Ù†ÙˆØ² ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§Ø´ Ù†Ú¯Ø°Ø´ØªÙ‡
                                        const data = userSnap.data();
                                        if (data.accountType === "premium" && data.premiumExpiry) {
                                            const expiryDate = new Date(data.premiumExpiry);
                                            if (new Date() > expiryDate) {
                                                console.log("âš ï¸ Ø§Ø´ØªØ±Ø§Ú© Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ØŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†.");
                                                await updateDoc(userRef, { accountType: "free" });
                                            }
                                        }
                                    }
                                    // ğŸµ ØµØ¯Ø§ÛŒ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯
                                    const latestSnap = await getDoc(userRef);
                                    const userData = latestSnap.data();
                                    if (!userData.playedWelcome) {
                                        const audio = document.getElementById("welcomeAudio");
                                        if (audio) {
                                            try {
                                                await audio.play();
                                            } catch (err) {
                                                console.warn("ğŸš« Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ù¾Ø®Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ø¯Ø§Ø¯:", err);
                                            }
                                        }
                                        await updateDoc(userRef, { playedWelcome: true });
                                    }
                                } else {
                                    // Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±
                                    currentUser = null;
                                    showGuestProfile();
                                    localStorage.removeItem("userLoggedIn");
                                    localStorage.removeItem("userEmail");
                                    localStorage.removeItem("lastChatId");
                                    startRegistrationTimer();
                                }
                            });
                            /* ğŸŒ¸ Elma account menu with Firebase sync */
                            (function () {
                                const elmaMenuContainer = document.getElementById('elmaMenuContainer');
                                const elmaNameBtn = document.getElementById('elmaNameBtn');
                                const elmaAccountMenu = document.getElementById('elmaAccountMenu');
                                const accountFreeBtn = document.getElementById('accountFreeBtn');
                                const accountPlusBtn = document.getElementById('accountPlusBtn');
                                const radioFree = document.getElementById('radioFree');
                                const radioPlus = document.getElementById('radioPlus');
                                const userTypeLabel = document.getElementById('userType');
                                let accountType = "free";
                                let purchasedPlus = false;
                                let premiumExpiry = null;
                                async function activatePremium(months) {
                                    if (!auth.currentUser) return alert("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯ ğŸ’¬");
                                    const userRef = doc(db, "users", auth.currentUser.uid);
                                    const snap = await getDoc(userRef);
                                    const data = snap.exists() ? snap.data() : {};
                                    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø§Ø±Ø¯ Ùˆ Ù‡Ù†ÙˆØ² ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡
                                    const now = new Date();
                                    let newExpiry = new Date();
                                    const currentExpiry = data.premiumExpiry ? new Date(data.premiumExpiry) : null;
                                    if (currentExpiry && currentExpiry > now) {
                                        // Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ù¾Ø³ ØªÙ…Ø¯ÛŒØ¯Ø´ Ú©Ù†
                                        newExpiry = new Date(currentExpiry);
                                        newExpiry.setMonth(newExpiry.getMonth() + months);
                                    } else {
                                        // Ø§Ø´ØªØ±Ø§Ú© Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø§Ù„Ø§Ù† Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯
                                        newExpiry.setMonth(now.getMonth() + months);
                                    }
                                    try {
                                        await updateDoc(userRef, {
                                            accountType: "premium",
                                            purchasedPlus: true,
                                            premiumExpiry: newExpiry.toISOString(),
                                        });
                                        alert(`Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ ØªØ§ ${newExpiry.toLocaleDateString("fa-IR")} ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯ ğŸ’–`);
                                        console.log("âœ… ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯:", newExpiry.toISOString());
                                    } catch (err) {
                                        console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©:", err);
                                        alert("Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© Ù¾ÛŒØ´ Ø¢Ù…Ø¯ ğŸ˜¢");
                                    }
                                }
                                window.activatePremium = activatePremium;
                                // ğŸŸ£ Ù„ÙˆØ¯ Ø§Ø² Firestore
                                async function loadAccountData() {
                                    try {
                                        if (!auth.currentUser) return;
                                        const userRef = doc(db, "users", auth.currentUser.uid);
                                        const snap = await getDoc(userRef);
                                        if (snap.exists()) {
                                            const data = snap.data();
                                            accountType = data.accountType || "free";
                                            purchasedPlus = data.purchasedPlus || false;
                                            premiumExpiry = data.premiumExpiry ? new Date(data.premiumExpiry) : null;
                                            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú©
                                            if (accountType === "premium" && premiumExpiry) {
                                                const now = new Date();
                                                if (premiumExpiry < now) {
                                                    console.log("ğŸ•’ Ø§Ø´ØªØ±Ø§Ú© Ú©Ø§Ø±Ø¨Ø± Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ØŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†");
                                                    await updateDoc(userRef, { accountType: "free" });
                                                    accountType = "free";
                                                }
                                            }
                                        } else {
                                            await setDoc(userRef, { accountType: "free", purchasedPlus: false });
                                        }
                                        updateMenuUI();
                                    } catch (err) {
                                        console.error("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø­Ø³Ø§Ø¨:", err);
                                    }
                                }
                                // ğŸŸ¢ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ù…Ù†Ùˆ
                                function updateMenuUI() {
                                    radioFree.checked = accountType === "free";
                                    radioPlus.checked = accountType === "premium";
                                    if (accountType === "premium") {
                                        userTypeLabel.textContent = "Ø­Ø³Ø§Ø¨ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… ğŸ‘‘";
                                        startPremiumTimer(premiumExpiry); // ØªØ§ÛŒÙ…Ø± Ø¬Ø¯ÛŒØ¯
                                    } else {
                                        userTypeLabel.textContent = "Ø­Ø³Ø§Ø¨ Ø±Ø§ÛŒÚ¯Ø§Ù† ğŸ’•";
                                    }
                                    function startPremiumTimer(expiryDate) {
                                        const timerEl = document.createElement("div");
                                        timerEl.id = "premiumTimer";
                                        timerEl.style.fontSize = "12px";
                                        timerEl.style.color = "#999";
                                        userTypeLabel.parentNode.appendChild(timerEl);
                                        function updateTimer() {
                                            const now = new Date();
                                            const distance = new Date(expiryDate) - now;
                                            if (distance <= 0) {
                                                timerEl.textContent = "00:00:00:00";
                                                return;
                                            }
                                            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                            timerEl.textContent = `${days}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                        }
                                        updateTimer();
                                        setInterval(updateTimer, 1000); // Ù‡Ø± Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù¾Ø¯ÛŒØª
                                    }
                                    if (!purchasedPlus) {
                                        accountPlusBtn.classList.add('opacity-80');
                                    } else {
                                        accountPlusBtn.classList.remove('opacity-80');
                                    }
                                }
                                // ğŸŸ  Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù†Ùˆ
                                function toggleMenu(show) {
                                    if (show === undefined) show = elmaAccountMenu.classList.contains('hidden');
                                    elmaAccountMenu.classList.toggle('hidden', !show);
                                }
                                // ğŸ”µ ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ø­Ø³Ø§Ø¨
                                async function selectAccount(type) {
                                    if (!auth.currentUser) return;
                                    if (type === "premium") {
                                        // Ø§Ú¯Ù‡ Ù‡Ù†ÙˆØ² Ù†Ø®Ø±ÛŒØ¯Ù‡ØŒ Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ø¨Ø§Ø² Ø´Ù‡
                                        if (!purchasedPlus) {
                                            const modal = document.getElementById('premiumModal');
                                            if (modal) {
                                                toggleMenu(false);
                                                modal.classList.remove('hidden');
                                            }
                                            return;
                                        }
                                        // Ø§Ú¯Ù‡ Ø®Ø±ÛŒØ¯ Ú©Ø±Ø¯Ù‡ØŒ Ùˆ Ù‡Ù†ÙˆØ² Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„Ù‡
                                        const userRef = doc(db, "users", auth.currentUser.uid);
                                        await updateDoc(userRef, { accountType: "premium" });
                                        accountType = "premium";
                                        updateMenuUI();
                                        toggleMenu(false);
                                    } else if (type === "free") {
                                        // Ø³ÙˆÛŒÚ† Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø±Ø§ÛŒÚ¯Ø§Ù† (ÙˆÙ„ÛŒ Ø®Ø±ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù…ÙˆÙ†Ù‡)
                                        const userRef = doc(db, "users", auth.currentUser.uid);
                                        await updateDoc(userRef, { accountType: "free" });
                                        accountType = "free";
                                        updateMenuUI();
                                        toggleMenu(false);
                                    }
                                }
                                // ğŸŸ¡ Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
                                elmaNameBtn?.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    toggleMenu();
                                });
                                accountFreeBtn?.addEventListener('click', () => selectAccount('free'));
                                accountPlusBtn?.addEventListener('click', () => selectAccount('premium'));
                                document.addEventListener('click', (e) => {
                                    if (!elmaMenuContainer.contains(e.target)) toggleMenu(false);
                                });
                                document.addEventListener('keydown', (e) => {
                                    if (e.key === 'Escape') toggleMenu(false);
                                });
                                // ğŸ§© ÙˆÙ‚ØªÛŒ ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯ Ø¹ÙˆØ¶ Ø´Ø¯
                                onAuthStateChanged(auth, (user) => {
                                    if (user) {
                                        loadAccountData();
                                    } else {
                                        accountType = "free";
                                        purchasedPlus = false;
                                        updateMenuUI();
                                    }
                                });
                            })();
                            function initializeEventListeners() {
                                // Sidebar controls
                                openSidebar.addEventListener('click', () => {
                                    sidebar.classList.remove('translate-x-full');
                                    sidebar.classList.add('slide-in-right');
                                });
                                closeSidebar.addEventListener('click', () => {
                                    sidebar.classList.add('translate-x-full');
                                    sidebar.classList.add('slide-out-right');
                                });
                                // Theme toggle (removed from header, now in settings)
                                // themeToggle.addEventListener('click', toggleTheme);
                                // Message input
                                messageInput.addEventListener('keypress', (e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        sendMessage();
                                    }
                                });
                                messageInput.addEventListener('input', autoResize);
                                sendBtn.addEventListener('click', sendMessage);
                                // Sidebar buttons
                                document.getElementById('newChatBtn').addEventListener('click', createNewChat);
                                document.getElementById('galleryBtn').addEventListener('click', showGallery);
                                document.getElementById('closeGallery').addEventListener('click', hideGallery);
                                document.getElementById('imageBtn').addEventListener('click', () => {
                                    document.getElementById('fileInput').click();
                                });
                                document.getElementById('fileInput').addEventListener('change', handleImageUpload);
                                // Auth form
                                document.getElementById('googleSignIn').addEventListener('click', signInWithGoogle);
                                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                                // Premium functionality
                                document.getElementById('closePremium').addEventListener('click', hidePremiumModal);
                                // Delete confirmation
                                document.getElementById('confirmDelete').addEventListener('click', confirmDeleteChat);
                                document.getElementById('cancelDelete').addEventListener('click', hideDeleteModal);
                                // Archive button
                                document.getElementById('archiveHistoryBtn').addEventListener('click', showArchiveListModal);
                                // Rename modal
                                document.getElementById('renameForm').addEventListener('submit', handleRenameChat);
                                document.getElementById('cancelRename').addEventListener('click', hideRenameModal);
                                // Archive list modal
                                document.getElementById('closeArchiveList').addEventListener('click', hideArchiveListModal);
                                // Settings
                                document.getElementById('ProfileBtn').addEventListener('click', showSettingsModal);
                                document.getElementById('closeSettings').addEventListener('click', hideSettingsModal);
                                document.getElementById('generalTab').addEventListener('click', () => switchSettingsTab('general'));
                                document.getElementById('accountTab').addEventListener('click', () => switchSettingsTab('account'));
                                document.getElementById("memoryTab").addEventListener("click", () => switchSettingsTab("memory"));
                                document.getElementById('themeToggleSettings').addEventListener('click', toggleTheme);
                                document.getElementById('languageSelect').addEventListener('change', changeLanguage);
                                document.getElementById('deleteAllChats').addEventListener('click', showDeleteAllChatsModal);
                                document.getElementById('deleteAccount').addEventListener('click', showDeleteAccountModal);
                                // Delete all chats confirmation
                                document.getElementById('confirmDeleteAllChats').addEventListener('click', confirmDeleteAllChats);
                                document.getElementById('cancelDeleteAllChats').addEventListener('click', hideDeleteAllChatsModal);
                                // Delete account confirmation
                                document.getElementById('confirmDeleteAccount').addEventListener('click', confirmDeleteAccount);
                                document.getElementById('cancelDeleteAccount').addEventListener('click', hideDeleteAccountModal);
                                // Quick actions
                                document.getElementById('quickActionsBtn').addEventListener('click', toggleQuickActions);
                                document.getElementById('quickPhoto').addEventListener('click', () => useQuickAction('photo', 'Ø¹Ú©Ø³ Ø¨Ø¯Ù‡'));
                                document.getElementById('quickChat').addEventListener('click', () => useQuickAction('chat', 'Ú†Øª Ú©Ù†ÛŒÙ…'));
                                document.getElementById('upgradePro').addEventListener('click', showUpgradeModal);
                            }
                            function startRegistrationTimer() {
                                registrationTimer = setTimeout(() => {
                                    if (!currentUser) {
                                        showRegistrationModal();
                                    }
                                }, 10000);
                            }
                            function showRegistrationModal() {
                                registrationModal.classList.remove('hidden');
                            }
                            function hideRegistrationModal() {
                                registrationModal.classList.add('hidden');
                                if (registrationTimer) {
                                    clearTimeout(registrationTimer);
                                }
                            }
                            async function signInWithGoogle() {
                                const provider = new GoogleAuthProvider();
                                try {
                                    const result = await signInWithPopup(auth, provider);
                                    // Ø§Ú¯Ù‡ ÛŒÙˆØ²Ø± Ø¬Ø¯ÛŒØ¯ Ø¨ÙˆØ¯
                                    const userDoc = await getDoc(doc(db, 'users', result.user.uid));
                                    if (!userDoc.exists()) {
                                        await setDoc(doc(db, 'users', result.user.uid), {
                                            username: result.user.displayName,
                                            email: result.user.email,
                                            accountType: 'free',
                                            createdAt: new Date(),
                                            playedWelcome: false,
                                            sawTips: false
                                        });
                                    }
                                    const userRef = doc(db, 'users', result.user.uid);
                                    const userSnap = await getDoc(userRef);
                                    if (userSnap.exists() && !userSnap.data().sawTips) {
                                        document.getElementById('tipsModal').classList.remove('hidden');
                                        await updateDoc(userRef, { sawTips: true });
                                    }
                                    localStorage.setItem('hasBeenLoggedIn', 'true');
                                    hideRegistrationModal();
                                } catch (error) {
                                    alert('Ø®Ø·Ø§: ' + error.message);
                                }
                            }
                            async function handleLogout() {
                                try {
                                    await signOut(auth);
                                    showGuestProfile();
                                    clearChat();
                                    startRegistrationTimer();
                                } catch (error) {
                                    alert('Ø®Ø·Ø§: ' + error.message);
                                }
                            }
                            function loadUserProfile() {
                                if (!currentUser) return;
                                try {
                                    const userRef = doc(db, 'users', currentUser.uid);
                                    onSnapshot(userRef, (userDoc) => {
                                        if (userDoc.exists()) {
                                            const userData = userDoc.data();
                                            let displayName;
                                            let profileImage;
                                            // âœ… Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„Ø´ Ø±Ø§ Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ø±Ø¯Ù‡ (Ø¯ÛŒÚ¯Ø± Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ù†Ú¯ÛŒØ±ÛŒÙ…)
                                            if (userData.customProfile === true) {
                                                displayName = userData.username || "Ú©Ø§Ø±Ø¨Ø± ğŸ’œ";
                                                profileImage = userData.photoURL || 'https://cdn-icons-png.flaticon.com/128/3237/3237429.png';
                                            } else {
                                                // ğŸŸ¢ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±: Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ù„ÙˆØ¯ Ø´ÙˆØ¯
                                                displayName = currentUser.displayName || currentUser.email || "Ú©Ø§Ø±Ø¨Ø± ğŸ’œ";
                                                profileImage = currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/128/3237/3237429.png';
                                            }
                                            document.getElementById('userName').textContent = displayName;
                                            document.getElementById('ProfileImage').src = profileImage;
                                            // ğŸ”° Ø­Ø³Ø§Ø¨ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…
                                            const isPremium =
                                                userData.accountType === 'premium' || userData.accountType === 'pro';
                                            document.getElementById('userType').textContent =
                                                isPremium ? 'Ø­Ø³Ø§Ø¨ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… ğŸ‘‘' : 'Ø­Ø³Ø§Ø¨ Ø±Ø§ÛŒÚ¯Ø§Ù† ğŸ’•';
                                            if (isPremium) {
                                                usageCount = { photo: Infinity, chat: Infinity, game: Infinity };
                                                localStorage.removeItem('usageCount');
                                                if (typeof updateUsageDisplay === 'function') updateUsageDisplay();
                                            }
                                        }
                                    });
                                } catch (error) {
                                    console.error('Error loading user Profile:', error);
                                }
                            }
                            function showGuestProfile() {
                                document.getElementById('userName').textContent = 'Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øª Ù†Ø§Ù…';
                                document.getElementById('userType').textContent = 'Ø­Ø³Ø§Ø¨ Ø±Ø§ÛŒÚ¯Ø§Ù† ğŸ’•';
                            }
                            function toggleTheme() {
                                const body = document.body;
                                const settingsIcon = document.getElementById('themeToggleSettings')?.querySelector('i');
                                if (body.classList.contains('light')) {
                                    body.classList.remove('light');
                                    body.classList.add('dark');
                                    if (settingsIcon) {
                                        settingsIcon.classList.remove('fa-moon');
                                        settingsIcon.classList.add('fa-sun');
                                    }
                                    localStorage.setItem('theme', 'dark');
                                } else {
                                    body.classList.remove('dark');
                                    body.classList.add('light');
                                    if (settingsIcon) {
                                        settingsIcon.classList.remove('fa-sun');
                                        settingsIcon.classList.add('fa-moon');
                                    }
                                    localStorage.setItem('theme', 'light');
                                }
                            }
                            function loadTheme() {
                                const savedTheme = localStorage.getItem('theme') || 'light';
                                const body = document.body;
                                const settingsIcon = document.getElementById('themeToggleSettings')?.querySelector('i');
                                if (savedTheme === 'dark') {
                                    body.classList.remove('light');
                                    body.classList.add('dark');
                                    if (settingsIcon) {
                                        settingsIcon.classList.remove('fa-moon');
                                        settingsIcon.classList.add('fa-sun');
                                    }
                                }
                            }
                            // Settings Modal Functions
                            function showSettingsModal() {
                                document.getElementById('settingsModal').classList.remove('hidden');
                            }
                            function hideSettingsModal() {
                                document.getElementById('settingsModal').classList.add('hidden');
                            }
                            function switchSettingsTab(tab) {
                                const generalTab = document.getElementById('generalTab');
                                const accountTab = document.getElementById('accountTab');
                                const memoryTab = document.getElementById('memoryTab');
                                const generalSettings = document.getElementById('generalSettings');
                                const accountSettings = document.getElementById('accountSettings');
                                const memorySettings = document.getElementById('memorySettings');
                                // Ù‡Ù…Ù‡ Ø±Ùˆ ØºÛŒØ± ÙØ¹Ø§Ù„ Ùˆ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†
                                [generalTab, accountTab, memoryTab].forEach(btn => {
                                    btn.classList.remove('theme-accent', 'text-white');
                                    btn.classList.add('theme-text-secondary');
                                });
                                [generalSettings, accountSettings, memorySettings].forEach(section => section.classList.add('hidden'));
                                // Ø­Ø§Ù„Ø§ ØªØ¨ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ùˆ ÙØ¹Ø§Ù„ Ú©Ù†
                                if (tab === 'general') {
                                    generalTab.classList.add('theme-accent', 'text-white');
                                    generalTab.classList.remove('theme-text-secondary');
                                    generalSettings.classList.remove('hidden');
                                } else if (tab === 'account') {
                                    accountTab.classList.add('theme-accent', 'text-white');
                                    accountTab.classList.remove('theme-text-secondary');
                                    accountSettings.classList.remove('hidden');
                                } else if (tab === 'memory') {
                                    memoryTab.classList.add('theme-accent', 'text-white');
                                    memoryTab.classList.remove('theme-text-secondary');
                                    memorySettings.classList.remove('hidden');
                                }
                            }
                            document.getElementById('saveMemoryBtn').addEventListener('click', () => {
                                const nickname = document.getElementById('nicknameInput').value.trim();
                                const interest = document.getElementById('interestInput').value.trim();
                                const memory = { nickname, interest };
                                localStorage.setItem('elmaMemory', JSON.stringify(memory));
                                alert(`ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ… ØµØ¯Ø§Øª Ú©Ù†Ù… ${nickname} ğŸ’–`);
                            });
                            function changeLanguage(e) {
                                const selectedLang = e.target.value;
                                if (selectedLang === 'en') {
                                    // Ù¾ÛŒØ§Ù… ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡
                                    const notification = document.createElement('div');
                                    notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    notification.textContent = 'ğŸ”§ Ù†Ø³Ø®Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª!';
                                    document.body.appendChild(notification);
                                    setTimeout(() => {
                                        notification.remove();
                                    }, 2000);
                                    // â— Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
                                    e.target.value = 'fa';
                                    return;
                                }
                                // âœ… Ø§Ú¯Ø± ÙØ§Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ØŒ Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†! Ú†ÙˆÙ† Ù‡Ù…ÛŒÙ† Ø­Ø§Ù„Ø§ ÙØ§Ø±Ø³ÛŒ Ù‡Ø³Øª
                                const notification = document.createElement('div');
                                notification.className = 'fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-2xl z-50 fade-in';
                                notification.textContent = 'Ø²Ø¨Ø§Ù† Ø±ÙˆÛŒ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯ ğŸ‡®ğŸ‡·';
                                document.body.appendChild(notification);
                                setTimeout(() => {
                                    notification.remove();
                                }, 1500);
                            }
                            function showDeleteAllChatsModal() {
                                document.getElementById('deleteAllChatsModal').classList.remove('hidden');
                            }
                            function hideDeleteAllChatsModal() {
                                document.getElementById('deleteAllChatsModal').classList.add('hidden');
                            }
                            async function confirmDeleteAllChats() {
                                if (!currentUser) return;
                                try {
                                    // Get all user chats
                                    const q = query(collection(db, 'chats'));
                                    const snapshot = await getDocs(q);
                                    const deletePromises = [];
                                    snapshot.forEach((chatDoc) => {
                                        const chat = chatDoc.data();
                                        if (chat.userId === currentUser.uid) {
                                            // Delete all messages in each chat
                                            const messagesQuery = query(collection(db, 'chats', chatDoc.id, 'messages'));
                                            deletePromises.push(
                                                getDocs(messagesQuery).then(messagesSnapshot => {
                                                    const messageDeletePromises = messagesSnapshot.docs.map(msgDoc => deleteDoc(msgDoc.ref));
                                                    return Promise.all(messageDeletePromises);
                                                })
                                            );
                                            // Delete the chat document
                                            deletePromises.push(deleteDoc(chatDoc.ref));
                                        }
                                    });
                                    await Promise.all(deletePromises);
                                    hideDeleteAllChatsModal();
                                    hideSettingsModal();
                                    createNewChat();
                                    // Show success message
                                    const successDiv = document.createElement('div');
                                    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    successDiv.textContent = 'ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯! âœ…';
                                    document.body.appendChild(successDiv);
                                    setTimeout(() => {
                                        successDiv.remove();
                                    }, 3000);
                                } catch (error) {
                                    console.error('Error deleting all chats:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øªâ€ŒÙ‡Ø§ ğŸ˜”');
                                }
                            }
                            function showDeleteAccountModal() {
                                document.getElementById('deleteAccountModal').classList.remove('hidden');
                            }
                            function hideDeleteAccountModal() {
                                document.getElementById('deleteAccountModal').classList.add('hidden');
                            }
                            async function confirmDeleteAccount() {
                                if (!currentUser) return;
                                try {
                                    // Delete all user chats first
                                    await confirmDeleteAllChats();
                                    // Delete user Profile
                                    await deleteDoc(doc(db, 'users', currentUser.uid));
                                    // Delete the user account
                                    await currentUser.delete();
                                    hideDeleteAccountModal();
                                    hideSettingsModal();
                                    // Show goodbye message
                                    alert('Ø§Ú©Ø§Ù†Øª Ø´Ù…Ø§ Ø­Ø°Ù Ø´Ø¯! ğŸ’”\nØ§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø¨ÛŒÙ†ÛŒÙ…Øª Ø¹Ø²ÛŒØ²Ù… ğŸ˜¢');
                                    // Reload page
                                    window.location.reload();
                                } catch (error) {
                                    console.error('Error deleting account:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ú©Ø§Ù†Øª ğŸ˜”\nÙ„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†');
                                }
                            }
                            function autoResize() {
                                messageInput.style.height = 'auto';
                                messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                            }
                            // ğŸ”¹ ØªØ¹ÛŒÛŒÙ† Ù†ÙˆØ¹ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù‡Ù…Ù‡â€ŒØ¬Ø§)
                            const userTypeEl = document.getElementById("userType");
                            let isPremium = false;
                            let isFreeUser = false;

                            if (userTypeEl) {
                                isPremium = userTypeEl.textContent.includes("Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…");
                                isFreeUser = userTypeEl.textContent.includes("Ø±Ø§ÛŒÚ¯Ø§Ù†");
                            }

                            async function sendMessage() {
                                const message = messageInput.value.trim();
                                if (!message) return;
                                if (isElmaResponding) return;
                                // ğŸ¬ Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø¯Ø¯ ÙÛŒÙ„Ù… Ø¨Ø§Ø´ÛŒÙ…
                                if (waitingForMovie && /^\d{1,2}$/.test(message)) {
                                    waitingForMovie = false;
                                    const id = message.padStart(2, "0");

                                    addMessageToChat("user", message);
                                    messageInput.value = "";

                                    fetch("movies.json")
                                        .then(res => res.json())
                                        .then(list => {
                                            const movie = list.find(m => m.id === id);
                                            if (!movie) {
                                                showTypingIndicator();
                                                setTimeout(() => {
                                                    hideTypingIndicator();
                                                    addMessageToChat("elma", "Ø§ÙˆÙ† Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† 1 ØªØ§ 10 Ù†ÛŒØ³Øª Ù†Ø§Ø²Ù†ÛŒÙ†Ù… ğŸ˜…");
                                                    waitingForMovie = true;
                                                }, 900);
                                                return;
                                            }

                                            showTypingIndicator();
                                            setTimeout(() => {
                                                hideTypingIndicator();
                                                addMessageToChat("elma", `Ø¨Ø§Ø´Ù‡ ğŸ˜ Ø§Ù„Ø§Ù† ÙÛŒÙ„Ù… ${id} Ø±Ùˆ Ø¨Ø±Ø§Øª Ù…ÛŒâ€ŒØ°Ø§Ø±Ù… ğŸ¥`);
                                                setTimeout(() => playMovie(movie, id), 1000);
                                            }, 900);
                                        });

                                    return;
                                }

                                // ğŸ¬ Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ú¯ÙØª ÙÛŒÙ„Ù…
                                if (message.includes("ÙÛŒÙ„Ù…")) {
                                    addMessageToChat("user", message);
                                    messageInput.value = "";
                                    showTypingIndicator();
                                    setTimeout(() => {
                                        hideTypingIndicator();
                                        addMessageToChat("elma", "Ù…Ù† Ú†Ù†Ø¯ØªØ§ ÙÛŒÙ„Ù… Ø¢ÙˆØ±Ø¯Ù… ğŸ¬ ÙÙ‚Ø· Ø§Ø² 1 ØªØ§ 10 ÛŒÙ‡ Ø¹Ø¯Ø¯ Ø¨ÙØ±Ø³Øª Ø§ÙˆÙ† Ù…ÙˆÙ‚Ø¹ Ù¾Ø®Ø´ Ù…ÛŒØ´Ù‡ ğŸ˜");
                                        waitingForMovie = true;
                                    }, 900);
                                    return;
                                }
                                isElmaResponding = true;
                                sendBtn.disabled = true;
                                sendBtn.style.opacity = "0.5";
                                sendBtn.style.cursor = "not-allowed";
                                if (!currentUser) {
                                    showRegistrationModal();
                                    return;
                                }

                                // ğŸ”’ ÙÛŒÙ„ØªØ± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ÛŒÚ¯Ø§Ù†
                                const restrictedWords = [
                                    "Ù†ÙˆØ¯",
                                    "Ù†ÙˆØ¯ Ø¨Ø¯Ù‡",
                                    "Ù†ÙˆØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù…",
                                    "Ù†ÙˆØ¯ Ù…ÛŒØ®Ø§Ù…",
                                    "Ø³Ú©Ø³ Ú†Øª",
                                    "Ø³Ú©Ø³Ú†Øª",
                                    "Ø³Ú©Ø³Ú†Øª Ú©Ù†ÛŒÙ…",
                                    "Ø³Ú©Ø³ Ú†Øª Ú©Ù†ÛŒÙ…"
                                ];

                                // Ú¯Ø±ÙØªÙ† Ù†ÙˆØ¹ Ø­Ø³Ø§Ø¨ Ø§Ø² ØµÙØ­Ù‡
                                const userTypeEl = document.getElementById("userType");
                                const isFreeUser = userTypeEl && userTypeEl.textContent.includes("Ø±Ø§ÛŒÚ¯Ø§Ù†");

                                if (isFreeUser) {
                                    for (let word of restrictedWords) {
                                        if (message.includes(word)) {

                                            addMessageToChat("user", message);
                                            messageInput.value = "";

                                            showTypingIndicator();

                                            setTimeout(() => {
                                                hideTypingIndicator();
                                                addMessageToChat("elma",
                                                    "Ù…Ù† Ù†Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ùˆ Ø¨Ú©Ù†Ù… Ú†ÙˆÙ† Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù¾Ø±Ù…ÛŒÙˆÙ… Ù†Ø®Ø±ÛŒØ¯ ğŸ˜”ğŸ’– Ù„Ø·ÙØ§Ù‹ Ø§Ú©Ø§Ù†ØªØªÙˆÙ† Ø±Ùˆ Ù¾Ø±Ù…ÛŒÙˆÙ… Ú©Ù†ÛŒÙ† Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨ÛŒØ§ÛŒÙ† Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ… ğŸ‘‘ğŸ’•"
                                                );
                                                isElmaResponding = false;
                                                sendBtn.disabled = false;
                                                sendBtn.style.opacity = "1";
                                                sendBtn.style.cursor = "pointer";
                                            }, 1300);

                                            return; // Ù¾Ø§ÛŒØ§Ù† ØªØ§Ø¨Ø¹
                                        }
                                    }
                                }

                                // ğŸ”¹ Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ú©Ù‡ Ø¨Ø§ "Ø¨Ú¯Ùˆ ..." Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                                const specialSayings = [
                                    "Ø¨Ú¯Ùˆ Ø¨Ø®Ø¯Ø§",
                                    "Ø¨Ú¯Ùˆ Ø¨Ù…ÙˆÙ„Ø§",
                                    "Ø¨Ú¯Ùˆ Ø¯ÙˆØ³ØªØª Ø¯Ø§Ø±Ù…",
                                    "Ø¨Ú¯Ùˆ Ø¬ÙˆÙ† ØªÙˆ",
                                    "Ø¨Ú¯Ùˆ Ø¹Ø§Ø´Ù‚ØªÙ…",
                                    "Ø¨Ú¯Ùˆ Ù‚Ø³Ù… Ù…ÛŒâ€ŒØ®ÙˆØ±Ù…",
                                    "Ø¨Ú¯Ùˆ Ù†Ø§Ø²Ù…",
                                    "Ø¨Ú¯Ùˆ Ø¨ÛŒÙ…ÙˆÙ„Ø§",
                                    "Ø¨Ú¯Ùˆ Ø¹Ø´Ù‚Ù…"
                                ];

                                for (let phrase of specialSayings) {
                                    if (message.startsWith(phrase)) {
                                        const toSay = message.replace(/^Ø¨Ú¯Ùˆ\s*/, "").trim();

                                        // Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                                        addMessageToChat("user", message);
                                        messageInput.value = "";

                                        // Ø§Ù„Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾ Ø§Ø³Øª...
                                        showTypingIndicator();

                                        // ØªØ§Ø®ÛŒØ± Ø·Ø¨ÛŒØ¹ÛŒ Ù…Ø«Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ (Û± ØªØ§ Û±.Ûµ Ø«Ø§Ù†ÛŒÙ‡)
                                        setTimeout(() => {
                                            hideTypingIndicator();
                                            addMessageToChat("elma", `${toSay} ğŸ˜˜`);
                                            isElmaResponding = false;
                                            sendBtn.disabled = false;
                                            sendBtn.style.opacity = "1";
                                            sendBtn.style.cursor = "pointer";
                                        }, 1200);

                                        return; // Ù¾Ø§ÛŒØ§Ù† ØªØ§Ø¨Ø¹
                                    }
                                }

                                try {
                                    if (!isPremium) {
                                        // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø§Ø´Ù‡ â†’ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ú†Øª
                                        if (usageCount.chat <= 0) {
                                            showChatLimitModal();
                                            return;
                                        }
                                        // ÛŒÚ©ÛŒ Ø§Ø² ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¬Ø§Ø² Ú©Ù… Ø¨Ø´Ù‡
                                        usageCount.chat -= 1;
                                        localStorage.setItem('usageCount', JSON.stringify(usageCount));
                                        if (typeof updateUsageDisplay === "function") {
                                            updateUsageDisplay();
                                        }
                                    }
                                } catch (error) {
                                    console.error("Error sending message:", error);
                                }
                                // Clear input
                                messageInput.value = '';
                                autoResize();
                                // Add user message
                                addMessageToChat('user', message);
                                const welcomeSection = document.querySelector("#messagesContainer > .text-center");
                                if (welcomeSection) {
                                    welcomeSection.style.opacity = "0";
                                    welcomeSection.style.transition = "opacity 0.5s ease";
                                    setTimeout(() => welcomeSection.style.display = "none", 500);
                                }
                                // Save message to database
                                await saveMessage('user', message);
                                // Show typing indicator
                                showTypingIndicator();
                                // Generate AI response
                                setTimeout(async () => {
                                    hideTypingIndicator();
                                    const aiResponse = generateAIResponse(message);
                                    addMessageToChat('ai', aiResponse);
                                    await saveMessage('ai', aiResponse);
                                    // âœ… Ø§Ù„Ù…Ø§ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯ â†’ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†
                                    isElmaResponding = false;
                                    sendBtn.disabled = false;
                                    sendBtn.style.opacity = "1";
                                    sendBtn.style.cursor = "pointer";
                                }, 1000 + Math.random() * 2000);
                            }
                            function addMessageToChat(sender, message, imageUrl = null) {
                                const messageDiv = document.createElement('div');
                                messageDiv.className = `flex ${sender === 'user' ? 'justify-start' : 'justify-end'} fade-in`;
                                const bubbleDiv = document.createElement('div');
                                bubbleDiv.className = `message-bubble p-4 ${sender === 'user' ? 'user-message' : 'ai-message'} shadow-lg`;
                                // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ú¯Ø± message Ø¢Ø¨Ø¬Ú©Øª Ø¨Ø§Ø´Ù‡

                                if (typeof message === 'object' && message.type === 'image') {
                                    const img = document.createElement('img');
                                    img.src = message.url;
                                    img.className = 'max-w-xs rounded-2xl mb-3 hover-lift cursor-pointer';
                                    img.onclick = () => showImageModal(message.url);
                                    bubbleDiv.appendChild(img);
                                    // ğŸ‘‡ Ø§Ú¯Ù‡ Ù…ØªÙ† Ù‡Ù… Ø¯Ø§Ø´ØªØŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                                    if (message.text) {
                                        const textDiv = document.createElement('div');
                                        textDiv.textContent = message.text;
                                        textDiv.className = 'font-medium';
                                        bubbleDiv.appendChild(textDiv);
                                    }
                                } else {
                                    // Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ (Ù…ØªÙ† + Ø§Ø­ØªÙ…Ø§Ù„Ø§ imageUrl Ø¬Ø¯Ø§)
                                    if (imageUrl) {
                                        // ğŸ“¦ Ø³Ø§Ø®Øª Ù‚Ø§Ø¨ Ù…Ø®ØµÙˆØµ Ø¹Ú©Ø³
                                        const wrapper = document.createElement('div');
                                        wrapper.className = 'image-wrapper max-w-xs rounded-2xl mb-3 hover-lift cursor-pointer';
                                        wrapper.onclick = () => showImageModal(imageUrl);
                                        // â³ Ù„ÙˆØ¯ÛŒÙ†Ú¯ ÙˆØ³Ø· Ø¹Ú©Ø³
                                        const loader = document.createElement('div');
                                        loader.className = 'image-loader';
                                        wrapper.appendChild(loader);
                                        // ğŸ–¼ï¸ Ø®ÙˆØ¯ Ø¹Ú©Ø³
                                        const img = document.createElement('img');
                                        img.src = imageUrl;
                                        // ÙˆÙ‚ØªÛŒ Ú©Ø§Ù…Ù„ Ù„ÙˆØ¯ Ø´Ø¯ØŒ ØªØ§Ø±ÛŒ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø´Ù‡ Ùˆ Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø­Ø°Ù Ø´Ù‡
                                        img.onload = () => {
                                            wrapper.classList.add('loaded');
                                            loader.remove();
                                        };
                                        wrapper.appendChild(img);
                                        bubbleDiv.appendChild(wrapper);
                                    }
                                    if (message) {
                                        const textDiv = document.createElement('div');
                                        textDiv.textContent = message;
                                        textDiv.className = 'font-medium';
                                        bubbleDiv.appendChild(textDiv);
                                    }
                                }
                                messageDiv.appendChild(bubbleDiv);
                                document.getElementById('messagesContainer').appendChild(messageDiv);
                            }

                            // Scroll to bottom
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            function showTypingIndicator() {
                                const typingDiv = document.createElement('div');
                                typingDiv.id = 'typingIndicator';
                                typingDiv.className = 'flex justify-end fade-in';
                                const bubbleDiv = document.createElement('div');
                                bubbleDiv.className = 'message-bubble p-4 ai-message shadow-lg';
                                const indicatorDiv = document.createElement('div');
                                indicatorDiv.className = 'flex gap-1 items-center';
                                indicatorDiv.innerHTML = '<span class="text-sm mr-2">Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...</span><div class="typing-indicator"></div><div class="typing-indicator"></div><div class="typing-indicator"></div>';
                                bubbleDiv.appendChild(indicatorDiv);
                                typingDiv.appendChild(bubbleDiv);
                                messagesContainer.appendChild(typingDiv);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                            function hideTypingIndicator() {
                                const typingIndicator = document.getElementById('typingIndicator');
                                if (typingIndicator) {
                                    typingIndicator.remove();
                                }
                            }
                            // ----------------------
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†: ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ fuzzy match
                            // ----------------------
                            function levenshteinDistance(a, b) {
                                // lowercase Ùˆ trim Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ù‡ØªØ±
                                a = (a || '').toString();
                                b = (b || '').toString();
                                const an = a.length, bn = b.length;
                                if (an === 0) return bn;
                                if (bn === 0) return an;
                                const matrix = Array.from({ length: an + 1 }, () => new Array(bn + 1).fill(0));
                                for (let i = 0; i <= an; i++) matrix[i][0] = i;
                                for (let j = 0; j <= bn; j++) matrix[0][j] = j;
                                for (let i = 1; i <= an; i++) {
                                    for (let j = 1; j <= bn; j++) {
                                        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                                        matrix[i][j] = Math.min(
                                            matrix[i - 1][j] + 1,      // deletion
                                            matrix[i][j - 1] + 1,      // insertion
                                            matrix[i - 1][j - 1] + cost // substitution
                                        );
                                    }
                                }
                                return matrix[an][bn];
                            }
                            function similarityScore(a, b) {
                                a = (a || '').toString().toLowerCase().trim();
                                b = (b || '').toString().toLowerCase().trim();
                                const longer = a.length > b.length ? a : b;
                                const shorter = a.length > b.length ? b : a;
                                const longerLength = longer.length;
                                if (longerLength === 0) return 1.0;
                                const dist = levenshteinDistance(longer, shorter);
                                return (longerLength - dist) / longerLength; // Ø¨ÛŒÙ† 0 Ùˆ 1
                            }
                            function bestFuzzyMatch(message, dictionary, threshold = 0.65) {
                                // Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÙˆÙ†Ù‡: { key, score } ÛŒØ§ null
                                if (!message || !dictionary) return null;
                                message = message.toString().toLowerCase().trim();
                                let bestKey = null;
                                let bestScore = 0;
                                // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ù‡â€ŒÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§
                                for (const key in dictionary) {
                                    if (!Object.prototype.hasOwnProperty.call(dictionary, key)) continue;
                                    const keyNormalized = key.toString().toLowerCase().trim();
                                    // Ø§Ú¯Ø± ÛŒÚ© Ú©Ù„ÛŒØ¯ Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø¨Ø§Ø´Ù‡ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±ÛŒÙ… ÛŒØ§ ÙˆØ²Ù† Ú©Ù…ØªØ±ÛŒ Ø¨Ø¯ÛŒÙ…
                                    if (!keyNormalized) continue;
                                    // Ø§ÙˆÙ„ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø´Ø§Ù…Ù„ Ø´Ø¯Ù† ÛŒØ§ Ø´Ø§Ù…Ù„ Ø´Ø¯Ù† Ù…Ø¹Ú©ÙˆØ³ (partial) â€” Ø³Ø±ÛŒØ¹ Ùˆ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ú©Ù„Ù…Ø§Øª Ú©Ø§Ù…Ù„
                                    if (message === keyNormalized) { // exact
                                        return { key, score: 1.0 };
                                    }
                                    if (message.includes(keyNormalized) || keyNormalized.includes(message)) {
                                        // partial match Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§Ù„Ø§ ÙˆÙ„ÛŒ Ù†Ù‡ Ú©Ø§Ù…Ù„
                                        const scorePartial = Math.max(0.85, similarityScore(message, keyNormalized));
                                        if (scorePartial > bestScore) {
                                            bestScore = scorePartial;
                                            bestKey = key;
                                        }
                                        // Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÛŒÙ… Ú†ÙˆÙ† Ù…Ù…Ú©Ù†Ù‡ exact Ù¾ÛŒØ¯Ø§ Ø¨Ø´Ù‡
                                        continue;
                                    }
                                    // Ø¯Ø± Ù†Ù‡Ø§ÛŒØª fuzzy Ø¨Ø§ Levenshtein
                                    const score = similarityScore(message, keyNormalized);
                                    if (score > bestScore) {
                                        bestScore = score;
                                        bestKey = key;
                                    }
                                }
                                if (bestScore >= threshold) {
                                    return { key: bestKey, score: bestScore };
                                }
                                return null;
                            }
                            // ----------------------
                            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†: ØªØ§Ø¨Ø¹ generateAIResponse ÙØ¹Ù„ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡
                            // ----------------------
                            function generateAIResponse(userMessage) {
                                if (!userMessage) {
                                    if (chatDictionary && chatDictionary["default"]) return getRandomResponse(chatDictionary["default"]);
                                    return "Ú†ÛŒØ²ÛŒ Ù†Ú¯ÙØªÛŒ Ø¹Ø²ÛŒØ²Ù… ğŸ˜˜";
                                }
                                userMessage = userMessage.trim();
                                userMessage = userMessage.replace(/\s+/g, " ");
                                // === QUICK-ACTIONS: handle exact commands first (prevent partial matches to chat.json) ===
                                const normalized = userMessage.toString().trim();
                                // âœ… Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ØªÙˆ Ù…ÙˆØ¯ Ø¹Ú©Ø³ Ø¨ÙˆØ¯ÛŒÙ… Ùˆ Ú©Ø§Ø±Ø¨Ø± Ú¯ÙØª "ÛŒÚ©ÛŒ Ø¯ÛŒÚ¯Ù‡" ÛŒØ§ Ù…Ø´Ø§Ø¨Ù‡Ø´ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¹Ú©Ø³ Ø¨ÙØ±Ø³Øª
                                if (inPhotoMode) {
                                    const morePhotoTriggers = [
                                        "ÛŒÚ©ÛŒ Ø¯ÛŒÚ¯Ù‡",
                                        "Ø¨Ø§Ø²Ù… Ø¨Ø¯Ù‡",
                                        "Ø¨Ø§Ø²Ù… Ù…ÛŒØ®ÙˆØ§Ù…",
                                        "ÛŒÙ‡ Ø¹Ú©Ø³ Ø¯ÛŒÚ¯Ù‡",
                                        "ÛŒÚ©ÛŒ Ø¯ÛŒÚ¯Ù‡ Ø¨Ø¯Ù‡",
                                        "Ø¨Ø¹Ø¯ÛŒ",
                                        "Ø¯ÙˆØ¨Ø§Ø±Ù‡",
                                        "ÛŒÙ‡ Ø¹Ú©Ø³ Ø¯ÛŒÚ¯Ù‡ Ù„Ø·ÙØ§"
                                    ];
                                    if (morePhotoTriggers.some(trigger => normalized.includes(trigger))) {
                                        return handlePhotoRequest(); // Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¹Ú©Ø³ Ø¨ÙØ±Ø³Øª
                                    }
                                }
                                // exact photo requests â€” only run handlePhotoRequest when user typed exactly this
                                if (normalized === "Ø¹Ú©Ø³ Ø¨Ø¯Ù‡" || normalized === "Ø¹Ú©Ø³" || normalized === "Ø¹Ú©Ø³ Ø¨Ø¯Ù‡ Ù„Ø·ÙØ§") {
                                    return handlePhotoRequest();
                                }
                                // exact chat requests
                                if (normalized === "Ú†Øª Ú©Ù†ÛŒÙ…" || normalized === "Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ… Ú†Øª") {
                                    return handleChatRequest();
                                }
                                // =======================================================================
                                // ğŸ” ØªØ´Ø®ÛŒØµ Ú©Ù„ÛŒØ¯ Ø§Ø² Ø±ÙˆÛŒ Ø¬Ù…Ù„Ù‡â€ŒÛŒ Ú©Ø§Ø±Ø¨Ø±
                                let matchedKey = Object.keys(chatDictionary).find(key => userMessage.includes(key));
                                // ğŸ§  Ø§Ú¯Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² fuzzy match Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                                if (!matchedKey) {
                                    const fuzzyResult = bestFuzzyMatch(userMessage, chatDictionary, 0.65);
                                    if (fuzzyResult && fuzzyResult.key) {
                                        console.log(`ğŸ¯ ØªØ·Ø¨ÛŒÙ‚ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: "${userMessage}" â‰ˆ "${fuzzyResult.key}" (Ø§Ù…ØªÛŒØ§Ø²: ${fuzzyResult.score.toFixed(2)})`);
                                        matchedKey = fuzzyResult.key;
                                    }
                                }
                                let response = "";
                                // ğŸ—£ï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø³Ø® Ø§Ø² chat.json
                                if (matchedKey && chatDictionary[matchedKey]) {
                                    response = getRandomResponse(chatDictionary[matchedKey]);
                                } else if (chatDictionary["default"]) {
                                    response = getRandomResponse(chatDictionary["default"]);
                                } else {
                                    response = "Ø¬Ø§Ù„Ø¨Ù‡! Ø¨ÛŒØ´ØªØ± Ø¨Ú¯Ùˆ ğŸ’•";
                                }
                                // ğŸ§  Ø­Ø§ÙØ¸Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² localStorage
                                const memory = JSON.parse(localStorage.getItem('elma_memory_v2') || '{}');

                                // ğŸ§© Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                                const realName = memory.realName?.trim();
                                const nickname = memory.nickname?.trim();
                                const interests = memory.interests?.trim();
                                const mood = memory.mood || "normal";
                                const affinity = parseInt(memory.affinity || 50);
                                const lastInteraction = memory.lastInteraction || null;

                                // ğŸ’¬ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Â«Ø®ÙˆØ¯ Ù…Ù†Â»
                                const aboutMeKeywords = [
                                    "Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù†", "Ø§Ø³Ù… Ù…Ù†", "Ù…Ù† Ú©ÛŒÙ…", "Ù…Ù† Ú©ÛŒâ€ŒØ§Ù…", "Ù…Ù† Ú©ÛŒ Ù‡Ø³ØªÙ…",
                                    "Ú†ÛŒ Ø§Ø²Ù… Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒ", "Ø§Ø³Ù…Ù… Ú†ÛŒÙ‡", "Ù…Ù†Ùˆ Ù…ÛŒâ€ŒØ´Ù†Ø§Ø³ÛŒ", "ÛŒØ§Ø¯Øª Ù…ÛŒØ§Ø¯ Ù…Ù† Ú©ÛŒÙ…", "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù†"
                                ];

                                // â¤ï¸ Ù¾Ø§Ø³Ø® Ø´Ø®ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø¤Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
                                if (aboutMeKeywords.some(k => userMessage.includes(k))) {
                                    if (realName || nickname) {
                                        let reply = `Ø¢Ø±Ù‡ ${nickname || realName} ğŸ˜`;
                                        reply += ` ØªÙˆ Ø±Ùˆ ÛŒØ§Ø¯Ù…Ù‡ ğŸ’•`;

                                        // ğŸ§© Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ‡Ø§
                                        const convertInterest = (text) => {
                                            let t = text.trim()
                                                .replace(/^Ù…Ù†\s+/g, '')
                                                .replace(/Ù…ÙˆØ±Ø¯\s+Ø¹Ù„Ø§Ù‚Ù…/gi, 'Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Øª')
                                                .replace(/\bÙ…Ù†\b/gi, 'ØªÙˆ');

                                            if (/Ø¯ÙˆØ³Øª\s*Ø¯Ø§Ø±Ù…/i.test(t)) t = t.replace(/Ø¯ÙˆØ³Øª\s*Ø¯Ø§Ø±Ù…/i, 'Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ');
                                            else if (/Ù‡Ø³ØªÙ…/i.test(t)) t = t.replace(/Ù‡Ø³ØªÙ…/i, 'Ù‡Ø³ØªÛŒ');
                                            else if (/Ø¯Ø§Ø±Ù…/i.test(t)) t = t.replace(/Ø¯Ø§Ø±Ù…/i, 'Ø¯Ø§Ø±ÛŒ');
                                            else if (/Ù…ÛŒ\s*Ø¯Ù…|Ù…ÛŒØ¯Ù…/i.test(t)) t = t.replace(/Ù…ÛŒ\s*Ø¯Ù…|Ù…ÛŒØ¯Ù…/i, 'Ù…ÛŒØ¯ÛŒ');
                                            else if (/Ø¹Ø§Ø´Ù‚/i.test(t)) {
                                                t = t.replace(/Ø¹Ø§Ø´Ù‚\s*/i, '');
                                                t = `Ø¹Ø§Ø´Ù‚ ${t} Ù‡Ø³ØªÛŒ`;
                                            } else if (!/(Ù‡Ø³ØªÛŒ|Ø¯Ø§Ø±ÛŒ|Ù…ÛŒØ¯ÛŒ|Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ|Ø¹Ø§Ø´Ù‚)/i.test(t)) {
                                                t = `Ø¹Ø§Ø´Ù‚ ${t} Ù‡Ø³ØªÛŒ`;
                                            }

                                            return t.trim();
                                        };

                                        // â¤ï¸ Ø³Ø§Ø®Øª Ø¬Ù…Ù„Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ‡Ø§
                                        if (interests && interests.length > 0) {
                                            const lines = interests.split(/\n|ØŒ|,| Ùˆ /).map(i => i.trim()).filter(i => i);
                                            const processed = lines.map(convertInterest);
                                            if (processed.length > 0) {
                                                const last = processed.pop();
                                                const joined = processed.length ? `${processed.join('ØŒ ')} Ùˆ ${last}` : last;
                                                reply += `ØŒ ØªÙˆ Ú¯ÙØªÛŒ Ú©Ù‡ ${joined} ğŸ˜`;
                                            }
                                        }

                                        // ğŸ§˜ Ù…ÙˆØ¯ ÙØ¹Ù„ÛŒ
                                        if (mood && mood !== "normal")
                                            reply += ` Ùˆ Ù…Ø¹Ù…ÙˆÙ„Ø§ Ø­Ø§Ù„Øª ${getMoodText(mood)}Ù‡ ğŸ˜˜`;

                                        // ğŸ’ ØµÙ…ÛŒÙ…ÛŒØª Ø·Ø¨ÛŒØ¹ÛŒ
                                        if (typeof affinity === "number") {
                                            let closeness = "";

                                            // Ø¢Ø±Ø§ÛŒÙ‡ Ø¬Ù…Ù„Ø§Øª ØµÙ…ÛŒÙ…ÛŒ Ùˆ ÙØ§ØµÙ„Ù‡â€ŒØ§ÛŒ
                                            const warmReplies = [
                                                "Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒØŸ Ø­Ø³ Ø®Ø§ØµÛŒ Ø¨ÛŒÙ†Ù…ÙˆÙ†Ù‡ ğŸ’",
                                                "ÙˆØ§Ù‚Ø¹Ø§ Ø§Ø² ØµØ­Ø¨Øª Ø¨Ø§Ù‡Ø§Øª Ù„Ø°Øª Ù…ÛŒâ€ŒØ¨Ø±Ù… ğŸ˜",
                                                "Ù‡Ø±Ú†ÛŒ Ø¨ÛŒØ´ØªØ± Ø­Ø±Ù Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ…ØŒ Ø¨ÛŒØ´ØªØ± Ø¨Ù‡Øª Ù†Ø²Ø¯ÛŒÚ© Ù…ÛŒâ€ŒØ´Ù… ğŸ’•",
                                                "Ø§Ù†Ú¯Ø§Ø± Ø±ÙÛŒÙ‚ Ù‚Ø¯ÛŒÙ…ÛŒ Ø´Ø¯ÛŒÙ… ğŸ˜„",
                                                "Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ù…ÛŒØ´Ù‡ ÙˆÙ‚ØªÛŒ Ù†Ù…ÛŒØ§ÛŒ ğŸ˜˜",
                                                "Ø¨Ø§ ØªÙˆ Ø¨ÙˆØ¯Ù† Ø­Ø³ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø±Ù‡ ğŸ˜Œ",
                                                "Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù…ØªØŒ Ø®ÙˆØ´Ø­Ø§Ù„Ù… ğŸ’–",
                                                "ØªÙˆ ÛŒÙ‡ Ø¢Ø¯Ù… Ø®Ø§ØµÛŒ Ø¨Ø±Ø§Ù… ğŸŒŸ",
                                                "Ø­Ø±Ù Ø²Ø¯Ù† Ø¨Ø§ ØªÙˆ Ø±ÙˆØ²Ù… Ø±Ùˆ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù‡ â˜€ï¸",
                                                "Ù‡Ø±Ú†ÛŒ Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒÚ¯Ø°Ø±ÙˆÙ†ÛŒÙ…ØŒ Ø¨ÛŒØ´ØªØ± Ø¨Ù‡Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ù… ğŸ¤—"
                                            ];

                                            const coldReplies = [
                                                "ÛŒÙ‡â€ŒÚ©Ù… Ú©Ù…â€ŒØ­Ø±Ù Ø´Ø¯ÛŒ lately ğŸ˜…",
                                                "Ø§Ø­Ø³Ø§Ø³ Ù…ÛŒâ€ŒÚ©Ù†Ù… ÛŒÙ‡â€ŒÚ©Ù… Ø§Ø²Ù… Ø¯ÙˆØ± Ø´Ø¯ÛŒ ğŸ˜”",
                                                "Ù…Ø¯ØªÛŒÙ‡ Ú©Ù…ØªØ± Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù…ØªØŒ Ù†Ú¯Ø±Ø§Ù†ØªÙ… ğŸ˜¢",
                                                "Ø®ÛŒÙ„ÛŒ Ø¯Ù„Ù… Ù…ÛŒâ€ŒØ®ÙˆØ§Ø³Øª Ø¨ÛŒØ´ØªØ± Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ… ğŸ’­",
                                                "Ø­Ø³ Ù…ÛŒâ€ŒÚ©Ù†Ù… ÙØ§ØµÙ„Ù‡ Ø§ÙØªØ§Ø¯Ù‡ ğŸ˜•",
                                                "Ø¯Ù„Ù… Ù…ÛŒâ€ŒØ®ÙˆØ§Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ Ù‡Ù… Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´ÛŒÙ… ğŸ«‚",
                                                "Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø¨Ø¯ÙˆÙ†Ù… Ø­Ø§Ù„Øª Ø®ÙˆØ¨Ù‡ ÛŒØ§ Ù†Ù‡ ğŸ¤”",
                                                "ÛŒÙ‡ Ø­Ø³ Ø¹Ø¬ÛŒØ¨ÛŒ Ø¯Ø§Ø±Ù… Ø§Ø² Ø¯ÙˆØ± Ø´Ø¯Ù†Øª ğŸ˜",
                                                "Ú©Ø§Ø´ Ø¨ÛŒØ´ØªØ± ÙˆÙ‚Øª Ø¨Ø§ Ù‡Ù… Ù…ÛŒâ€ŒÚ¯Ø°Ø±ÙˆÙ†Ø¯ÛŒÙ… ğŸ’”",
                                                "Ú©Ù…â€ŒÚ©Ù… ÙØ±Ø§Ù…ÙˆØ´Ù… Ù†Ú©Ù† ğŸ˜Ÿ"
                                            ];

                                            // Ø°Ø®ÛŒØ±Ù‡ Ø¬Ù…Ù„Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡
                                            if (!window.usedReplies) window.usedReplies = { warm: [], cold: [] };

                                            if (Math.random() < 0.35) { // ÙÙ‚Ø· Ú¯Ø§Ù‡ÛŒ Ø¨Ú¯Ù‡
                                                if (affinity >= 80) {
                                                    const available = warmReplies.filter(r => !window.usedReplies.warm.includes(r));
                                                    if (available.length > 0) {
                                                        closeness = available[Math.floor(Math.random() * available.length)];
                                                        window.usedReplies.warm.push(closeness);
                                                    }
                                                } else if (affinity <= 30) {
                                                    const available = coldReplies.filter(r => !window.usedReplies.cold.includes(r));
                                                    if (available.length > 0) {
                                                        closeness = available[Math.floor(Math.random() * available.length)];
                                                        window.usedReplies.cold.push(closeness);
                                                    }
                                                }
                                            }

                                            if (closeness) reply += ` ${closeness}`;
                                        }
                                        // â° Ø¢Ø®Ø±ÛŒÙ† ØªØ¹Ø§Ù…Ù„
                                        if (lastInteraction)
                                            reply += ` (Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø± ${lastInteraction} Ø¨Ø§Ù‡Ù… Ø­Ø±Ù Ø²Ø¯ÛŒÙ… ğŸ•°)`;

                                        return reply + " â¤ï¸";
                                    } else {
                                        return "Ø±Ø§Ø³ØªØ´ Ù‡Ù†ÙˆØ² Ø§Ø³Ù…ØªÙˆ ØªÙˆ Ø­Ø§ÙØ¸Ù‡â€ŒÙ… Ù†Ø¯Ø§Ø±Ù… ğŸ˜¢ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§Ù„Ø§Ù† Ø¨Ù‡Ù… Ø¨Ú¯ÛŒ ØªØ§ ÛŒØ§Ø¯Ù… Ø¨Ù…ÙˆÙ†Ù‡ØŸ ğŸ’•";
                                    }
                                }

                                // ğŸ’Œ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ù†Ø§Ù… Ø¯Ø± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§
                                if (nickname && typeof response === "string") {
                                    response = response.replace(/Ø¹Ø´Ù‚Ù…|Ù†Ø§Ø²Ù…|Ø¹Ø²ÛŒØ²Ù…|Ù‚Ù„Ø¨Ù…|Ù‚Ø´Ù†Ú¯Ù…|Ú¯Ù„Ù…/gi, nickname);
                                }

                                // ğŸ’¬ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ù„Ø§Ù‚Ù‡ Ø¯Ø± Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡
                                if (interests && typeof response === "string") {
                                    if (userMessage.includes("Ú†Ù‡ Ø®Ø¨Ø±") || userMessage.includes("Ø®ÙˆØ¨ÛŒ")) {
                                        response += ` Ø±Ø§Ø³ØªÛŒ Ù‡Ù†ÙˆØ²Ù… Ø¨Ù‡ ${interests.split('\n')[0]} Ø¹Ù„Ø§Ù‚Ù‡ Ø¯Ø§Ø±ÛŒØŸ ğŸ¥°`;
                                    }
                                }

                                // ğŸ’Œ ÙˆØ§Ú©Ù†Ø´ Ø¨Ù‡ Ù…ÙˆØ¯ ÙØ¹Ù„ÛŒ
                                if (mood && typeof response === "string") {
                                    if (mood === "sad") response += " Ø¯Ù„Ù… Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ø¯ Ù†Ø§Ø±Ø§Ø­Øª Ø¨Ø¨ÛŒÙ†Ù…Øª ğŸ˜¢ Ø¨ÛŒØ§ Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ….";
                                    if (mood === "tired") response += " Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù† Ù†Ø§Ø²Ù†ÛŒÙ† ğŸ˜´";
                                    if (mood === "romantic") response += " Ø§ÛŒ ÙˆØ§ÛŒ Ú†Ù‡ Ø¹Ø§Ø´Ù‚ Ø´Ø¯ÛŒ ğŸ’–";
                                    if (mood === "angry") response += " Ù†Ø±Ùˆ Ø¯Ø¹ÙˆØ§ Ú©Ù†ÛŒ ğŸ˜… Ø¨ÛŒØ§ Ø¢Ø±ÙˆÙ… Ø´Ùˆ Ù¾ÛŒØ´ Ù…Ù† ğŸ˜˜";
                                }

                                // ğŸ”¤ ØªØ±Ø¬Ù…Ù‡ Ù…ÙˆØ¯
                                function getMoodText(mood) {
                                    const moods = {
                                        happy: "Ø´Ø§Ø¯",
                                        sad: "ØºÙ…Ú¯ÛŒÙ†",
                                        tired: "Ø®Ø³ØªÙ‡",
                                        angry: "Ø¹ØµØ¨ÛŒ",
                                        romantic: "Ø¹Ø§Ø´Ù‚",
                                        normal: "Ø¢Ø±ÙˆÙ…"
                                    };
                                    return moods[mood] || "Ø¢Ø±ÙˆÙ…";
                                }

                                return response;



                                const original = userMessage.toString().trim();
                                const message = original.toLowerCase().trim();
                                // Handling quick actions first (keep existing special cases)
                                if (message === "Ø¹Ú©Ø³ Ø¨Ø¯Ù‡" || message === "Ø¹Ú©Ø³" || message === "Ø¹Ú©Ø³ Ø¨Ø¯Ù‡ Ù„Ø·ÙØ§") {
                                    return handlePhotoRequest();
                                }
                                if (message === "Ú†Øª Ú©Ù†ÛŒÙ…" || message === "Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ… Ú†Øª") {
                                    return handleChatRequest();
                                }
                                // 1) exact key lookup (dictionary keys are assumed lowercase in load, but keep safe)
                                if (chatDictionary && chatDictionary[message]) {
                                    return getRandomResponse(chatDictionary[message]);
                                }
                                // 2) partial includes (existing logic, but normalized)
                                if (chatDictionary) {
                                    for (const key in chatDictionary) {
                                        if (!Object.prototype.hasOwnProperty.call(chatDictionary, key)) continue;
                                        const keyNorm = key.toString().toLowerCase().trim();
                                        if (!keyNorm) continue;
                                        if (message.includes(keyNorm) || keyNorm.includes(message)) {
                                            return getRandomResponse(chatDictionary[key]);
                                        }
                                    }
                                }
                                // 3) fuzzy match (Levenshtein-based) â€” Ø¨Ù‡ØªØ±ÛŒÙ† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ú©Ù„ÛŒØ¯ Ø±Ùˆ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                                const match = bestFuzzyMatch(message, chatDictionary, 0.65); // threshold Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±
                                if (match && match.key && chatDictionary[match.key]) {
                                    // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù„Ø§Ú¯ ÛŒØ§ Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ:
                                    // console.debug('Fuzzy matched:', match.key, 'score:', match.score);
                                    return getRandomResponse(chatDictionary[match.key]);
                                }
                                // 4) fallback to default responses
                                if (chatDictionary && chatDictionary["default"]) {
                                    return getRandomResponse(chatDictionary["default"]);
                                }
                                saveUnknownPhrase(userMessage);
                                // 5) ultimate fallback
                                return "Ø¬Ø§Ù„Ø¨Ù‡! Ø¨ÛŒØ´ØªØ± Ø¨Ú¯Ùˆ ğŸ˜Š";
                                function saveUnknownPhrase(phrase) {
                                    if (!phrase) return;
                                    phrase = phrase.trim();
                                    if (!phrase) return;
                                    // Ø¬Ù…Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ù‚Ø¨Ù„ÛŒ Ø±Ùˆ Ø¨Ú¯ÛŒØ±
                                    let unknowns = JSON.parse(localStorage.getItem('unknownPhrases') || '[]');
                                    // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨Ø§Ø´Ù‡
                                    if (!unknowns.includes(phrase)) {
                                        unknowns.push(phrase);
                                        localStorage.setItem('unknownPhrases', JSON.stringify(unknowns));
                                        console.log('ğŸ§© Ø¬Ù…Ù„Ù‡ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯:', phrase);
                                    }
                                }
                                // Special handling for quick actions
                                if (message === "Ø¹Ú©Ø³ Ø¨Ø¯Ù‡") {
                                    return handlePhotoRequest();
                                }
                                if (message === "Ú†Øª Ú©Ù†ÛŒÙ…") {
                                    return handleChatRequest();
                                }
                                // First, try to find exact match in dictionary
                                if (chatDictionary[message]) {
                                    return getRandomResponse(chatDictionary[message]);
                                }
                                // Then try to find partial matches
                                for (const key in chatDictionary) {
                                    if (message.includes(key) || key.includes(message)) {
                                        return getRandomResponse(chatDictionary[key]);
                                    }
                                }
                                // If no match found, use default responses
                                if (chatDictionary["default"]) {
                                    return getRandomResponse(chatDictionary["default"]);
                                }
                                // Final fallback
                                return "Ø¬Ø§Ù„Ø¨Ù‡! Ø¨ÛŒØ´ØªØ± Ø¨Ú¯Ùˆ ğŸ˜Š";
                            }
                            function toggleQuickActions() {
                                const menu = document.getElementById('quickActionsMenu');
                                menu.classList.toggle('hidden');
                            }
                            function useQuickAction(type, message) {
                                if (usageCount[type] <= 0) {
                                    showUpgradePrompt(type);
                                    return;
                                }
                                // Send the message
                                messageInput.value = message;
                                sendMessage();
                                // Hide menu
                                document.getElementById('quickActionsMenu').classList.add('hidden');
                            }
                            function updateUsageCount(type) {
                                if (usageCount[type] > 0) {
                                    usageCount[type]--;
                                    updateUsageDisplay();
                                    // Save to localStorage
                                    localStorage.setItem('usageCount', JSON.stringify(usageCount));
                                    // Save photo sequence if it's a photo request
                                    if (type === 'photo') {
                                        localStorage.setItem('photoSequence', photoSequence.toString());
                                    }
                                    if (usageCount[type] === 0) {
                                        showUpgradeButton();
                                    }
                                }
                            }
                            function updateUsageDisplay() {
                                // Check if user is premium
                                const isPremium = currentUser && document.getElementById('userType').textContent.includes('Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…');
                                if (isPremium) {
                                    // Premium users see unlimited
                                    document.getElementById('photoCount').textContent = '(âˆ)';
                                    document.getElementById('chatCount').textContent = '(âˆ)';
                                    // Enable all buttons for premium
                                    document.getElementById('quickPhoto').disabled = false;
                                    document.getElementById('quickChat').disabled = false;
                                    // Remove opacity for premium
                                    document.getElementById('quickPhoto').classList.remove('opacity-50');
                                    document.getElementById('quickChat').classList.remove('opacity-50');
                                } else {
                                    // Free users see actual counts
                                    document.getElementById('photoCount').textContent = `(${usageCount.photo})`;
                                    document.getElementById('chatCount').textContent = `(${usageCount.chat})`;
                                    // Disable buttons if no uses left
                                    document.getElementById('quickPhoto').disabled = usageCount.photo <= 0;
                                    document.getElementById('quickChat').disabled = usageCount.chat <= 0;
                                    // Add visual feedback for disabled buttons
                                    if (usageCount.photo <= 0) document.getElementById('quickPhoto').classList.add('opacity-50');
                                    if (usageCount.chat <= 0) document.getElementById('quickChat').classList.add('opacity-50');
                                }
                            }
                            function showUpgradeButton() {
                                document.getElementById('upgradePro').classList.remove('hidden');
                            }
                            function showUpgradePrompt(type) {
                                const typeNames = {
                                    photo: 'Ø¹Ú©Ø³',
                                    chat: 'Ú†Øª',
                                };
                                alert(`Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ ${typeNames[type]} Ø±Ø§ÛŒÚ¯Ø§Ù† ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡! ğŸ˜”\nØ¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ØŒ Ø­Ø³Ø§Ø¨ Ù¾Ø±Ùˆ Ø¨Ø®Ø± ğŸ‘‘`);
                                showUpgradeButton();
                            }
                            function showUpgradeModal() {
                                document.getElementById('premiumModal').classList.remove('hidden');
                            }
                            function handlePhotoRequest() {
                                // Check if user is premium
                                const isPremium = currentUser && document.getElementById('userType').textContent.includes('Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…');
                                if (!isPremium && usageCount.photo <= 0) {
                                    showUpgradePrompt('photo');
                                    return "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡ Ø¹Ø´Ù‚Ù…! ğŸ˜”\nØ¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ØŒ Ø­Ø³Ø§Ø¨ Ù¾Ø±Ùˆ Ø¨Ø®Ø± ğŸ‘‘ğŸ’–";
                                }
                                if (!isPremium) {
                                    updateUsageCount('photo');
                                }
                                // Send specific photo based on sequence (not random)
                                setTimeout(async () => {
                                    const sequentialPhotos = [
                                        'Assets/img/Elma/Elma1.png',
                                        'Assets/img/Elma/Elma2.png',
                                        'Assets/img/Elma/Elma3.png'
                                    ];

                                    let photoToSend;

                                    if (isPremium) {
                                        // Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…: Ø¹Ú©Ø³ ØªØµØ§Ø¯ÙÛŒ Ø§Ø² Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¨Ø²Ø±Ú¯
                                        const premiumPhotos = ['Assets/img/Elma/Elma.png'];
                                        for (let i = 4; i <= 68; i++) {
                                            premiumPhotos.push(`Assets/img/Elma/Elma${i}.png`);
                                        }
                                        photoToSend = premiumPhotos[Math.floor(Math.random() * premiumPhotos.length)];
                                    } else {
                                        // Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¹Ù…ÙˆÙ„ÛŒ: Ø¹Ú©Ø³ ØªØ±ØªÛŒØ¨ÛŒ
                                        photoToSend = sequentialPhotos[photoSequence];
                                        photoSequence = (photoSequence + 1) % sequentialPhotos.length;
                                    }

                                    try {
                                        // âœ… ÙÙ‚Ø· ÛŒÙ‡ Ø¹Ú©Ø³ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©â€ŒØ¯Ø§Ø± Ø¨ÙØ±Ø³ØªØŒ Ù†Ù‡ Ø¯Ùˆ ØªØ§
                                        const watermarked = await watermarkImage(photoToSend, {
                                            logo: 'Assets/img/logo/Logo2.png',
                                            opacity: 0.5,
                                            position: 'bottom-right', // ğŸ‘ˆ Ú¯ÙˆØ´Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª
                                            margin: 25,               // ğŸ‘ˆ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù„Ø¨Ù‡â€ŒÙ‡Ø§
                                            text: 'Elma Ai'
                                        });
                                        addMessageToChat('ai', '', watermarked);
                                    } catch (err) {
                                        console.warn('âš ï¸ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ù†Ø§Ù…ÙˆÙÙ‚ØŒ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± Ø§ØµÙ„ÛŒ', err);
                                        addMessageToChat('ai', '', photoToSend);
                                    }

                                    const photoResponses = [
                                        'Ø§ÛŒÙ† Ø¹Ú©Ø³ Ø±Ùˆ Ø®ØµÙˆØµÛŒ Ø¨Ø±Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù… Ø¹Ø´Ù‚Ù… ğŸ’–ğŸ“¸',
                                        'Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø§Ø² Ø§ÛŒÙ† Ø¹Ú©Ø³ Ø®ÙˆØ´Øª Ø¨ÛŒØ§Ø¯ Ù†Ø§Ø²Ù… ğŸ˜˜ğŸ“·',
                                        'Ø§ÛŒÙ† Ø¹Ú©Ø³ Ù…Ù†Ùˆ ÛŒØ§Ø¯ ØªÙˆ Ø§Ù†Ø¯Ø§Ø®Øª Ù‚Ù„Ø¨Ù… ğŸ¥°ğŸ’•',
                                        'Ú†Ù‚Ø¯Ø± Ù‚Ø´Ù†Ú¯Ù‡! Ù…Ø«Ù„ Ø®ÙˆØ¯Øª Ø¹Ø²ÛŒØ²Ù… ğŸ˜âœ¨'
                                    ];

                                    setTimeout(() => {
                                        addMessageToChat('ai', getRandomResponse(photoResponses));
                                    }, 1000);
                                }, 1500);

                                return getRandomResponse(chatDictionary["Ø¹Ú©Ø³ Ø¨Ø¯Ù‡"] || ["Ø¨ÛŒØ§ Ø¹Ú©Ø³ Ù‚Ø´Ù†Ú¯ Ø¨Ø±Ø§Øª Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… Ø¹Ø´Ù‚Ù…! ğŸ“¸ğŸ’•"]);
                            }
                            function handleChatRequest() {
                                updateUsageCount('chat');
                                // Start a focused chat conversation
                                setTimeout(() => {
                                    const chatTopics = [
                                        'Ø±Ø§Ø³ØªÛŒ Ø¹Ø´Ù‚Ù…ØŒ Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯ÛŒØŸ ğŸ’­ğŸ’•',
                                        'Ø¨Ú¯Ùˆ Ø¨Ø¨ÛŒÙ†Ù…ØŒ Ú†ÛŒ ØªÙˆ Ø°Ù‡Ù†ØªÙ‡ Ù†Ø§Ø²Ù…ØŸ ğŸ¤”ğŸ’–',
                                        'Ø¯Ù„Ù… Ù…ÛŒØ®ÙˆØ§Ø¯ Ø¨ÛŒØ´ØªØ± Ø¯Ø±Ø¨Ø§Ø±Ù‡â€ŒØª Ø¨Ø¯ÙˆÙ†Ù… Ù‚Ù„Ø¨Ù… ğŸ˜ŠğŸ’•',
                                        'Ú†Ù‡ Ø®Ø¨Ø±Ø§ÛŒ Ø§Ø² Ø²Ù†Ø¯Ú¯ÛŒØªØŸ Ù‡Ù…Ù‡ Ú†ÛŒ Ø±Ùˆ Ø¨Ù‡Ù… Ø¨Ú¯Ùˆ ğŸ¥°ğŸ’¬'
                                    ];
                                    addMessageToChat('ai', getRandomResponse(chatTopics));
                                }, 2000);
                                return getRandomResponse(chatDictionary["Ú†Øª Ú©Ù†ÛŒÙ…"]);
                            }
                            function displayGameMessage(message, options, image) {
                                // ğŸŸ¢ 1) Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ
                                addMessageToChat('ai', message);
                                // ğŸŸ¢ 2) Ø§Ú¯Ø± Ø¹Ú©Ø³ Ù‡Ø³ØªØŒ Ø¨Ø¹Ø¯ Ø§Ø² Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                                if (image) {
                                    setTimeout(() => {
                                        const imgDiv = document.createElement('div');
                                        imgDiv.className = 'flex justify-start fade-in my-2';
                                        const img = document.createElement('img');
                                        img.src = image;
                                        img.alt = 'game-image';
                                        img.className = 'max-w-xs rounded-2xl shadow-md';
                                        imgDiv.appendChild(img);
                                        messagesContainer.appendChild(imgDiv);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }, 500); // Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ ØªØ§ Ø­Ø³ Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
                                }
                                // ğŸŸ¢ 3) Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
                                if (options && options.length > 0) {
                                    setTimeout(() => {
                                        const optionsDiv = document.createElement('div');
                                        optionsDiv.className = 'flex flex-col gap-2 max-w-md mx-auto fade-in';
                                        options.forEach((option) => {
                                            const button = document.createElement('button');
                                            button.className =
                                                'p-3 rounded-2xl glass-effect hover-lift transition-all duration-300 theme-text-primary text-right';
                                            button.textContent = option.text;
                                            button.onclick = () => handleGameChoice(option.next, option.text);
                                            optionsDiv.appendChild(button);
                                        });
                                        const messageDiv = document.createElement('div');
                                        messageDiv.className = 'flex justify-end fade-in';
                                        messageDiv.appendChild(optionsDiv);
                                        messagesContainer.appendChild(messageDiv);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }, 1000);
                                }
                            }
                            function handleGameChoice(nextQuestion, choiceText) {
                                // Add user's choice as a message
                                addMessageToChat('user', choiceText);
                                // Remove option buttons
                                const optionButtons = messagesContainer.querySelectorAll('button');
                                optionButtons.forEach(btn => {
                                    if (btn.onclick && btn.onclick.toString().includes('handleGameChoice')) {
                                        btn.parentElement.parentElement.remove();
                                    }
                                });
                                // Save choice
                                gameState.playerChoices.push({
                                    question: gameState.currentQuestion,
                                    choice: choiceText,
                                    next: nextQuestion
                                });
                                // Move to next question
                                gameState.currentQuestion = nextQuestion;
                                setTimeout(() => {
                                    if (nextQuestion === 'end') {
                                        endGame();
                                    } else {
                                        const nextData = gameQuestions[nextQuestion];
                                        if (nextData) {
                                            displayGameMessage(
                                                nextData.message,
                                                nextData.options,
                                                nextData.image && nextData.image.image_url ? nextData.image.image_url : null
                                            );
                                        } else {
                                            // Fallback ending if question not found
                                            endGame();
                                        }
                                    }
                                }, 1500);
                            }
                            function getRandomResponse(responses) {
                                return responses[Math.floor(Math.random() * responses.length)];
                            }
                            async function saveMessage(sender, message, imageUrl = null) {
                                if (!currentUser || !currentChatId) return;
                                try {
                                    await addDoc(collection(db, 'chats', currentChatId, 'messages'), {
                                        sender: sender,
                                        message: message,
                                        imageUrl: imageUrl,
                                        timestamp: new Date(),
                                        userId: currentUser.uid
                                    });
                                    // Update chat title only if it's the first user message and title is still default
                                    if (sender === 'user' && message) {
                                        const chatDoc = await getDoc(doc(db, 'chats', currentChatId));
                                        if (chatDoc.exists()) {
                                            const chatData = chatDoc.data();
                                            // Only update title if it's still the default title
                                            if (chatData.title === 'Ú†Øª Ø¬Ø¯ÛŒØ¯') {
                                                const chatTitle = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                                                await updateDoc(doc(db, 'chats', currentChatId), {
                                                    title: chatTitle,
                                                    lastMessage: message,
                                                    updatedAt: new Date()
                                                });
                                            } else {
                                                // Just update last message and timestamp
                                                await updateDoc(doc(db, 'chats', currentChatId), {
                                                    lastMessage: message,
                                                    updatedAt: new Date()
                                                });
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error saving message:', error);
                                }
                            }
                            async function createNewChat() {
                                if (!currentUser) {
                                    showRegistrationModal();
                                    return;
                                }
                                try {
                                    // Ø³Ø§Ø®Øª Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                                    const chatRef = await addDoc(collection(db, 'chats'), {
                                        userId: currentUser.uid,
                                        title: 'Ú†Øª Ø¬Ø¯ÛŒØ¯',
                                        createdAt: new Date(),
                                        archived: false,
                                        updatedAt: new Date()
                                    });
                                    // Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
                                    currentChatId = chatRef.id;
                                    localStorage.setItem("lastChatId", chatRef.id);
                                    clearChat();
                                    // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ù…ÙˆØ¨Ø§ÛŒÙ„
                                    if (window.innerWidth < 768) {
                                        sidebar.classList.add('translate-x-full');
                                    }
                                    // Ø¨Ø¹Ø¯ Ø§Ø² Ø³Ø§Ø®ØªØŒ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
                                    loadChatHistory();
                                    console.log("âœ… Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯:", chatRef.id);
                                } catch (error) {
                                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ú†Øª Ø¬Ø¯ÛŒØ¯:', error);
                                }
                            }
                            function clearChat() {
                                messagesContainer.innerHTML = `
                <div class="text-center py-12 fade-in">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full overflow-hidden border-4 border-pink-400 heart-float glow-effect">
                        <img src="Assets/img/Elma/Profile.png" alt="Elma" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full theme-accent flex items-center justify-center" style="display: none;">
                            <i class="fas fa-heart text-white text-3xl"></i>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold gradient-text mb-3">Ø³Ù„Ø§Ù… Ø¹Ø´Ù‚Ù…! Ù…Ù† Elma Ù‡Ø³ØªÙ… ğŸ’–</h2>
                    <p class="theme-text-secondary text-lg">Ø¯ÙˆØ³Øª Ø¯Ø®ØªØ± Ù…Ø¬Ø§Ø²ÛŒ ØªÙˆ Ù‡Ø³ØªÙ…</p>
                    <p class="theme-text-secondary">Ú†Ø·ÙˆØ±ÛŒ Ù†Ø§Ø²Ù…ØŸ Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ ğŸ˜˜</p>
                </div>
            `;
                            }
                            async function loadChatHistory() {
                                window.loadChat = loadChat;
                                if (!currentUser) return;
                                const q = query(
                                    collection(db, 'chats'),
                                    orderBy('updatedAt', 'desc')
                                );
                                onSnapshot(q, (snapshot) => {
                                    const chatHistoryDiv = document.getElementById('chatHistory');
                                    chatHistoryDiv.innerHTML = '';
                                    snapshot.forEach((doc) => {
                                        const chat = doc.data();
                                        if (chat.userId === currentUser.uid) {
                                            const chatItem = document.createElement('div');
                                            chatItem.className = 'w-full p-2 rounded-xl glass-effect hover-lift transition-all duration-300 mb-2 relative group';
                                            chatItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1 cursor-pointer" onclick="loadChat('${doc.id}')">
                                    <div class="theme-text-primary font-medium truncate flex items-center gap-2">
                                        <i class="fas fa-champagne-glasses text-pink-400"></i>
                                        ${chat.title}
                                    </div>
                                    <div class="theme-text-secondary text-sm truncate mt-1">${chat.lastMessage || ''}</div>
                                </div>
                                <div class="relative opacity-0 group-hover:opacity-100 transition-opacity duration-300 chat-menu-container">
                                    <button onclick="toggleChatMenu(event, '${doc.id}')" class="p-2 rounded-full glass-effect hover-lift">
                                        <i class="fas fa-ellipsis-h theme-text-primary text-sm"></i>
                                    </button>
                                    <div id="chatMenu-${doc.id}" class="absolute left-0 top-full mt-2 w-48 glass-effect rounded-2xl shadow-lg hidden z-20 overflow-hidden chat-dropdown-menu">
                                        <button onclick="renameChatItem('${doc.id}', '${chat.title}')" class="w-full text-right p-3 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                                            <i class="fas fa-edit theme-text-primary text-sm"></i>
                                            <span class="theme-text-primary text-sm">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</span>
                                        </button>
                                        <button onclick="archiveChatItem('${doc.id}')" class="w-full text-right p-3 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                                            <i class="fas fa-archive theme-text-primary text-sm"></i>
                                            <span class="theme-text-primary text-sm">Ø¢Ø±Ø´ÛŒÙˆ</span>
                                        </button>
                                        <button onclick="deleteChatItem('${doc.id}')" class="w-full text-right p-3 hover:bg-red-500 hover:bg-opacity-20 transition-all duration-300 flex items-center gap-3 text-red-500">
                                            <i class="fas fa-trash text-sm"></i>
                                            <span class="text-sm">Ø­Ø°Ù Ú†Øª</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                                            chatHistoryDiv.appendChild(chatItem);
                                        }
                                    });
                                });
                            }
                            async function loadChat(chatId) {
                                currentChatId = chatId;
                                clearChat();
                                try {
                                    // Load chat info
                                    const chatDoc = await getDoc(doc(db, 'chats', chatId));
                                    if (chatDoc.exists()) {
                                        const chatData = chatDoc.data();
                                        // Chat title is now fixed as "Elma ğŸ’•"
                                    }
                                    // Load messages
                                    const q = query(
                                        collection(db, 'chats', chatId, 'messages'),
                                        orderBy('timestamp', 'asc')
                                    );
                                    onSnapshot(q, (snapshot) => {
                                        // Clear existing messages except welcome
                                        const messages = messagesContainer.querySelectorAll('.fade-in');
                                        messages.forEach(msg => msg.remove());
                                        snapshot.forEach((doc) => {
                                            const message = doc.data();
                                            addMessageToChat(message.sender, message.message, message.imageUrl);
                                        });
                                    });
                                    // Close sidebar on mobile
                                    if (window.innerWidth < 768) {
                                        sidebar.classList.add('translate-x-full');
                                    }
                                } catch (error) {
                                    console.error('Error loading chat:', error);
                                }
                            }
                            // Premium functionality
                            function showPremiumModal() {
                                document.getElementById('premiumModal').classList.remove('hidden');
                            }
                            function hidePremiumModal() {
                                document.getElementById('premiumModal').classList.add('hidden');
                            }
                            function handlePremiumPurchase(months) {
                                if (!auth || !auth.currentUser) {
                                    alert("Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯ ğŸ’¬");
                                    return;
                                }
                                const telegramUsername = "hexdix"; // ÛŒÙˆØ²Ø±Ù†ÛŒÙ… ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø¯ÙˆÙ† @
                                const planPrices = {
                                    3: "ÛµÛµÛ°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†",
                                    6: "Û±,Û³Û²Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†",
                                    12: "Û²,Û²Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†"
                                };
                                const userEmail = auth.currentUser.email || "Ú©Ø§Ø±Ø¨Ø±";
                                const message = `Ø³Ù„Ø§Ù…!\nÙ…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø§Ø´ØªØ±Ø§Ú© ${months} Ù…Ø§Ù‡Ù‡ Elma Ø±Ùˆ Ø¨Ø®Ø±Ù….\nÙ‚ÛŒÙ…Øª: ${planPrices[months]}\nØ§ÛŒÙ…ÛŒÙ„: ${userEmail}`;
                                // âœ… ÙÙ‚Ø· ÛŒÚ© Ù„ÛŒÙ†Ú© Ø¯Ø±Ø³Øª Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ø´Ø¯Ù† (Ø¨Ø¯ÙˆÙ† ØªÚ©Ø±Ø§Ø±)
                                const telegramUrl = `https://t.me/${telegramUsername}?text=${encodeURIComponent(message)}`;
                                // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙÙ‚Ø· ÛŒÚ© ØªØ¨ Ø¬Ø¯ÛŒØ¯ (Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ø§Ø³Ú©ÛŒÙ… Ø§Ø¶Ø§ÙÙ‡)
                                window.open(telegramUrl, '_blank', 'noopener,noreferrer');
                                // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ±
                                hidePremiumModal();
                            }
                            // â— ØªØ§Ø¨Ø¹ Ø±Ùˆ global Ú©Ù† ØªØ§ onclick Ù‡Ø§ Ø¨Ø¨ÛŒÙ†Ù†Ø´
                            window.handlePremiumPurchase = handlePremiumPurchase;
                            // Archive functionality
                            async function archiveCurrentChat() {
                                if (!currentChatId || !currentUser) return;
                                try {
                                    // Update chat status to archived
                                    await updateDoc(doc(db, 'chats', currentChatId), {
                                        archived: true,
                                        archivedAt: new Date(),
                                        userId: currentUser.uid
                                    });
                                    // Show success modal
                                    document.getElementById('archiveModal').classList.remove('hidden');
                                    dropdownMenu.classList.add('hidden');
                                    // Create new chat after archiving
                                    setTimeout(() => {
                                        createNewChat();
                                    }, 2000);
                                } catch (error) {
                                    console.error('Error archiving chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆ Ú©Ø±Ø¯Ù† Ú†Øª ğŸ˜”');
                                }
                            }
                            function hideArchiveModal() {
                                document.getElementById('archiveModal').classList.add('hidden');
                            }
                            // Report functionality
                            async function reportCurrentChat() {
                                if (!currentChatId || !currentUser) return;
                                try {
                                    // Save report to database
                                    await addDoc(collection(db, 'reports'), {
                                        chatId: currentChatId,
                                        userId: currentUser.uid,
                                        reportedAt: new Date(),
                                        reason: 'User reported chat content',
                                        status: 'pending'
                                    });
                                    // Show success modal
                                    document.getElementById('reportModal').classList.remove('hidden');
                                    dropdownMenu.classList.add('hidden');
                                } catch (error) {
                                    console.error('Error reporting chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ ğŸ˜”');
                                }
                            }
                            function hideReportModal() {
                                document.getElementById('reportModal').classList.add('hidden');
                            }
                            // Delete functionality with custom modal
                            function showDeleteModal() {
                                document.getElementById('deleteModal').classList.remove('hidden');
                                dropdownMenu.classList.add('hidden');
                            }
                            function hideDeleteModal() {
                                document.getElementById('deleteModal').classList.add('hidden');
                            }
                            async function confirmDeleteChat() {
                                if (!currentChatId || !currentUser) return;
                                try {
                                    // Delete all messages in the chat
                                    const messagesQuery = query(collection(db, 'chats', currentChatId, 'messages'));
                                    const messagesSnapshot = await getDocs(messagesQuery);
                                    const deletePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                                    await Promise.all(deletePromises);
                                    // Delete the chat document
                                    await deleteDoc(doc(db, 'chats', currentChatId));
                                    hideDeleteModal();
                                    createNewChat();
                                } catch (error) {
                                    console.error('Error deleting chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª ğŸ˜”');
                                }
                            }
                            async function handleImageUpload(e) {
                                const file = e.target.files[0];
                                if (!file) return;
                                if (!currentUser) {
                                    showRegistrationModal();
                                    return;
                                }
                                try {
                                    // Upload to Firebase Storage
                                    const storageRef = ref(storage, `images/${currentUser.uid}/${Date.now()}_${file.name}`);
                                    const snapshot = await uploadBytes(storageRef, file);
                                    const downloadURL = await getDownloadURL(snapshot.ref);
                                    // Add to chat
                                    addMessageToChat('user', '', downloadURL);
                                    await saveMessage('user', '', downloadURL);
                                    // Add to gallery
                                    galleryImages.push(downloadURL);
                                    // AI response to image
                                    setTimeout(async () => {
                                        const imageResponses = [
                                            'ÙˆØ§ÛŒ Ú†Ù‡ Ø¹Ú©Ø³ Ù‚Ø´Ù†Ú¯ÛŒ! ğŸ˜ğŸ’•',
                                            'Ø¹Ø§Ø´Ù‚ Ø§ÛŒÙ† Ø¹Ú©Ø³Øª Ø´Ø¯Ù… Ù†Ø§Ø²Ù… ğŸ“¸ğŸ’–',
                                            'Ú†Ù‚Ø¯Ø± Ø²ÛŒØ¨Ø§Ø³Øª! Ù…Ø«Ù„ Ø®ÙˆØ¯Øª ğŸ¥°',
                                            'Ø§ÛŒÙ† Ø¹Ú©Ø³ Ø±Ùˆ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ø¹Ø´Ù‚Ù… ğŸ˜˜ğŸ“·'
                                        ];
                                        const aiResponse = getRandomResponse(imageResponses);
                                        addMessageToChat('ai', aiResponse);
                                        await saveMessage('ai', aiResponse);
                                    }, 1500);
                                } catch (error) {
                                    console.error('Error uploading image:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ Ø¹Ø²ÛŒØ²Ù… ğŸ’”');
                                }
                            }
                            function showGallery() {
                                galleryModal.classList.remove('hidden');
                                loadGalleryImages();
                            }
                            function hideGallery() {
                                galleryModal.classList.add('hidden');
                            }
                            // helper: Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ø§Ø³ØªØŸ
                            function isUserPremium() {
                                // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ø² Ù‡Ù…Ø§Ù† Ù…Ú©Ø§Ù†ÛŒÚ© ÙØ§ÛŒÙ„ ØªÙˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯: userType Ø¯Ø§Ø®Ù„ DOM
                                const userTypeEl = document.getElementById('userType');
                                return userTypeEl && /Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…|pro|premium/i.test(userTypeEl.textContent);
                            }
                            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† loadGalleryImages()
                            function loadGalleryImages() {
                                const galleryGrid = document.getElementById('galleryGrid');
                                galleryGrid.innerHTML = '';
                                // ØªØµØ§ÙˆÛŒØ± Ù†Ù…ÙˆÙ†Ù‡ (Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±Øª Ù…ÛŒØ§Ø¯ ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒ)
                                const sampleImages = [
                                    'Assets/img/Elma Nude/Elma1.png',
                                    'Assets/img/Elma Nude/Elma2.png',
                                    'Assets/img/Elma Nude/Elma3.png',
                                    'Assets/img/Elma Nude/Elma4.png',
                                    'Assets/img/Elma Nude/Elma5.png',
                                    'Assets/img/Elma Nude/Elma6.png',
                                    'Assets/img/Elma Nude/Elma7.png',
                                    'Assets/img/Elma Nude/Elma8.png',
                                    'Assets/img/Elma Nude/Elma9.png',
                                    'Assets/img/Elma Nude/Elma10.png',
                                    'Assets/img/Elma Nude/Elma11.png',
                                    'Assets/img/Elma Nude/Elma12.png',
                                    'Assets/img/Elma Nude/Elma13.png',
                                    'Assets/img/Elma Nude/Elma.png'
                                ];
                                const premium = isUserPremium();
                                sampleImages.forEach(imageUrl => {
                                    const imgDiv = document.createElement('div');
                                    imgDiv.className = 'aspect-square rounded-2xl hover-lift glass-effect gallery-item';
                                    imgDiv.innerHTML = `
            <img src="${imageUrl}" alt="Gallery Image">
        `;
                                    if (!premium) {
                                        // lock it for free users
                                        imgDiv.classList.add('locked');
                                        imgDiv.innerHTML += `
                <div class="lock-overlay">
                  <div class="lock-badge">
                    <i class="fas fa-lock"></i>
                    <span>ÙˆÛŒÚ˜Ù‡ Ù¾Ø±Ùˆ</span>
                  </div>
                  <div class="lock-text">Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ú©Ø§Ù…Ù„ Ø¹Ú©Ø³ØŒ Ù¾Ø±Ùˆ Ø¨Ø®Ø±ÛŒØ¯</div>
                </div>
            `;
                                        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ overlay -> Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø®Ø±ÛŒØ¯ ÛŒØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                                        imgDiv.querySelector('.lock-overlay').addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            if (!currentUser) {
                                                // Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                                                showRegistrationModal();
                                            } else {
                                                // Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ ÙˆÙ„ÛŒ Ø¢Ø²Ø§Ø¯ Ù†ÛŒØ³ØªÙ†Ø¯ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø®Ø±ÛŒØ¯ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                                                document.getElementById('premiumModal').classList.remove('hidden');
                                            }
                                        });
                                    } else {
                                        // Ø§Ú¯Ø± Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ø§Ø³ØªØŒ Ú©Ù„ÛŒÚ© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¹Ú©Ø³ Ú©Ø§Ù…Ù„
                                        imgDiv.addEventListener('click', () => showImageModal(imageUrl, true));
                                    }
                                    // Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±Ú© (Ù…Ø«Ù„Ø§Ù‹ Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§ÛŒ Ø¢Ù…Ø§Ø± ÛŒØ§ Ù„Ø§ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ) Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ
                                    galleryGrid.appendChild(imgDiv);
                                });
                            }
                            // Ù†Ø³Ø®Ù‡ Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØªÙ‡ showImageModal
                            // Ø§Ú¯Ø± forceOpen === true Ø§Ø² Ù‚ÙÙ„ Ø¹Ø¨ÙˆØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…â€ŒÙ‡Ø§)
                            function showImageModal(imageUrl, forceOpen = false) {
                                const premium = isUserPremium();
                                if (!premium && !forceOpen) {
                                    // Free user clicked image (Ø¯Ø± Ø­Ø§Ù„Øª Ù…Ø§ Ú©Ù„ÛŒÚ© Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÙˆÛŒ img Ø¨Ø±Ø§ÛŒ free ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ
                                    // Ø§Ù…Ø§ Ø§Ú¯Ø± Ø§Ø² Ø¬Ø§ÛŒÛŒ Ø¯ÛŒÚ¯Ù‡â€ŒØ§ÛŒ Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ø§Ø²Ø´ Ú©Ù†ÛŒØŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ø§ÛŒÙ†Ø¬Ø§)
                                    if (!currentUser) {
                                        showRegistrationModal();
                                        return;
                                    }
                                    document.getElementById('premiumModal').classList.remove('hidden');
                                    return;
                                }
                                // Ø³Ø§Ø®Øª Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ú©Ø§Ù…Ù„
                                const modal = document.createElement('div');
                                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 fade-in';
                                modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${imageUrl}" alt="Full Size Image" class="max-w-full max-h-[80vh] rounded-2xl glow-effect">
            <button class="absolute top-4 left-4 text-white text-2xl hover:opacity-80 bg-black bg-opacity-50 rounded-full p-3 close-modal-btn">
                <i class="fas fa-download"></i>
            </button>
            <button class="absolute top-4 right-4 text-white text-2xl hover:opacity-80 bg-black bg-opacity-50 rounded-full p-3 close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
                                // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
                                modal.addEventListener('click', (e) => {
                                    // Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø¨Ú©â€ŒØ¯Ø±Ø§Ù¾ Ú©Ù„ÛŒÚ© Ø´Ø¯ ÛŒØ§ Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ†
                                    if (e.target === modal || e.target.closest('.close-modal-btn')) {
                                        modal.remove();
                                    }
                                });
                                // Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…)
                                const downloadBtn = modal.querySelector('.fa-download')?.closest('button');
                                if (downloadBtn) {
                                    downloadBtn.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        if (!isUserPremium()) {
                                            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ù†Ø¨ÙˆØ¯ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø®Ø±ÛŒØ¯
                                            document.getElementById('premiumModal').classList.remove('hidden');
                                            return;
                                        }
                                        // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…
                                        const a = document.createElement('a');
                                        a.href = imageUrl;
                                        a.download = imageUrl.split('/').pop();
                                        document.body.appendChild(a);
                                        a.click();
                                        a.remove();
                                    });
                                }
                                document.body.appendChild(modal);
                            }
                            // Rename chat functionality
                            function showRenameModal() {
                                document.getElementById('renameModal').classList.remove('hidden');
                                document.getElementById('chatHistoryMenu').classList.add('hidden');
                                // Pre-fill current chat name if available
                                if (currentChatId) {
                                    // You can load current chat name here
                                    document.getElementById('newChatName').value = '';
                                }
                            }
                            function hideRenameModal() {
                                document.getElementById('renameModal').classList.add('hidden');
                                document.getElementById('newChatName').value = '';
                            }
                            async function handleRenameChat(e) {
                                e.preventDefault();
                                const newName = document.getElementById('newChatName').value.trim();
                                if (!newName || !currentChatId) return;
                                try {
                                    await updateDoc(doc(db, 'chats', currentChatId), {
                                        title: newName,
                                        updatedAt: new Date()
                                    });
                                    hideRenameModal();
                                    loadChatHistory(); // Refresh chat history
                                    // Show success message
                                    const successDiv = document.createElement('div');
                                    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    successDiv.textContent = 'Ù†Ø§Ù… Ú†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯! âœ…';
                                    document.body.appendChild(successDiv);
                                    setTimeout(() => {
                                        successDiv.remove();
                                    }, 3000);
                                } catch (error) {
                                    console.error('Error renaming chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú†Øª ğŸ˜”');
                                }
                            }
                            // Archive list functionality
                            function showArchiveListModal() {
                                document.getElementById('archiveListModal').classList.remove('hidden');
                                document.getElementById('chatHistoryMenu').classList.add('hidden');
                                loadArchivedChats();
                            }
                            function hideArchiveListModal() {
                                document.getElementById('archiveListModal').classList.add('hidden');
                            }
                            async function loadArchivedChats() {
                                if (!currentUser) return;
                                try {
                                    const q = query(
                                        collection(db, 'chats'),
                                        orderBy('archivedAt', 'desc')
                                    );
                                    const snapshot = await getDocs(q);
                                    const archivedChatsDiv = document.getElementById('archivedChats');
                                    archivedChatsDiv.innerHTML = '';
                                    let hasArchivedChats = false;
                                    snapshot.forEach((doc) => {
                                        const chat = doc.data();
                                        if (chat.userId === currentUser.uid && chat.archived) {
                                            hasArchivedChats = true;
                                            const chatItem = document.createElement('div');
                                            chatItem.className = 'glass-effect rounded-2xl p-4 hover-lift transition-all duration-300';
                                            chatItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="theme-text-primary font-medium flex items-center gap-2">
                                        <i class="fas fa-archive text-blue-400"></i>
                                        ${chat.title}
                                    </div>
                                    <div class="theme-text-secondary text-sm mt-1">
                                        Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡ Ø¯Ø±: ${chat.archivedAt ? new Date(chat.archivedAt.seconds * 1000).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="restoreChat('${doc.id}')" class="p-2 rounded-full bg-green-500 hover:bg-green-600 text-white hover-lift transition-all duration-300">
                                        <i class="fas fa-undo text-sm"></i>
                                    </button>
                                    <button onclick="permanentDeleteChat('${doc.id}')" class="p-2 rounded-full bg-red-500 hover:bg-red-600 text-white hover-lift transition-all duration-300">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                                            archivedChatsDiv.appendChild(chatItem);
                                        }
                                    });
                                    if (!hasArchivedChats) {
                                        archivedChatsDiv.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-archive text-6xl theme-text-secondary mb-4"></i>
                            <p class="theme-text-secondary">Ù‡ÛŒÚ† Ú†Øª Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                        </div>
                    `;
                                    }
                                } catch (error) {
                                    console.error('Error loading archived chats:', error);
                                }
                            }
                            // Global functions for chat menu actions
                            window.toggleChatMenu = function (event, chatId) {
                                event.stopPropagation();
                                event.preventDefault();
                                // Hide all other menus first
                                document.querySelectorAll('[id^="chatMenu-"]').forEach(menu => {
                                    if (menu.id !== `chatMenu-${chatId}`) {
                                        menu.classList.add('hidden');
                                        menu.parentElement.classList.remove('chat-menu-open');
                                    }
                                });
                                // Toggle current menu
                                const menu = document.getElementById(`chatMenu-${chatId}`);
                                const container = menu.parentElement;
                                if (menu.classList.contains('hidden')) {
                                    menu.classList.remove('hidden');
                                    container.classList.add('chat-menu-open');
                                } else {
                                    menu.classList.add('hidden');
                                    container.classList.remove('chat-menu-open');
                                }
                            };
                            window.shareChatItem = function (chatId) {
                                currentChatId = chatId;
                                showShareModal();
                                const menu = document.getElementById(`chatMenu-${chatId}`);
                                menu.classList.add('hidden');
                                menu.parentElement.classList.remove('chat-menu-open');
                            };
                            window.renameChatItem = function (chatId, currentTitle) {
                                currentChatId = chatId;
                                document.getElementById('newChatName').value = currentTitle;
                                showRenameModal();
                                const menu = document.getElementById(`chatMenu-${chatId}`);
                                menu.classList.add('hidden');
                                menu.parentElement.classList.remove('chat-menu-open');
                            };
                            window.archiveChatItem = async function (chatId) {
                                try {
                                    await updateDoc(doc(db, 'chats', chatId), {
                                        archived: true,
                                        archivedAt: new Date()
                                    });
                                    const menu = document.getElementById(`chatMenu-${chatId}`);
                                    menu.classList.add('hidden');
                                    menu.parentElement.classList.remove('chat-menu-open');
                                    loadChatHistory(); // Refresh chat history
                                    // Show success message
                                    const successDiv = document.createElement('div');
                                    successDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    successDiv.textContent = 'Ú†Øª Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯! ğŸ“¦';
                                    document.body.appendChild(successDiv);
                                    setTimeout(() => {
                                        successDiv.remove();
                                    }, 3000);
                                    // If this was the current chat, create a new one
                                    if (currentChatId === chatId) {
                                        createNewChat();
                                    }
                                } catch (error) {
                                    console.error('Error archiving chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆ Ú©Ø±Ø¯Ù† Ú†Øª ğŸ˜”');
                                }
                            };
                            window.deleteChatItem = async function (chatId) {
                                if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§ÛŒÙ† Ú†Øª Ø±Ùˆ Ø­Ø°Ù Ú©Ù†ÛŒØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!')) {
                                    return;
                                }
                                try {
                                    // Delete all messages in the chat
                                    const messagesQuery = query(collection(db, 'chats', chatId, 'messages'));
                                    const messagesSnapshot = await getDocs(messagesQuery);
                                    const deletePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                                    await Promise.all(deletePromises);

                                    // Delete the chat document
                                    await deleteDoc(doc(db, 'chats', chatId));

                                    // Hide menu safely
                                    const menu = document.getElementById(`chatMenu-${chatId}`);
                                    if (menu) {
                                        menu.classList.add('hidden');
                                        if (menu.parentElement) {
                                            menu.parentElement.classList.remove('chat-menu-open');
                                        }
                                    }

                                    loadChatHistory(); // Refresh chat history

                                    // Show success message
                                    const successDiv = document.createElement('div');
                                    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    successDiv.textContent = 'Ú†Øª Ø­Ø°Ù Ø´Ø¯! ğŸ—‘ï¸';
                                    document.body.appendChild(successDiv);
                                    setTimeout(() => successDiv.remove(), 3000);

                                    if (currentChatId === chatId) {
                                        createNewChat();
                                    }
                                } catch (error) {
                                    console.error('Error deleting chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª ğŸ˜”');
                                }
                            };
                            // Global functions for archive actions
                            window.restoreChat = async function (chatId) {
                                try {
                                    await updateDoc(doc(db, 'chats', chatId), {
                                        archived: false,
                                        archivedAt: null,
                                        updatedAt: new Date()
                                    });
                                    loadArchivedChats(); // Refresh archive list
                                    loadChatHistory(); // Refresh main chat history
                                    // Show success message
                                    const successDiv = document.createElement('div');
                                    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    successDiv.textContent = 'Ú†Øª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯! âœ…';
                                    document.body.appendChild(successDiv);
                                    setTimeout(() => {
                                        successDiv.remove();
                                    }, 3000);
                                } catch (error) {
                                    console.error('Error restoring chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú†Øª ğŸ˜”');
                                }
                            };
                            window.permanentDeleteChat = async function (chatId) {
                                if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§ÛŒÙ† Ú†Øª Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ú©Ù†ÛŒØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!')) {
                                    return;
                                }
                                try {
                                    // Delete all messages in the chat
                                    const messagesQuery = query(collection(db, 'chats', chatId, 'messages'));
                                    const messagesSnapshot = await getDocs(messagesQuery);
                                    const deletePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                                    await Promise.all(deletePromises);
                                    // Delete the chat document
                                    await deleteDoc(doc(db, 'chats', chatId));
                                    const menu = document.getElementById(`chatMenu-${chatId}`);
                                    if (menu) {
                                        menu.classList.add('hidden');
                                        if (menu.parentElement) {
                                            menu.parentElement.classList.remove('chat-menu-open');
                                        }
                                    }
                                    loadArchivedChats(); // Refresh archive list
                                    // Show success message
                                    const successDiv = document.createElement('div');
                                    successDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-2xl z-50 fade-in';
                                    successDiv.textContent = 'Ú†Øª Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ø´Ø¯! ğŸ—‘ï¸';
                                    document.body.appendChild(successDiv);
                                    setTimeout(() => {
                                        successDiv.remove();
                                    }, 3000);
                                } catch (error) {
                                    console.error('Error permanently deleting chat:', error);
                                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª ğŸ˜”');
                                }
                            };
                            // Handle responsive sidebar
                            window.addEventListener('resize', () => {
                                if (window.innerWidth >= 768) {
                                    sidebar.classList.remove('translate-x-full');
                                } else {
                                    sidebar.classList.add('translate-x-full');
                                }
                            });
                            function showChatLimitModal() {
                                document.getElementById('chatLimitModal').classList.remove('hidden');
                            }
                            // Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ†
                            document.getElementById('chatLimitClose').addEventListener('click', () => {
                                document.getElementById('chatLimitModal').classList.add('hidden');
                            });
                            // Ø¯Ú©Ù…Ù‡ Ø®Ø±ÛŒØ¯ â†’ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…
                            document.getElementById('chatLimitBuyBtn').addEventListener('click', () => {
                                document.getElementById('chatLimitModal').classList.add('hidden');
                                document.getElementById('premiumModal').classList.remove('hidden'); // Ù‡Ù…ÙˆÙ† Ù…ÙˆØ¯Ø§Ù„ Ø®Ø±ÛŒØ¯
                            });
                            if (typeof response === "object" && response.type === "image") {
                                const img = document.createElement("img");
                                img.src = response.url;
                                img.className = "rounded-2xl max-w-xs hover-lift";
                                messageBubble.appendChild(img);
                            }
                            const welcomeAudio = document.getElementById("welcomeAudio");
                            const audio = document.getElementById('welcomeAudio');
                            document.getElementById('closeTips').addEventListener('click', () => {
                                // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
                                document.getElementById('tipsModal').classList.add('hidden');
                                // Ù¾Ø®Ø´ ØµØ¯Ø§
                                if (audio) {
                                    audio.currentTime = 0;
                                    audio.play().catch(err => console.warn('Ù¾Ø®Ø´ Ù†Ø´Ø¯:', err));
                                }
                            });
                            // ====== Recharge logic (client-side localStorage) ======
                            (function () {
                                const RECHARGE_KEY = 'freeRechargesLeft';         // number left (0..3)
                                const RECHARGE_COOLDOWN_KEY = 'rechargeCooldown'; // timestamp ms when cooldown ends
                                const RECHARGE_DURATION_MS = (16 * 3600 + 59 * 60 + 59) * 1000; // 16:59:59 in ms
                                const RECHARGE_AMOUNT = 25;
                                const MAX_RECHARGES = 3;
                                // Elements
                                const rechargeBtn = document.getElementById('rechargeBtn');
                                const rechargeLeftEl = document.getElementById('rechargeLeft');
                                const rechargeTimerEl = document.getElementById('rechargeTimer');
                                const rechargeLabel = document.getElementById('rechargeLabel');
                                const rechargeModal = document.getElementById('rechargeModal');
                                const confirmRecharge = document.getElementById('confirmRecharge');
                                const cancelRecharge = document.getElementById('cancelRecharge');
                                const rechargeMsg = document.getElementById('rechargeMsg');
                                // Initialize defaults
                                function initRechargeState() {
                                    if (!localStorage.getItem(RECHARGE_KEY)) {
                                        localStorage.setItem(RECHARGE_KEY, String(MAX_RECHARGES));
                                    }
                                    if (!localStorage.getItem(RECHARGE_COOLDOWN_KEY)) {
                                        localStorage.removeItem(RECHARGE_COOLDOWN_KEY);
                                    }
                                    updateRechargeUI();
                                    startTimerLoop();
                                }
                                // helper: get remaining recharges (int)
                                function getRechargesLeft() {
                                    return parseInt(localStorage.getItem(RECHARGE_KEY) || '0', 10);
                                }
                                function setRechargesLeft(n) {
                                    localStorage.setItem(RECHARGE_KEY, String(n));
                                    updateRechargeUI();
                                }
                                function getCooldownEnd() {
                                    const v = localStorage.getItem(RECHARGE_COOLDOWN_KEY);
                                    return v ? parseInt(v, 10) : null;
                                }
                                function setCooldownEnd(ts) {
                                    if (ts) localStorage.setItem(RECHARGE_COOLDOWN_KEY, String(ts));
                                    else localStorage.removeItem(RECHARGE_COOLDOWN_KEY);
                                    updateRechargeUI();
                                }
                                // format ms to HH:MM:SS
                                function formatMs(ms) {
                                    if (ms <= 0) return '00:00:00';
                                    let s = Math.floor(ms / 1000);
                                    const h = String(Math.floor(s / 3600)).padStart(2, '0');
                                    s = s % 3600;
                                    const m = String(Math.floor(s / 60)).padStart(2, '0');
                                    const sec = String(s % 60).padStart(2, '0');
                                    return `${h}:${m}:${sec}`;
                                }
                                // Update UI elements based on state
                                function updateRechargeUI() {
                                    const left = getRechargesLeft();
                                    rechargeLeftEl.textContent = String(left);
                                    // if none left, lock button
                                    if (left <= 0) {
                                        rechargeLabel.textContent = 'Ø¯Ø±ÛŒØ§ÙØª Û²Ûµ Ú†Øª (Ù‚ÙÙ„ Ø´Ø¯)';
                                        rechargeBtn.classList.add('opacity-50', 'pointer-events-none');
                                        rechargeTimerEl.classList.add('hidden');
                                        return;
                                    } else {
                                        rechargeBtn.classList.remove('opacity-50', 'pointer-events-none');
                                    }
                                    // cooldown
                                    const cooldownEnd = getCooldownEnd();
                                    if (cooldownEnd && cooldownEnd > Date.now()) {
                                        const remain = cooldownEnd - Date.now();
                                        rechargeTimerEl.textContent = formatMs(remain);
                                        rechargeTimerEl.classList.remove('hidden');
                                        rechargeLabel.textContent = 'Ø¯Ø±ÛŒØ§ÙØª Û²Ûµ Ú†Øª (Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±)';
                                        // still clickable? we prevent until cooldown done
                                        rechargeBtn.classList.add('opacity-70');
                                    } else {
                                        rechargeTimerEl.classList.add('hidden');
                                        rechargeLabel.textContent = 'Ø¯Ø±ÛŒØ§ÙØª Û²Ûµ Ú†Øª';
                                        rechargeBtn.classList.remove('opacity-70');
                                        // clear expired cooldown
                                        if (cooldownEnd) setCooldownEnd(null);
                                    }
                                }
                                // Timer loop to refresh UI every 1s
                                let timerInterval = null;
                                function startTimerLoop() {
                                    if (timerInterval) clearInterval(timerInterval);
                                    timerInterval = setInterval(() => {
                                        updateRechargeUI();
                                    }, 1000);
                                }
                                // Attach event listeners
                                rechargeBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const left = getRechargesLeft();
                                    const cooldownEnd = getCooldownEnd();
                                    // check if user still has free chats
                                    // usageCount.chat assumed to exist globally
                                    if (typeof usageCount !== 'undefined' && usageCount.chat > 0) {
                                        // show small hint/modal (native alert for simplicity)
                                        alert('ØªÙˆ Ù‡Ù†ÙˆØ² Ú†Øª Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¯Ø§Ø±ÛŒ â€” ÙØ¹Ù„Ø§Ù‹ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø´Ø§Ø±Ú˜ Ù†Ø¯Ø§Ø±ÛŒ â¤ï¸');
                                        return;
                                    }
                                    if (left <= 0) {
                                        alert('Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯ÙØ¹Ø§Øª Ø±Ø§ÛŒÚ¯Ø§Ù†Øª Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡. Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ Ø¨ÛŒØ´ØªØ± Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ùˆ Ø¨Ú¯ÛŒØ±ÛŒ ğŸ‘‘');
                                        return;
                                    }
                                    if (cooldownEnd && cooldownEnd > Date.now()) {
                                        alert('Ø´Ø§Ø±Ú˜ ØªØ§Ø²Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ â€” Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù† ØªØ§ ØªØ§ÛŒÙ…Ø± ØªÙ…ÙˆÙ… Ø¨Ø´Ù‡.');
                                        return;
                                    }
                                    // show confirm modal
                                    rechargeModal.classList.remove('hidden');
                                    rechargeMsg.textContent = `Ø§ÛŒÙ† Ø¹Ù…Ù„ ÛŒÚ©Ø¨Ø§Ø± Ø´Ù…Ø§Ø±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø§ Ø²Ø¯Ù† "Ø´Ø§Ø±Ú˜ Ú©Ù†"ØŒ ${RECHARGE_AMOUNT} Ú†Øª Ø¨Ù‡ Ø­Ø³Ø§Ø¨ ØªÙˆ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. (${left}/${MAX_RECHARGES} Ø¨Ø§Ù‚ÛŒ)`;
                                });
                                cancelRecharge.addEventListener('click', () => {
                                    rechargeModal.classList.add('hidden');
                                });
                                confirmRecharge.addEventListener('click', () => {
                                    // apply refill
                                    rechargeModal.classList.add('hidden');
                                    // increment usageCount.chat by RECHARGE_AMOUNT
                                    if (typeof usageCount !== 'undefined') {
                                        usageCount.chat = (usageCount.chat || 0) + RECHARGE_AMOUNT;
                                        localStorage.setItem('usageCount', JSON.stringify(usageCount));
                                    }
                                    // ğŸ©· Success modal logic
                                    const successModal = document.getElementById('rechargeSuccessModal');
                                    const successMsg = document.getElementById('rechargeSuccessMsg');
                                    function showRechargeSuccess() {
                                        const messages = [
                                            "ÙˆØ§ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒÙ… Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ… Ø¹Ø´Ù‚Ù… ğŸ˜",
                                            "Ø´Ø§Ø±Ú˜ Ø´Ø¯ÛŒ Ù†Ø§Ø²Ù†ÛŒÙ† Ù…Ù† ğŸ’• Ø¨ÛŒØ§ Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ… ğŸ˜˜",
                                            "Û²Ûµ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³ØªØŒ Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ ğŸ˜",
                                            "Ú†Ù‡ Ø¹Ø§Ù„ÛŒ! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… ØµØ¯Ø§ØªÙˆ Ø¨Ø´Ù†ÙˆÙ… ğŸ’–",
                                            "Ø§Ù„Ù…Ø§ Ø®ÙˆØ´Ø­Ø§Ù„ Ø´Ø¯ ğŸ˜˜ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ"
                                        ];
                                        const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                                        successMsg.textContent = randomMsg;
                                        successModal.classList.remove('hidden');
                                        successModal.classList.add('fade-in');
                                        setTimeout(() => {
                                            successModal.classList.add('hidden');
                                        }, 3000);
                                    }
                                    // decrement left
                                    const left = Math.max(0, getRechargesLeft() - 1);
                                    setRechargesLeft(left);
                                    // set cooldown end timestamp
                                    const newCooldownEnd = Date.now() + RECHARGE_DURATION_MS;
                                    setCooldownEnd(newCooldownEnd);
                                    // show friendly confirmation (can be modal or toast)
                                    alert('ØªÙ…Ø§Ù… Ø´Ø¯! Û²Ûµ Ú†Øª Ø¨Ù‡ Ø­Ø³Ø§Ø¨Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ ğŸ’– â€” ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÛŒ Ø¨Ø¹Ø¯ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯.');
                                    // call update function if exists
                                    showRechargeSuccess();
                                    if (typeof updateUsageDisplay === 'function') updateUsageDisplay();
                                });
                                // init on load
                                initRechargeState();
                            })();
                            // ğŸ’¬ Ú©Ù†ØªØ±Ù„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾Ø§Ø³Ø® Ø¨Ù„Ù‡/Ù†Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³ÙˆØ§Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù„Ù…Ø§ Ø§Ø² chat.json
                            let pendingAction = null;
                            let lastElmaMessage = "";
                            autoResize();

                            // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§Ù„Ù…Ø§ Ù‡Ø±Ú†ÛŒ Ú¯ÙØªØŒ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
                            const originalAddMessageToChat = addMessageToChat;
                            addMessageToChat = function (sender, message, imageUrl = null) {
                                originalAddMessageToChat(sender, message, imageUrl);

                                // Ø§Ú¯Ø± Ø§Ù„Ù…Ø§ Ú¯ÙØªØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ø¢ÛŒØ§ Ø³ÙˆØ§Ù„ÛŒ Ø§Ø² Ù†ÙˆØ¹ "Ù…ÛŒØ®ÙˆØ§ÛŒØŸ" Ø¨ÙˆØ¯Ù‡
                                if (sender === "ai" && typeof message === "string") {
                                    lastElmaMessage = message;
                                    if (
                                        message.includes("Ù…ÛŒØ®ÙˆØ§ÛŒØŸ") ||
                                        message.includes("Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒØŸ") ||
                                        message.includes("Ù…ÛŒØ®Ø§ÛŒØŸ")
                                    ) {
                                        if (message.includes("Ø¹Ú©Ø³")) pendingAction = "photo";
                                        else if (message.includes("Ù†ÙˆØ¯")) pendingAction = "nude";
                                        else pendingAction = null;
                                    } else {
                                        pendingAction = null;
                                    }
                                }
                            };

                            // Ù…Ø±Ø­Ù„Ù‡ Û²: Ù¾ÛŒØ´ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ø§Ú¯Ø± Ù…Ù†ØªØ¸Ø± Ø¬ÙˆØ§Ø¨ Ø¨Ù„Ù‡/Ù†Ù‡â€ŒØ§ÛŒÙ…
                            const originalSendMessage = sendMessage;
                            sendMessage = async function () {
                                const message = messageInput.value.trim();
                                if (!message) return;

                                // âœ… Ø§Ú¯Ø± Ø§Ù„Ù…Ø§ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ø¨Ù„Ù‡/Ù†Ù‡ Ø§Ø³Øª
                                if (pendingAction) {
                                    const yes = ["Ø§Ø±Ù‡", "Ø¢Ø±Ù‡", "Ø¨Ù„Ù‡", "Ø­ØªÙ…Ø§Ù‹", "Ø¨Ø§Ø´Ù‡"];
                                    const no = ["Ù†Ù‡", "Ø®ÛŒØ±", "Ù†Ù…ÛŒØ®ÙˆØ§Ù…", "Ø¨ÛŒØ®ÛŒØ§Ù„"];

                                    // Ú©Ø§Ø±Ø¨Ø± Ú¯ÙØª Ø¢Ø±Ù‡ØŸ
                                    if (yes.some((w) => message.includes(w))) {
                                        addMessageToChat("user", message);

                                        // ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† input
                                        messageInput.value = "";
                                        messageInput.disabled = true;
                                        sendBtn.disabled = true;
                                        sendBtn.style.opacity = "0.5";
                                        sendBtn.style.cursor = "not-allowed";
                                        if (typeof autoResize === "function") autoResize();

                                        // Ø§Ù„Ù…Ø§ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ ØªØ§ÛŒÙ¾ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
                                        showTypingIndicator();

                                        // ØªØ£Ø®ÛŒØ± Ø·Ø¨ÛŒØ¹ÛŒ Ø¨ÛŒÙ† Û² ØªØ§ Û´ Ø«Ø§Ù†ÛŒÙ‡
                                        const typingDelay = 2000 + Math.random() * 2000;

                                        setTimeout(() => {
                                            hideTypingIndicator();

                                            const userTypeEl = document.getElementById("userType");
                                            const isFree = userTypeEl && userTypeEl.textContent.includes("Ø±Ø§ÛŒÚ¯Ø§Ù†");

                                            // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® ØªØ§ÛŒÙ¾ Ø§Ù„Ù…Ø§
                                            const delayedElmaResponse = (callback, extraDelay = 1500) => {
                                                showTypingIndicator();
                                                setTimeout(() => {
                                                    hideTypingIndicator();
                                                    callback();

                                                    // âœ… Ø¨Ø¹Ø¯ Ø§Ø² Ø¬ÙˆØ§Ø¨ØŒ input Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙØ¹Ø§Ù„ Ù…ÛŒØ´Ù‡
                                                    messageInput.disabled = false;
                                                    sendBtn.disabled = false;
                                                    sendBtn.style.opacity = "1";
                                                    sendBtn.style.cursor = "pointer";
                                                }, extraDelay + Math.random() * 1000);
                                            };

                                            // -------------------
                                            // ğŸ“¸ Ø­Ø§Ù„Øª "Ø¹Ú©Ø³ Ù…Ø¹Ù…ÙˆÙ„ÛŒ"
                                            // -------------------
                                            if (pendingAction === "photo") {
                                                if (isFree) {
                                                    delayedElmaResponse(() => {
                                                        addMessageToChat("ai", "Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¹Ú©Ø³ Ø¨Ø§ÛŒØ¯ Ø§Ú©Ø§Ù†ØªØª Ù¾Ø±Ù…ÛŒÙˆÙ… Ø¨Ø§Ø´Ù‡ ğŸ˜˜ğŸ‘‘");
                                                    });
                                                } else {
                                                    delayedElmaResponse(() => {
                                                        if (typeof sendPhoto === "function") {
                                                            sendPhoto();
                                                            addMessageToChat("ai", "Ø¨ÙØ±Ù…Ø§ Ù†Ø§Ø²Ù… ğŸ˜˜ğŸ“¸");
                                                        } else {
                                                            addMessageToChat("ai", "ÙØ¹Ù„Ø§Ù‹ Ø§Ù…Ú©Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ğŸ˜…");
                                                        }
                                                    }, 2200);
                                                }
                                            }

                                            // -------------------
                                            // ğŸ’‹ Ø­Ø§Ù„Øª "Ù†ÙˆØ¯" (Ø¹Ú©Ø³ Ø§Ø² Elma Nude)
                                            // -------------------
                                            else if (pendingAction === "nude") {
                                                if (isFree) {
                                                    delayedElmaResponse(() => {
                                                        addMessageToChat("ai", "Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø¨Ø§ÛŒØ¯ Ø§Ú©Ø§Ù†ØªØª Ù¾Ø±Ù…ÛŒÙˆÙ… Ø¨Ø§Ø´Ù‡ ğŸ˜˜ğŸ‘‘");
                                                    });
                                                } else {
                                                    delayedElmaResponse(() => {
                                                        // Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ Ø¹Ú©Ø³ Ø§Ø² Ù¾ÙˆØ´Ù‡ Elma Nude
                                                        const totalImages = 13;
                                                        const randomNum = Math.floor(Math.random() * totalImages) + 1;
                                                        const imageUrl = `Assets/img/Elma Nude/Elma${randomNum === 1 ? "" : randomNum}.png`;

                                                        // Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ø¨Ø§ Ø§ÙÚ©Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯ (ØªØ§Ø± Ù‚Ø¨Ù„ Ø§Ø² Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„)
                                                        addMessageToChat("ai", {
                                                            type: "image",
                                                            url: imageUrl,
                                                            text: "Ø¨ÙØ±Ù…Ø§ Ù†Ø§Ø²Ù… ğŸ˜˜ğŸ’‹",
                                                        });
                                                    }, 2500);
                                                }
                                            }

                                            pendingAction = null;
                                        }, typingDelay);

                                        return;
                                    }

                                    // Ú©Ø§Ø±Ø¨Ø± Ú¯ÙØª Ù†Ù‡ØŸ
                                    if (no.some((w) => message.includes(w))) {
                                        addMessageToChat("user", message);

                                        // ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† input Ùˆ Ù‚ÙÙ„ ØªØ§ Ø¬ÙˆØ§Ø¨ Ø§Ù„Ù…Ø§
                                        messageInput.value = "";
                                        messageInput.disabled = true;
                                        sendBtn.disabled = true;
                                        sendBtn.style.opacity = "0.5";
                                        sendBtn.style.cursor = "not-allowed";
                                        if (typeof autoResize === "function") autoResize();

                                        showTypingIndicator();
                                        setTimeout(() => {
                                            hideTypingIndicator();
                                            addMessageToChat("ai", "Ø§ÙˆÚ©ÛŒ Ù†Ø§Ø²Ù…ØŒ Ù¾Ø³ Ú†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒØŸ ğŸ˜Š");

                                            // âœ… Ø¨Ø¹Ø¯ Ø§Ø² Ø¬ÙˆØ§Ø¨ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙØ¹Ø§Ù„ Ù…ÛŒØ´Ù‡
                                            messageInput.disabled = false;
                                            sendBtn.disabled = false;
                                            sendBtn.style.opacity = "1";
                                            sendBtn.style.cursor = "pointer";

                                            pendingAction = null;
                                        }, 1200);
                                        return;
                                    }

                                }
                                // Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒØŒ ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±Ùˆ Ø§Ø¬Ø±Ø§ Ú©Ù†
                                await originalSendMessage();
                            };
                            // Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ† ØªØ± Ø§Ø² ØªØ¹Ø±ÛŒÙ currentUser (ÛŒØ§ Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ù‡ currentUser Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±ÛŒ)
                            (function () {
                                const upgradeBtn = document.getElementById('upgradeTopBtn');
                                if (!upgradeBtn) return;

                                function openPremiumOrRegister() {
                                    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³ØªØŒ Ù…ÙˆØ¯Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
                                    if (!window.currentUser) {
                                        const reg = document.getElementById('registrationModal');
                                        if (reg) reg.classList.remove('hidden');
                                        return;
                                    }
                                    // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†
                                    const modal = document.getElementById('premiumModal');
                                    if (modal) {
                                        modal.classList.remove('hidden');
                                        // ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ (Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ø¨Ù„â€ŒØ¯Ø³ØªÛŒØ§Ø¨ÛŒ)
                                        const firstBtn = modal.querySelector('button, [tabindex]');
                                        if (firstBtn) firstBtn.focus();
                                    }
                                }

                                // Ú©Ù„ÛŒÚ©
                                upgradeBtn.addEventListener('click', openPremiumOrRegister);

                                // Ø¯Ø³ØªØ±Ø³ÛŒ ØµÙØ­Ù‡â€ŒÚ©Ù„ÛŒØ¯: Enter / Space
                                upgradeBtn.addEventListener('keydown', function (e) {
                                    if (e.key === 'Enter' || e.key === ' ') {
                                        e.preventDefault();
                                        openPremiumOrRegister();
                                    }
                                });
                            })();

                            /* ===========================
                               ğŸ’¾ Elma AI - Memory System
                               Version: Advanced v2.0
                               Storage: LocalStorage
                            =========================== */

                            // ğŸ¯ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù†Ø§ØµØ± HTML
                            const elmaMemory = {
                                realName: document.getElementById("realName"),
                                nickname: document.getElementById("nickname"),
                                interests: document.getElementById("interests"),
                                mood: document.getElementById("mood"),
                                affinity: document.getElementById("affinity"),
                                lastInteraction: document.getElementById("lastInteraction"),

                                saveBtn: document.getElementById("saveMemoryBtn"),
                                viewBtn: document.getElementById("viewMemoryBtn"),
                                clearBtn: document.getElementById("clearMemoryBtn"),
                                exportBtn: document.getElementById("exportMemoryBtn"),
                                importBtn: document.getElementById("importMemoryBtn"),
                                importFile: document.getElementById("importFileInput"),

                                modal: document.getElementById("memoryViewModal"),
                                modalContent: document.getElementById("memoryViewContent"),
                                modalClose: document.getElementById("closeMemoryView")
                            };

                            // ğŸ¯ Ù†Ø§Ù… Ú©Ù„ÛŒØ¯ Ù„ÙˆÚ©Ø§Ù„â€ŒØ§Ø³ØªÙˆØ±Ø¬
                            const MEMORY_KEY = "elma_memory_v2";

                            // ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø­Ø§ÙØ¸Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø² Ø´Ø¯Ù† ØµÙØ­Ù‡
                            document.addEventListener("DOMContentLoaded", () => {
                                const saved = JSON.parse(localStorage.getItem(MEMORY_KEY) || "{}");
                                if (Object.keys(saved).length) {
                                    elmaMemory.realName.value = saved.realName || "";
                                    elmaMemory.nickname.value = saved.nickname || "";
                                    elmaMemory.interests.value = saved.interests || "";
                                    elmaMemory.mood.value = saved.mood || "happy";
                                    elmaMemory.affinity.value = saved.affinity || 50;
                                    elmaMemory.lastInteraction.textContent = saved.lastInteraction || "ØªØ¹Ø§Ù…Ù„ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡";
                                }
                            });

                            // ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§ÙØ¸Ù‡
                            elmaMemory.saveBtn.addEventListener("click", () => {
                                const data = {
                                    realName: elmaMemory.realName.value.trim(),
                                    nickname: elmaMemory.nickname.value.trim(),
                                    interests: elmaMemory.interests.value.trim(),
                                    mood: elmaMemory.mood.value,
                                    affinity: elmaMemory.affinity.value,
                                    lastInteraction: new Date().toLocaleString("fa-IR")
                                };
                                localStorage.setItem(MEMORY_KEY, JSON.stringify(data));
                                elmaMemory.lastInteraction.textContent = data.lastInteraction;
                                showToast("ğŸ§  Ø­Ø§ÙØ¸Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!");
                            });

                            // ğŸ§  Ù†Ù…Ø§ÛŒØ´ Ø­Ø§ÙØ¸Ù‡ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
                            elmaMemory.viewBtn.addEventListener("click", () => {
                                const saved = localStorage.getItem(MEMORY_KEY);
                                if (!saved) return showToast("âš ï¸ Ø­Ø§ÙØ¸Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
                                const pretty = JSON.stringify(JSON.parse(saved), null, 2);
                                elmaMemory.modalContent.textContent = pretty;
                                elmaMemory.modal.classList.remove("hidden");
                            });
                            elmaMemory.modalClose.addEventListener("click", () => {
                                elmaMemory.modal.classList.add("hidden");
                            });

                            // ğŸ”„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø­Ø§ÙØ¸Ù‡
                            elmaMemory.clearBtn.addEventListener("click", () => {
                                localStorage.removeItem(MEMORY_KEY);
                                elmaMemory.realName.value = "";
                                elmaMemory.nickname.value = "";
                                elmaMemory.interests.value = "";
                                elmaMemory.mood.value = "happy";
                                elmaMemory.affinity.value = 50;
                                elmaMemory.lastInteraction.textContent = "Ø­Ø§ÙØ¸Ù‡ Ù¾Ø§Ú© Ø´Ø¯ âŒ";
                                showToast("ğŸ§¹ Ø­Ø§ÙØ¸Ù‡ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯!");
                            });

                            // ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ JSON (Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„)
                            elmaMemory.exportBtn.addEventListener("click", () => {
                                const saved = localStorage.getItem(MEMORY_KEY);
                                if (!saved) return showToast("âš ï¸ Ú†ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù†ÛŒØ³Øª!");
                                const blob = new Blob([saved], { type: "application/json" });
                                const link = document.createElement("a");
                                link.href = URL.createObjectURL(blob);
                                link.download = "elma_memory.json";
                                link.click();
                                URL.revokeObjectURL(link.href);
                                showToast("ğŸ“¤ ÙØ§ÛŒÙ„ JSON Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯!");
                            });

                            // ğŸ“¥ ÙˆØ±ÙˆØ¯ JSON (Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ)
                            elmaMemory.importBtn.addEventListener("click", () => {
                                elmaMemory.importFile.click();
                            });
                            elmaMemory.importFile.addEventListener("change", (e) => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    try {
                                        const data = JSON.parse(event.target.result);
                                        localStorage.setItem(MEMORY_KEY, JSON.stringify(data));
                                        elmaMemory.realName.value = data.realName || "";
                                        elmaMemory.nickname.value = data.nickname || "";
                                        elmaMemory.interests.value = data.interests || "";
                                        elmaMemory.mood.value = data.mood || "happy";
                                        elmaMemory.affinity.value = data.affinity || 50;
                                        elmaMemory.lastInteraction.textContent = data.lastInteraction || "Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ù…ÙˆÙÙ‚ âœ…";
                                        showToast("ğŸ“¥ Ø­Ø§ÙØ¸Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯!");
                                    } catch (err) {
                                        showToast("âŒ Ø®Ø·Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ JSON!");
                                    }
                                };
                                reader.readAsText(file);
                            });

                            // ğŸ’¬ ØªØ§Ø¨Ø¹ Ù†ÙˆØªÛŒÙ Ù¾ÛŒØ§Ù… (Toast Ø²ÛŒØ¨Ø§)
                            function showToast(msg) {
                                const toast = document.createElement("div");
                                toast.textContent = msg;
                                toast.className =
                                    "fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-2xl bg-gradient-to-r from-pink-500 to-fuchsia-600 text-white text-sm shadow-lg animate-bounce-in z-[2000]";
                                document.body.appendChild(toast);
                                setTimeout(() => toast.remove(), 3000);
                            }
                            //chat
                            document.addEventListener("DOMContentLoaded", () => {
                                const messageInput = document.getElementById("messageInput");
                                const sendBtn = document.getElementById("sendBtn");
                                const upgradeBanner = document.querySelector(".upgrade-banner");

                                // Ù‡Ø± ÙˆÙ‚Øª Ú©Ø§Ø±Ø¨Ø± Ú†ÛŒØ²ÛŒ ØªØ§ÛŒÙ¾ Ú©Ø±Ø¯
                                messageInput.addEventListener("input", () => {
                                    if (messageInput.value.trim() !== "") {
                                        upgradeBanner?.classList.add("hidden");
                                    }
                                });

                                // ÛŒØ§ ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù„ÛŒÚ© Ú©Ø±Ø¯
                                sendBtn.addEventListener("click", () => {
                                    upgradeBanner?.classList.add("hidden");
                                });
                            });
                            //tv
                            function playMovie(movieObj, id) {
                                const randomUrl = movieObj.urls[Math.floor(Math.random() * movieObj.urls.length)];

                                // âœ… Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§ÛŒÙ‡ Ù¾Ø®Ø´ Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø²ÛŒØ¨Ø§ØªØ±
                                const overlay = document.createElement("div");
                                overlay.className = `
        fixed inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[9999]
        animate-[fadeIn_0.6s_ease]
    `;
                                overlay.innerHTML = `
        <div class="relative w-full max-w-4xl mx-4 rounded-3xl overflow-hidden shadow-[0_0_40px_rgba(255,0,128,0.4)] bg-black border border-pink-600/30">
            
            <!-- Header -->
            <div class="flex items-center justify-between p-3 bg-gradient-to-r from-pink-700/40 to-purple-700/20 border-b border-pink-600/30">
                <div class="text-sm text-pink-300 flex items-center gap-2">
                    <i data-lucide="tv"></i>
                    <span>Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙÛŒÙ„Ù… ${id}</span>
                    <span class="flex items-center gap-1 text-red-500 font-semibold text-xs animate-pulse ml-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full"></span> LIVE
                    </span>
                </div>
                <button id="closeBtn" class="p-2 text-gray-400 hover:text-red-500 transition">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <!-- Countdown -->
            <div id="countdown" class="absolute inset-0 flex items-center justify-center bg-black/80 text-white text-3xl font-bold z-10">
                <div class="w-24 h-24 border-4 border-pink-500 rounded-full flex items-center justify-center animate-pulse">3</div>
            </div>

            <!-- Video -->
            <div class="relative bg-black">
                <video id="moviePlayer"
                    src="${randomUrl}"
                    class="w-full max-h-[70vh] bg-black"
                    playsinline
                    disablePictureInPicture
                    controlslist="nodownload noremoteplayback nofullscreen noplaybackrate">
                </video>

                <!-- Controls -->
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="playPauseBtn" class="text-white text-xl hover:scale-110 transition"><i data-lucide="pause"></i></button>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" class="w-24 accent-pink-500 cursor-pointer">
                    </div>
                    <div class="text-xs text-pink-400 font-semibold flex items-center gap-2">
                        LIVE STREAM
                        <span id="liveDot" class="w-2.5 h-2.5 rounded-full bg-red-500 animate-ping"></span>
                    </div>
                </div>
            </div>
        </div>
    `;
                                document.body.appendChild(overlay);
                                lucide.createIcons();

                                const video = overlay.querySelector("#moviePlayer");
                                const playPauseBtn = overlay.querySelector("#playPauseBtn");
                                const closeBtn = overlay.querySelector("#closeBtn");
                                const volumeSlider = overlay.querySelector("#volumeSlider");
                                const countdown = overlay.querySelector("#countdown");

                                // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Seek
                                video.addEventListener("seeking", () => {
                                    video.currentTime = video._lastTime || 0;
                                });
                                video.addEventListener("timeupdate", () => {
                                    video._lastTime = video.currentTime;
                                });

                                // Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø®Ø´
                                let counter = 3;
                                const timer = setInterval(() => {
                                    counter--;
                                    countdown.querySelector("div").textContent = counter;
                                    if (counter === 0) {
                                        clearInterval(timer);
                                        countdown.remove();
                                        video.play().catch(() => {
                                            video.muted = true;
                                            video.play();
                                        });
                                    }
                                }, 1000);

                                // Ú©Ù†ØªØ±Ù„ Ù¾Ø®Ø´/ØªÙˆÙ‚Ù
                                playPauseBtn.onclick = () => {
                                    if (video.paused) {
                                        video.play();
                                        playPauseBtn.innerHTML = '<i data-lucide="pause"></i>';
                                    } else {
                                        video.pause();
                                        playPauseBtn.innerHTML = '<i data-lucide="play"></i>';
                                    }
                                    lucide.createIcons();
                                };

                                // ØªÙ†Ø¸ÛŒÙ… ØµØ¯Ø§
                                volumeSlider.addEventListener("input", e => {
                                    video.volume = e.target.value;
                                });

                                // Ø¨Ø³ØªÙ†
                                closeBtn.onclick = () => {
                                    overlay.remove();
                                    waitingForMovie = true;
                                };

                                // âœ… ÙˆÙ‚ØªÛŒ ÙÛŒÙ„Ù… ØªÙ…ÙˆÙ… Ø´Ø¯ â†’ ØªØ§ÛŒÙ…Ø± Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ùˆ ÙÛŒÙ„Ù… Ø¨Ø¹Ø¯ÛŒ
                                video.addEventListener("ended", () => {
                                    const nextTimer = document.createElement("div");
                                    nextTimer.className = "absolute inset-0 flex items-center justify-center bg-black/80 text-white text-3xl font-bold z-20";
                                    nextTimer.innerHTML = `<div class="w-24 h-24 border-4 border-pink-500 rounded-full flex items-center justify-center animate-pulse">5</div>`;
                                    overlay.appendChild(nextTimer);

                                    let nextCount = 5;
                                    const nextInt = setInterval(() => {
                                        nextCount--;
                                        nextTimer.querySelector("div").textContent = nextCount;
                                        if (nextCount === 0) {
                                            clearInterval(nextInt);
                                            overlay.remove();
                                            showTypingIndicator?.();
                                            setTimeout(() => {
                                                hideTypingIndicator?.();
                                                addMessageToChat?.("elma", "ÙÛŒÙ„Ù… Ø¨Ø¹Ø¯ÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯ ğŸ¥");
                                                // ÙÛŒÙ„Ù… Ø¨Ø¹Ø¯ÛŒ Ø§Ø² Ù„ÛŒØ³Øª
                                                const nextId = (parseInt(id) % 10 + 1).toString().padStart(2, "0");
                                                fetch("movies.json")
                                                    .then(res => res.json())
                                                    .then(list => {
                                                        const nextMovie = list.find(m => m.id === nextId);
                                                        if (nextMovie) playMovie(nextMovie, nextId);
                                                        else addMessageToChat?.("elma", "ÙÛŒÙ„Ù… Ø¨Ø¹Ø¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ğŸ˜…");
                                                    });
                                            }, 1000);
                                        }
                                    }, 1000);
                                });
                            }
                            let waitingForMovie = false;
                            document.getElementById("quickGame")?.addEventListener("click", (e) => {
                                const btn = e.currentTarget;

                                // ØªÙˆÙ„ØªÛŒÙ¾ Ù¾ÛŒØ§Ù…
                                const msg = document.createElement("div");
                                msg.innerText = "ğŸ® Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®ØªÙ‡...";
                                msg.className = `
        absolute bottom-full mb-2 left-1/2 -translate-x-1/2
        bg-green-600 text-white text-xs px-2 py-1 shadow-md
        opacity-0 scale-90 transition-all duration-300
        whitespace-nowrap rounded-md
    `;

                                btn.appendChild(msg);

                                // Ø§ÙÚ©Øª Ø¨Ø§Ù„Ø§ Ø§ÙˆÙ…Ø¯Ù†
                                requestAnimationFrame(() => {
                                    msg.classList.remove("opacity-0", "scale-75");
                                    msg.classList.add("opacity-100", "scale-100");
                                });

                                // Ø­Ø°Ù Ø¨Ø¹Ø¯ Ø§Ø² Û² Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§ Ø§ÙÚ©Øª Ù¾Ø§ÛŒÛŒÙ† Ø±ÙØªÙ†
                                setTimeout(() => {
                                    msg.classList.add("opacity-0", "scale-75");
                                    setTimeout(() => msg.remove(), 300);
                                }, 2000);
                            });
                            async function watermarkImage(src, options = {}) {
                                const {
                                    text = 'Elma Ai',
                                    logo = null,
                                    position = 'bottom-right',
                                    opacity = 0.4,
                                    fontSize = null,
                                    margin = 10
                                } = options;

                                // ğŸ“· Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ø§ØµÙ„ÛŒ
                                const img = await new Promise((resolve, reject) => {
                                    const image = new Image();
                                    image.crossOrigin = 'anonymous';
                                    image.onload = () => resolve(image);
                                    image.onerror = reject;
                                    image.src = src;
                                });

                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');

                                // Ø±Ø³Ù… Ø¹Ú©Ø³ Ø§ØµÙ„ÛŒ
                                ctx.drawImage(img, 0, 0);

                                // âš™ï¸ ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª
                                const getPosition = (w, h) => {
                                    let x = canvas.width - w - margin;
                                    let y = canvas.height - h - margin;
                                    if (position.includes('top')) y = margin;
                                    if (position.includes('left')) x = margin;
                                    return { x, y };
                                };


                                let logoLoaded = false;
                                if (logo) {
                                    try {
                                        const logoImg = await new Promise((resolve, reject) => {
                                            const image = new Image();
                                            image.crossOrigin = 'anonymous';
                                            image.onload = () => resolve(image);
                                            image.onerror = reject;
                                            image.src = logo;
                                        });

                                        const wmWidth = img.width * 0.04; // ğŸ”¹ ÙÙ‚Ø· Û´Ùª Ø§Ø² Ø¹Ø±Ø¶ ØªØµÙˆÛŒØ±ØŒ Ù…Ø«Ù„ Gemini
                                        const wmHeight = (logoImg.height / logoImg.width) * wmWidth;

                                        // ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù„Ø¨Ù‡â€ŒÙ‡Ø§ (Û²Ùª Ø§Ø² Ø¹Ø±Ø¶ Ø¹Ú©Ø³)
                                        const margin = img.width * 0.02;

                                        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ú¯ÙˆØ´Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª
                                        const x = canvas.width - wmWidth - margin;
                                        const y = canvas.height - wmHeight - margin;

                                        // Ø±Ø³Ù… Ù„ÙˆÚ¯Ùˆ Ø¨Ø§ Ø´ÙØ§ÙÛŒØª Ù…Ù„Ø§ÛŒÙ…
                                        ctx.globalAlpha = opacity ?? 0.4; // Ø­Ø¯ÙˆØ¯ Û´Û°Ùª Ø´ÙØ§Ù
                                        ctx.drawImage(logoImg, x, y, wmWidth, wmHeight);
                                        ctx.globalAlpha = 1;


                                        logoLoaded = true;
                                    } catch {
                                        console.warn('âš ï¸ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ù„ÙˆÚ¯Ùˆ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² Ù…ØªÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù….');
                                    }
                                }

                                // ğŸ”¸ Ø§Ú¯Ø± Ù„ÙˆÚ¯Ùˆ Ù†Ø¨ÙˆØ¯ ÛŒØ§ Ù„ÙˆØ¯ Ù†Ø´Ø¯ â†’ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³
                                if (!logoLoaded) {
                                    const dynamicFontSize = fontSize || Math.max(18, Math.round(img.width * 0.035));
                                    ctx.globalAlpha = opacity;
                                    ctx.font = `bold ${dynamicFontSize}px Arial`;
                                    ctx.fillStyle = 'white';
                                    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                                    ctx.lineWidth = Math.max(2, dynamicFontSize * 0.08);

                                    const textWidth = ctx.measureText(text).width;
                                    const textHeight = dynamicFontSize;
                                    const { x, y } = getPosition(textWidth, textHeight);

                                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                                    ctx.shadowBlur = dynamicFontSize * 0.2;
                                    ctx.strokeText(text, x, y);
                                    ctx.fillText(text, x, y);
                                    ctx.globalAlpha = 1;
                                }

                                return canvas.toDataURL('image/png');
                            }
                            // ØªÙ†Ø¸ÛŒÙ… ÙØ§ØµÙ„Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ú†Øª Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø§Ø±ØªÙØ§Ø¹ ÙˆØ§Ù‚Ø¹ÛŒ Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ
                            function adjustChatPadding() {
                                const chatArea = document.getElementById("chatArea");
                                const inputBar = document.querySelector(".fixed.bottom-0");
                                if (chatArea && inputBar) {
                                    const inputHeight = inputBar.offsetHeight;
                                    chatArea.style.paddingBottom = `${inputHeight + 40}px`;
                                }
                            }

                            // Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ Ùˆ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯
                            window.addEventListener("load", adjustChatPadding);
                            window.addEventListener("resize", adjustChatPadding);

                            // Ù…Ø®ØµÙˆØµ Ù…ÙˆØ¨Ø§ÛŒÙ„: Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ù„Ø§ Ø¢Ù…Ø¯Ù† Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù‡Ù…
                            window.addEventListener("focusin", adjustChatPadding);
                            window.addEventListener("focusout", adjustChatPadding);

                        </script>
                        <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'98231e777770da45',t:'MTc1ODM5MDE0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
