<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تعیین رمز عبور</title>

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg: linear-gradient(135deg, #1a002b, #3a0066);
            --card-bg: rgba(255, 255, 255, 0.15);
            --muted: #d1d1d1;
            --success: #4ade80;
            --danger: #f87171;
            --accent1: #ff66b2;
            --accent2: #8b5cf6;
            --input-bg: rgba(255, 255, 255, 0.1);
            --input-border: rgba(255, 255, 255, 0.3);
            --input-focus: rgba(133, 77, 255, 0.4);
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
            background: var(--bg);
            color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .setpass-container {
            width: 100%;
            max-width: 480px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            padding: 1.5rem;
            backdrop-filter: blur(16px);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.6);
            box-sizing: border-box;
            text-align: center;
            position: relative;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 0.6rem;
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }


        p.lead {
            color: var(--muted);
            font-size: 0.95rem;
            margin-bottom: 1.2rem;
        }

        .form-row {
            text-align: right;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            color: #f0f0f0;
            margin-bottom: 0.35rem;
            font-size: 0.95rem;
        }

        input[type="password"] {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 0.85rem;
            border-radius: 12px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: box-shadow 0.2s, border-color 0.2s;
        }

        input[type="password"]:focus {
            box-shadow: 0 6px 18px var(--input-focus);
            border-color: var(--input-focus);
        }

        .error-text,
        .field-helper {
            font-size: 0.85rem;
            margin-top: 0.35rem;
            text-align: right;
        }

        .error-text {
            color: var(--danger);
            display: none;
        }

        .field-helper {
            color: var(--muted);
            display: block;
        }

        .rules-box {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 0.9rem;
            margin-bottom: 1rem;
            text-align: right;
            font-size: 0.9rem;
            line-height: 1.6rem;
            color: #eee;
        }

        .rules-box .rule {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.2rem 0;
        }

        .rule .text {
            text-align: right;
            flex: 1;
        }

        .rule .icon {
            width: 24px;
            height: 24px;
            flex: 0 0 24px;
        }

        .valid {
            color: var(--success);
        }

        .invalid {
            color: var(--danger);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            margin-top: 0.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            font-size: 1rem;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn[disabled] {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .toast {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -14px;
            padding: 0.5rem 0.85rem;
            border-radius: 10px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .toast.success {
            background: linear-gradient(90deg, var(--success), #2ecc71);
            color: #021;
            display: flex;
        }

        .toast.error {
            background: linear-gradient(90deg, var(--danger), #f06a6a);
            color: #210;
            display: flex;
        }

        @media (max-width:480px) {
            .setpass-container {
                padding: 1rem;
                margin: 0 0.5rem;
            }

            h2 {
                font-size: 1.3rem;
            }

            input[type="password"] {
                padding: 0.75rem;
            }

            .btn {
                padding: 0.85rem;
                font-size: 0.95rem;
            }
        }
    </style>
</head>

<body>
    <div class="setpass-container" role="main" aria-labelledby="setpass-title">
        <div id="toast" class="toast" role="status" aria-live="polite"></div>

        <h2 id="setpass-title">تعیین رمز عبور</h2>
        <p class="lead">برای اینکه بتوانید بعداً با ایمیل و رمز وارد شوید، یک رمز قوی انتخاب کنید.</p>

        <div class="form-row">
            <label for="password">رمز جدید</label>
            <input id="password" type="password" autocomplete="new-password" aria-describedby="password-help" />
            <div id="password-error" class="error-text" role="alert" aria-live="assertive"></div>
        </div>

        <div class="form-row">
            <label for="confirmPassword">تکرار رمز</label>
            <input id="confirmPassword" type="password" autocomplete="new-password" aria-describedby="confirm-help" />
            <div id="confirm-error" class="error-text" role="alert" aria-live="assertive"></div>
        </div>

        <div class="rules-box" aria-hidden="false">
            <div class="rule" id="r-length">
                <div class="text">حداقل ۸ کاراکتر</div>
                <div class="icon invalid" id="i-length" aria-hidden="true"></div>
            </div>
            <div class="rule" id="r-upper">
                <div class="text">حداقل یک حرف بزرگ (A-Z)</div>
                <div class="icon invalid" id="i-upper" aria-hidden="true"></div>
            </div>
            <div class="rule" id="r-lower">
                <div class="text">حداقل یک حرف کوچک (a-z)</div>
                <div class="icon invalid" id="i-lower" aria-hidden="true"></div>
            </div>
            <div class="rule" id="r-number">
                <div class="text">حداقل یک عدد (0-9)</div>
                <div class="icon invalid" id="i-number" aria-hidden="true"></div>
            </div>
            <div class="rule" id="r-match">
                <div class="text">تکرار رمز باید یکسان باشد</div>
                <div class="icon invalid" id="i-match" aria-hidden="true"></div>
            </div>
        </div>

        <button id="setPasswordBtn" class="btn"><i data-lucide="lock"></i><span>ذخیره رمز</span></button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, EmailAuthProvider, linkWithCredential } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD_Ar1zFTBS9DDFlAflPt2IpcQ5y8EI5pE",
            authDomain: "zed-exe-48839.firebaseapp.com",
            projectId: "zed-exe-48839",
            storageBucket: "zed-exe-48839.firebasestorage.app",
            messagingSenderId: "283941493182",
            appId: "1:283941493182:web:7a9deae50c01c9feb8c1ef",
            measurementId: "G-014WZDJBSL"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const passwordEl = document.getElementById('password');
        const confirmEl = document.getElementById('confirmPassword');
        const passError = document.getElementById('password-error');
        const confirmError = document.getElementById('confirm-error');
        const toast = document.getElementById('toast');
        const btn = document.getElementById('setPasswordBtn');

        // rule icons elements
        const rules = {
            length: document.getElementById('i-length'),
            upper: document.getElementById('i-upper'),
            lower: document.getElementById('i-lower'),
            number: document.getElementById('i-number'),
            match: document.getElementById('i-match')
        };

        // helper to set icon + classes
        function setRuleState(el, ok) {
            el.innerHTML = ok ? "<i data-lucide='check-circle'></i>" : "<i data-lucide='x-circle'></i>";
            if (ok) { el.classList.remove('invalid'); el.classList.add('valid'); }
            else { el.classList.remove('valid'); el.classList.add('invalid'); }
        }

        // validate and update UI; returns boolean
        function validatePasswordUI() {
            const v = passwordEl.value;
            const c = confirmEl.value;

            const cond = {
                length: v.length >= 8,
                upper: /[A-Z]/.test(v),
                lower: /[a-z]/.test(v),
                number: /[0-9]/.test(v),
                match: v !== '' && v === c
            };

            setRuleState(rules.length, cond.length);
            setRuleState(rules.upper, cond.upper);
            setRuleState(rules.lower, cond.lower);
            setRuleState(rules.number, cond.number);
            setRuleState(rules.match, cond.match);

            lucide.createIcons(); // refresh icons
            // clear inline errors while typing
            if (passError.textContent) passError.style.display = 'none';
            if (confirmError.textContent) confirmError.style.display = 'none';

            return Object.values(cond).every(Boolean);
        }

        passwordEl.addEventListener('input', validatePasswordUI);
        confirmEl.addEventListener('input', validatePasswordUI);

        function showFieldError(fieldEl, message) {
            fieldEl.textContent = message;
            fieldEl.style.display = 'block';
            // focus the input
            if (fieldEl === passError) passwordEl.focus();
            if (fieldEl === confirmError) confirmEl.focus();
        }
        function clearFieldErrors() {
            passError.textContent = ''; passError.style.display = 'none';
            confirmError.textContent = ''; confirmError.style.display = 'none';
        }

        function showToast(type, text) {
            toast.className = 'toast ' + (type === 'success' ? 'success' : 'error');
            toast.textContent = text;
            toast.style.display = 'flex';
            // auto-hide after short time
            setTimeout(() => toast.style.display = 'none', 1800);
        }

        btn.addEventListener('click', async () => {
            clearFieldErrors();
            // validate locally first
            if (!validatePasswordUI()) {
                // find which rule failed and show under appropriate field
                const v = passwordEl.value;
                const c = confirmEl.value;
                if (v.length < 8) {
                    showFieldError(passError, 'رمز باید حداقل ۸ کاراکتر باشد.');
                    return;
                }
                if (!/[A-Z]/.test(v)) {
                    showFieldError(passError, 'رمز باید حداقل یک حرف بزرگ (A-Z) داشته باشد.');
                    return;
                }
                if (!/[a-z]/.test(v)) {
                    showFieldError(passError, 'رمز باید حداقل یک حرف کوچک (a-z) داشته باشد.');
                    return;
                }
                if (!/[0-9]/.test(v)) {
                    showFieldError(passError, 'رمز باید حداقل یک عدد داشته باشد.');
                    return;
                }
                if (v !== c) {
                    showFieldError(confirmError, 'تکرار رمز با رمز اصلی مطابقت ندارد.');
                    return;
                }
            }

            // now proceed to link credential
            const user = auth.currentUser;
            if (!user || !user.email) {
                showToast('error', 'کاربر فعالی یافت نشد — دوباره وارد شوید.');
                return;
            }

            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            try {
                const cred = EmailAuthProvider.credential(user.email, passwordEl.value.trim());
                await linkWithCredential(user, cred);
                showToast('success', 'رمز با موفقیت تنظیم شد! در حال انتقال...');
                // redirect quickly
                setTimeout(() => { window.location.href = 'index.html'; }, 700);
            } catch (err) {
                // map firebase errors to fields
                const code = err?.code || '';
                // common codes: auth/weak-password, auth/credential-already-in-use, auth/email-already-in-use
                if (code === 'auth/weak-password') {
                    showFieldError(passError, 'این رمز ضعیف است. یک رمز قوی‌تر انتخاب کنید.');
                } else if (code === 'auth/credential-already-in-use' || code === 'auth/email-already-in-use') {
                    // credential already used -> likely can't link; show general under confirm
                    showFieldError(confirmError, 'این حساب قبلاً با رمز دیگری لینک شده است یا ایمیل تکراری است.');
                } else {
                    // fallback generic error
                    showToast('error', 'خطا در تنظیم رمز: ' + (err?.message || 'نامشخص'));
                }
            } finally {
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
            }
        });

        // init icons for rule boxes
        lucide.createIcons();
        // initial rule icon fill
        validatePasswordUI();
    </script>
</body>

</html>