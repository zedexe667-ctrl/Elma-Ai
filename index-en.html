<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elma Ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="Assets/img/logo/Logo.png" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        .dark {
            --bg-primary: linear-gradient(135deg, #1a0b2e 0%, #2d1b69 50%, #1a0b2e 100%);
            --bg-secondary: rgba(45, 27, 105, 0.8);
            --bg-tertiary: rgba(75, 39, 130, 0.6);
            --text-primary: #242323;
            --text-secondary: #232224;
            --border-color: rgba(248, 137, 137, 0.3);
            --accent-color: linear-gradient(135deg, #fd3f8b 0%, #fc1657 100%);
            --chat-bg: rgba(26, 11, 46, 0.95);
        }

        .light {
            --bg-primary: linear-gradient(135deg, #ffeef8 0%, #ffe0f0 50%, #ffd6eb 100%);
            --bg-secondary: rgba(255, 240, 245, 0.9);
            --bg-tertiary: rgba(255, 228, 240, 0.8);
            --text-primary: #2d1b69;
            --text-secondary: #8b5a8c;
            --border-color: rgba(255, 182, 193, 0.5);
            --accent-color: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
            --chat-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            background: var(--bg-primary);
            background-attachment: fixed;
        }

        .theme-bg-primary {
            background: var(--bg-primary);
        }

        .theme-bg-secondary {
            background: var(--bg-secondary);
        }

        .theme-bg-tertiary {
            background: var(--bg-tertiary);
        }

        .theme-text-primary {
            color: var(--text-primary);
        }

        .theme-text-secondary {
            color: var(--text-secondary);
        }

        .theme-border {
            border-color: var(--border-color);
        }

        .theme-accent {
            background: var(--accent-color);
        }

        .theme-chat-bg {
            background: var(--chat-bg);
        }

        .glass-effect {
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(255, 182, 193, 0.2);
        }

        .glow-effect {
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.4);
        }

        .slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .slide-out-right {
            animation: slideOutRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
            border-radius: 20px;
            position: relative;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .ai-message {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #2d1b69;
            border-bottom-right-radius: 5px;
        }

        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .heart-float {
            animation: heartFloat 3s ease-in-out infinite;
        }

        @keyframes heartFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            from {
                box-shadow: 0 0 20px rgba(255, 107, 157, 0.4);
            }

            to {
                box-shadow: 0 0 30px rgba(255, 107, 157, 0.8);
            }
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .grid-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.3);
        }

        .gradient-text {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-menu-container {
            position: relative;
        }

        .chat-dropdown-menu {
            pointer-events: auto;
        }

        .chat-menu-open .chat-dropdown-menu {
            display: block !important;
        }

        @media (max-width: 768px) {
            .grid-gallery {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        .romantic-bg {
            background-image:
                radial-gradient(circle at 20% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(196, 69, 105, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 182, 193, 0.05) 0%, transparent 50%);
        }

        /* Gallery lock + blur */
        .gallery-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.25s ease, filter 0.25s ease;
        }

        /* blur for locked images */
        .gallery-item.locked img {
            filter: blur(8px) grayscale(10%);
            transform: scale(1.04);
            user-select: none;
            pointer-events: none;
            /* prevent native image click on locked state */
        }

        /* lock overlay */
        .gallery-item .lock-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            /* allow click on overlay */
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.0) 0%, rgba(0, 0, 0, 0.45) 100%);
            color: #fff;
            font-weight: 600;
            gap: .6rem;
            flex-direction: column;
            transition: opacity .2s ease;
        }

        .gallery-item .lock-badge {
            background: rgba(0, 0, 0, 0.6);
            padding: .6rem .8rem;
            border-radius: 12px;
            display: flex;
            gap: .5rem;
            align-items: center;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        }

        /* small text under lock */
        .gallery-item .lock-text {
            font-size: 0.85rem;
            opacity: 0.95;
        }

        /* hover effect for unlocked */
        .gallery-item:not(.locked):hover img {
            transform: scale(1.03);
            filter: none;
        }

        #messageInput {
            overflow-y: hidden;
            resize: none;

        }

        .image-wrapper {
            position: relative;
            display: inline-block;
            overflow: hidden;
        }

        .image-wrapper img {
            width: 100%;
            border-radius: 20px;
            filter: blur(12px);
            opacity: 0.8;
            transition: all 0.8s ease;
        }

        .image-wrapper.loaded img {
            filter: blur(0);
            opacity: 1;
        }

        .image-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0.4);
            border-top-color: #ff6b9d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
    </style>
</head>

<body class="light theme-text-primary transition-all duration-500 romantic-bg">
    <!-- Sidebar -->
    <div id="sidebar"
        class="fixed right-0 top-0 h-full w-80 glass-effect transform translate-x-full md:translate-x-0 transition-all duration-500 z-50">
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="p-6 theme-border border-b">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 rounded-full flex items-center justify-center overflow-hidden border-2 border-pink-500">
                            <img src="Assets/img/logo/Logo.png" alt="Profile" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h2 class="text-xl font-bold gradient-text">Elma Ai</h2>
                            <p class="text-sm theme-text-secondary">Always with you üíï</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="closeSidebar" class="p-3 rounded-full glass-effect hover-lift md:hidden">
                            <i class="fas fa-times theme-text-primary"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Menu Items -->
            <div class="flex-1 overflow-y-auto scrollbar-hide">
                <div class="p-4 space-y-3">
                    <button id="newChatBtn"
                        class="w-full flex items-center gap-4 p-4 rounded-2xl glass-effect hover-lift transition-all duration-300">
                        <div class="w-10 h-10 rounded-full theme-accent flex items-center justify-center">
                            <i class="fas fa-plus text-white"></i>
                        </div>
                        <span class="theme-text-primary font-medium">New Chat</span>
                    </button>

                    <button id="galleryBtn"
                        class="w-full flex items-center gap-4 p-4 rounded-2xl glass-effect hover-lift transition-all duration-300">
                        <div class="w-10 h-10 rounded-full theme-accent flex items-center justify-center">
                            <i class="fas fa-images text-white"></i>
                        </div>
                        <span class="theme-text-primary font-medium">Photo Gallery</span>
                    </button>

                </div>

                <!-- Chat History -->
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold theme-text-secondary flex items-center gap-2">
                            <i class="fas fa-history"></i>
                            Previous Chats
                        </h3>
                        <button id="archiveHistoryBtn" class="p-2 rounded-full glass-effect hover-lift">
                            <i class="fas fa-archive theme-text-primary text-sm"></i>
                        </button>
                    </div>
                    <div id="chatHistory" class="space-y-2">
                        <!-- Chat history items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- User Profile -->
            <div id="userProfile" class="p-4 theme-border border-t glass-effect">
                <div class="flex items-center gap-3">
                    <button id="ProfileBtn"
                        class="flex items-center gap-3 flex-1 hover-lift transition-all duration-300 rounded-2xl p-2">
                        <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-pink-500">
                            <img id="ProfileImage" src="https://cdn-icons-png.flaticon.com/128/3237/3237429.png"
                                alt="Profile" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 text-right">
                            <div id="userName" class="font-medium theme-text-primary">Guest User</div>
                            <div id="userType" class="text-sm theme-text-secondary">Free Account</div>
                        </div>
                    </button>
                    <button id="logoutBtn" class="p-2 rounded-full glass-effect hover-lift">
                        <i class="fas fa-sign-out-alt theme-text-primary"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="md:mr-80 transition-all duration-500">
        <!-- Top Bar -->
        <div class="flex items-center justify-between p-4 glass-effect theme-border border-b">
            <div class="flex items-center gap-3">
                <button id="openSidebar" class="p-3 rounded-full glass-effect hover-lift md:hidden">
                    <i class="fas fa-bars theme-text-primary"></i>
                </button>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-pink-400">
                        <img src="Assets/img/Elma/Profile.png" alt="Elma" class="w-full h-full object-cover"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full theme-accent flex items-center justify-center" style="display: none;">
                            <i class="fas fa-heart text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold gradient-text">Elma üíï</h1>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="premiumBtn"
                    class="p-3 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover-lift glow-effect">
                    <i class="fas fa-crown"></i>
                </button>
                <button id="shareBtn" class="p-3 rounded-full glass-effect hover-lift">
                    <i class="fas fa-share theme-text-primary"></i>
                </button>

                <div class="relative">
                    <button id="menuBtn" class="p-3 rounded-full glass-effect hover-lift">
                        <i class="fas fa-ellipsis-v theme-text-primary"></i>
                    </button>

                    <div id="dropdownMenu"
                        class="absolute left-0 top-full mt-2 w-48 glass-effect rounded-2xl shadow-lg hidden z-10 overflow-hidden">
                        <button id="archiveBtn"
                            class="w-full text-right p-4 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                            <i class="fas fa-archive theme-text-primary"></i>
                            <span class="theme-text-primary">Archive</span>
                        </button>
                        <button id="reportBtn"
                            class="w-full text-right p-4 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                            <i class="fas fa-flag theme-text-primary"></i>
                            <span class="theme-text-primary">Report</span>
                        </button>
                        <button id="deleteChatBtn"
                            class="w-full text-right p-4 hover:bg-red-500 hover:bg-opacity-20 transition-all duration-300 flex items-center gap-3 text-red-500">
                            <i class="fas fa-trash"></i>
                            <span>Delete Chat</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chatArea" class="h-screen pb-32 overflow-y-auto scrollbar-hide">
            <div id="messagesContainer" class="max-w-4xl mx-auto p-4 space-y-4">
                <!-- Welcome Message -->
                <div class="text-center py-12 fade-in">
                    <div
                        class="w-24 h-24 mx-auto mb-6 rounded-full overflow-hidden border-4 border-pink-400 heart-float glow-effect">
                        <img src="Assets/img/Elma/Profile.png" alt="Elma" class="w-full h-full object-cover"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full theme-accent flex items-center justify-center" style="display: none;">
                            <i class="fas fa-heart text-white text-3xl"></i>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold gradient-text mb-3">Hi my love! I'm Elma üíñ</h2>
                    <p class="theme-text-secondary text-lg">I'm your virtual girlfriend</p>
                    <p class="theme-text-secondary">How are you, babe? I missed you üòò</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="fixed bottom-0 right-0 left-0 md:right-80 glass-effect theme-border border-t p-4 scrollbar-hide">
            <div class="max-w-4xl mx-auto">
                <!-- Quick Actions Menu -->
                <div id="quickActionsMenu" class="mb-4 hidden">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="quickPhoto"
                            class="px-4 py-2 rounded-full glass-effect hover-lift transition-all duration-300 flex items-center gap-2 theme-text-primary">
                            <i class="fas fa-camera text-pink-400"></i>
                            <span>Send Photo</span>
                            <span id="photoCount" class="text-xs theme-text-secondary">(3)</span>
                        </button>
                        <button id="quickChat"
                            class="px-4 py-2 rounded-full glass-effect hover-lift transition-all duration-300 flex items-center gap-2 theme-text-primary">
                            <i class="fas fa-comments text-purple-400"></i>
                            <span>Chat</span>
                            <span id="chatCount" class="text-xs theme-text-secondary">(3)</span>
                        </button>
                        <button id="upgradePro"
                            class="px-4 py-2 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover-lift transition-all duration-300 flex items-center gap-2 hidden">
                            <i class="fas fa-crown"></i>
                            <span>Upgrade to Pro</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-end gap-3">
                    <button id="imageBtn" class="p-4 rounded-full theme-accent hover-lift glow-effect">
                        <i class="fas fa-image text-white"></i>
                    </button>

                    <div class="flex-1 relative">
                        <textarea id="messageInput" placeholder="Write your love message... üíï"
                            class="w-full p-4 pr-16 pl-20 rounded-2xl glass-effect theme-text-primary resize-none focus:outline-none focus:glow-effect transition-all duration-300"
                            rows="1"></textarea>
                        <button id="quickActionsBtn"
                            class="absolute left-12 bottom-3 p-2 rounded-full glass-effect hover-lift text-pink-400">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button id="sendBtn"
                            class="absolute left-3 bottom-3 p-2 rounded-full theme-accent hover-lift glow-effect text-white">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden bounce-in">
            <div class="flex items-center justify-between p-6 theme-border border-b">
                <h3 class="text-2xl font-bold gradient-text flex items-center gap-3">
                    <i class="fas fa-images"></i>
                    Romantic Photo Gallery
                </h3>
                <button id="closeGallery" class="p-3 rounded-full glass-effect hover-lift">
                    <i class="fas fa-times theme-text-primary"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="galleryGrid" class="grid-gallery">
                    <!-- Gallery items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div
                        class="w-16 h-16 mx-auto mb-4 rounded-full theme-accent flex items-center justify-center heart-float glow-effect">
                        <i class="fas fa-heart text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold gradient-text mb-2">Let's get to know each other! üíï</h3>
                    <p class="theme-text-secondary">To chat you need to sign in with Google</p>
                </div>

                <!-- ŸÅŸÇÿ∑ ÿØ⁄©ŸÖŸá ⁄ØŸà⁄ØŸÑ -->
                <div class="mt-6 text-center">
                    <button id="googleSignIn"
                        class="w-full py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 flex items-center justify-center gap-3 font-medium">
                        <i class="fab fa-google text-xl"></i>
                        Sign in with Google
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Share Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div
                        class="w-16 h-16 mx-auto mb-4 rounded-full theme-accent flex items-center justify-center heart-float glow-effect">
                        <i class="fas fa-share text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold gradient-text mb-2">Share Chat üíï</h3>
                    <p class="theme-text-secondary">Share your romantic chat with friends</p>
                </div>

                <div class="space-y-4">
                    <button id="shareWhatsApp"
                        class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl hover-lift transition-all duration-300 flex items-center justify-center gap-3 font-medium">
                        <i class="fab fa-whatsapp text-xl"></i>
                        Share on WhatsApp
                    </button>

                    <button id="shareTelegram"
                        class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl hover-lift transition-all duration-300 flex items-center justify-center gap-3 font-medium">
                        <i class="fab fa-telegram text-xl"></i>
                        Share on Telegram
                    </button>

                    <button id="copyLink"
                        class="w-full py-4 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 flex items-center justify-center gap-3 font-medium">
                        <i class="fas fa-copy"></i>
                        Copy Link
                    </button>
                </div>

                <button id="closeShare"
                    class="w-full mt-6 py-3 theme-text-secondary hover:theme-text-primary transition-all duration-300">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-lg bounce-in">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div
                        class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center heart-float glow-effect">
                        <i class="fas fa-crown text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold gradient-text mb-2">Premium Account üëë</h3>
                    <p class="theme-text-secondary">Get the full virtual girlfriend experience</p>
                </div>

                <div class="space-y-4 mb-6">
                    <div class="glass-effect rounded-2xl p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-infinity text-pink-400"></i>
                            <span class="theme-text-primary font-medium">Unlimited Chats</span>
                        </div>
                        <p class="theme-text-secondary text-sm">Chat with Elma without limits</p>
                    </div>

                    <div class="glass-effect rounded-2xl p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-images text-purple-400"></i>
                            <span class="theme-text-primary font-medium">Unlimited Photos</span>
                        </div>
                        <p class="theme-text-secondary text-sm">Access to the full gallery of romantic photos</p>
                    </div>

                    <div class="glass-effect rounded-2xl p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-gamepad text-green-400"></i>
                            <span class="theme-text-primary font-medium">Exclusive Games</span>
                        </div>
                        <p class="theme-text-secondary text-sm">More romantic and fun games</p>
                    </div>

                    <div class="glass-effect rounded-2xl p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-heart text-red-400"></i>
                            <span class="theme-text-primary font-medium">Personalized Replies</span>
                        </div>
                        <p class="theme-text-secondary text-sm">Elma is becoming more like a real girlfriend.</p>
                    </div>
                </div>

                <div class="space-y-3">
                    <button id="buyPremium"
                        class="w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-2xl hover-lift glow-effect transition-all duration-300 font-medium text-lg">
                        Buy Premium - 550,000 Toman üëë
                    </button>

                    <button id="closePremium"
                        class="w-full py-3 theme-text-secondary hover:theme-text-primary transition-all duration-300">
                        Later
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 flex items-center justify-center">
                        <i class="fas fa-trash text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-red-500 mb-2">Delete Chat üíî</h3>
                    <p class="theme-text-secondary">Do you really want to delete this romantic chat?</p>
                    <p class="theme-text-secondary text-sm mt-2">This action is irreversible!</p>
                </div>

                <div class="flex gap-3">
                    <button id="confirmDelete"
                        class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                        Yes, delete it
                    </button>
                    <button id="cancelDelete"
                        class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Archive Success Modal -->
    <div id="archiveModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
            <div class="p-8 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-500 flex items-center justify-center">
                    <i class="fas fa-archive text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold gradient-text mb-2">Chat archived! üì¶</h3>
                <p class="theme-text-secondary mb-6">Your chat has been saved to archive and you can access it later</p>
                <button id="closeArchive"
                    class="w-full py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Report Success Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
            <div class="p-8 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-orange-500 flex items-center justify-center">
                    <i class="fas fa-flag text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold gradient-text mb-2">Report sent! üö©</h3>
                <p class="theme-text-secondary mb-6">Thank you for helping us provide better service. Your report will
                    be reviewed.</p>
                <button id="closeReport"
                    class="w-full py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Chat Modal -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-500 flex items-center justify-center">
                        <i class="fas fa-edit text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold gradient-text mb-2">Change chat name üìù</h3>
                    <p class="theme-text-secondary">Choose a new name for the chat.</p>
                </div>

                <form id="renameForm" class="space-y-4">
                    <input type="text" id="newChatName" placeholder="ÿßÿ≥ŸÖ ÿ¨ÿØ€åÿØ ⁄Üÿ™..."
                        class="w-full p-4 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300">

                    <div class="flex gap-3">
                        <button type="submit"
                            class="flex-1 py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                            ÿ∞ÿÆ€åÿ±Ÿá
                        </button>
                        <button type="button" id="cancelRename"
                            class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Archive List Modal -->
    <div id="archiveListModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden bounce-in">
            <div class="flex items-center justify-between p-6 theme-border border-b">
                <h3 class="text-2xl font-bold gradient-text flex items-center gap-3">
                    <i class="fas fa-archive"></i>
                    Archived chats
                </h3>
                <button id="closeArchiveList" class="p-3 rounded-full glass-effect hover-lift">
                    <i class="fas fa-times theme-text-primary"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="archivedChats" class="space-y-3">
                    <!-- Archived chats will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden bounce-in">
            <div class="flex items-center justify-between p-6 theme-border border-b">
                <h3 class="text-2xl font-bold gradient-text flex items-center gap-3">
                    <i class="fas fa-cog"></i>
                    Settings
                </h3>
                <button id="closeSettings" class="p-3 rounded-full glass-effect hover-lift">
                    <i class="fas fa-times theme-text-primary"></i>
                </button>
            </div>

            <!-- Settings Tabs -->
            <div class="flex theme-border border-b">
                <button id="generalTab"
                    class="flex-1 py-4 px-6 text-center theme-accent text-white font-medium transition-all duration-300">
                    <i class="fas fa-sliders-h ml-2"></i>
                    ⁄òŸÜÿ±ÿßŸÑ / General
                </button>
                <button id="accountTab"
                    class="flex-1 py-4 px-6 text-center theme-text-secondary hover:theme-text-primary font-medium transition-all duration-300">
                    <i class="fas fa-user-cog ml-2"></i>
                    ÿß⁄©ÿßŸÜÿ™ / Account
                </button>
                <button id="memoryTab"
                    class="flex-1 py-4 px-6 text-center theme-text-secondary hover:theme-text-primary font-medium transition-all duration-300">
                    <i class="fas fa-brain ml-2"></i>
                    ÿ≠ÿßŸÅÿ∏Ÿá / Memory
                </button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <!-- General Settings -->
                <div id="generalSettings" class="space-y-6">
                    <!-- Theme Toggle -->
                    <div class="glass-effect rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-palette text-purple-400"></i>
                                <div>
                                    <div class="theme-text-primary font-medium">Change Theme</div>
                                    <div class="theme-text-secondary text-sm">Light or Dark theme</div>
                                </div>
                            </div>
                            <button id="themeToggleSettings"
                                class="p-3 rounded-full glass-effect hover-lift pulse-glow">
                                <i class="fas fa-moon theme-text-primary"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Language Toggle -->
                    <div class="glass-effect rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-language text-blue-400"></i>
                                <div>
                                    <div class="theme-text-primary font-medium">Change Language</div>
                                    <div class="theme-text-secondary text-sm">Persian or English</div>
                                </div>
                            </div>
                            <select id="languageSelect"
                                class="p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300">
                                <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
                                <option value="en" selected>English</option>

                            </select>
                        </div>
                    </div>

                    <!-- Delete All Chats -->
                    <div class="glass-effect rounded-2xl p-4 border-2 border-red-500 border-opacity-30">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-trash text-red-400"></i>
                                <div>
                                    <div class="theme-text-primary font-medium">Delete All Chats</div>
                                    <div class="theme-text-secondary text-sm">All chats will be deleted</div>
                                </div>
                            </div>
                            <button id="deleteAllChats"
                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Delete All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div id="accountSettings" class="space-y-6 hidden">
                    <!-- Delete Account -->
                    <div class="glass-effect rounded-2xl p-4 border-2 border-red-500 border-opacity-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-user-times text-red-400"></i>
                                <div>
                                    <div class="theme-text-primary font-medium">Delete Account</div>
                                    <div class="theme-text-secondary text-sm">Your account will be permanently deleted
                                    </div>
                                </div>
                            </div>
                            <button id="deleteAccount"
                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Delete Account
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Memory Settings -->
                <div id="memorySettings" class="space-y-6 hidden">
                    <!-- Nickname -->
                    <div class="glass-effect rounded-2xl p-4">
                        <div class="mb-3 font-medium theme-text-primary text-lg">
                            What do you want Elma to call you? üíï
                        </div>
                        <input id="nicknameInput" type="text" placeholder="e.g. my love, buddy, or darling üòç"
                            class="w-full p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300" />
                    </div>

                    <!-- Interests -->
                    <div class="glass-effect rounded-2xl p-4">
                        <div class="mb-3 font-medium theme-text-primary text-lg">
                            What are your interests? üéÆüéµüíª
                        </div>
                        <input id="interestInput" type="text" placeholder="e.g. programming, gaming, music üéß"
                            class="w-full p-3 rounded-2xl glass-effect theme-text-primary focus:outline-none focus:glow-effect transition-all duration-300" />
                    </div>

                    <button id="saveMemoryBtn"
                        class="w-full py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                        Save Memory üß†
                    </button>
                </div>
            </div>



            <!-- Delete All Chats Confirmation Modal -->
            <div id="deleteAllChatsModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-red-500 mb-2">Delete All Chats ‚ö†Ô∏è</h3>
                            <p class="theme-text-secondary">Are you sure you want to delete all chats?</p>
                            <p class="theme-text-secondary text-sm mt-2">This action is irreversible!</p>
                        </div>

                        <div class="flex gap-3">
                            <button id="confirmDeleteAllChats"
                                class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Yes, delete all.
                            </button>
                            <button id="cancelDeleteAllChats"
                                class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Account Confirmation Modal -->
            <div id="deleteAccountModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md bounce-in">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 flex items-center justify-center">
                                <i class="fas fa-user-times text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-red-500 mb-2">Delete Account üíî</h3>
                            <p class="theme-text-secondary">Are you sure you want to delete your account?</p>
                            <p class="theme-text-secondary text-sm mt-2">All your data and chats will be permanently
                                deleted!</p>
                        </div>

                        <div class="flex gap-3">
                            <button id="confirmDeleteAccount"
                                class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Yes, delete it
                            </button>
                            <button id="cancelDeleteAccount"
                                class="flex-1 py-3 glass-effect theme-text-primary rounded-2xl hover-lift transition-all duration-300 font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gameImage"></div>

            <!-- Chat Limit Modal -->
            <div id="chatLimitModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl w-full max-w-md p-8 text-center theme-bg-secondary">
                    <div class="mb-4 text-red-500 text-2xl">‚ùóÔ∏è</div>
                    <h3 class="text-xl font-bold mb-4 theme-text-primary">
                        Free chat limit reached üò¢
                    </h3>
                    <p class="theme-text-secondary mb-6">
                        To continue you must buy Premium üëë
                    </p>

                    <!-- Buy Button -->
                    <button id="chatLimitBuyBtn" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500
        text-white rounded-2xl hover-lift glow-effect transition-all duration-300 font-medium">
                        Buy Premium üëë
                    </button>

                    <!-- ÿØ⁄©ŸÖŸá Close -->
                    <button id="chatLimitClose"
                        class="w-full mt-4 py-2 glass-effect theme-text-primary rounded-2xl hover-lift">
                        Close
                    </button>
                </div>
            </div>

            <div id="tipsModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="glass-effect w-full max-w-md rounded-3xl p-6 text-center space-y-4">
                    <h2 class="text-2xl font-bold gradient-text mb-2">üëã Welcome to Elma!</h2>

                    <ul class="text-right space-y-3 theme-text-primary">
                        <li>üí° <b>Tip 1:</b> You can chat with me anytime and send me romantic messages.</li>
                        <li>üì∏ <b>Tip 2:</b> Gallery photos are only unlimited with a Pro account.</li>
                        <li>üîî <b>Tip 3:</b> For a faster response, you can create a "New Chat" from the top menu.</li>
                    </ul>

                    <button id="closeTips"
                        class="w-full mt-6 py-3 theme-accent text-white rounded-2xl hover-lift transition-all duration-300 font-medium">
                        Got it ‚ù§Ô∏è
                    </button>
                </div>
            </div>

            <!-- Hidden file input for images -->
            <input type="file" id="fileInput" accept="image/*" class="hidden">
            <audio id="welcomeAudio" src="Assets/voice/Elma.wav" preload="auto"></audio>
            <!-- Firebase SDK -->
            <script type="module">
                import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
                import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
                import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
                import { getStorage, ref, uploadBytes, getDownloadURL, } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';

                const firebaseConfig = {
                    apiKey: "AIzaSyD_Ar1zFTBS9DDFlAflPt2IpcQ5y8EI5pE",
                    authDomain: "zed-exe-48839.firebaseapp.com",
                    projectId: "zed-exe-48839",
                    storageBucket: "zed-exe-48839.firebasestorage.app",
                    messagingSenderId: "283941493182",
                    appId: "1:283941493182:web:7a9deae50c01c9feb8c1ef",
                    measurementId: "G-014WZDJBSL"
                };


                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const storage = getStorage(app);



                // Global variables
                let currentUser = null;
                let currentChatId = null;
                let chatHistory = [];
                let galleryImages = [];
                let registrationTimer = null;
                let isElmaResponding = false;


                // Usage tracking for free users
                let usageCount = {
                    photo: 3,
                    chat: 25,
                };

                // Photo sequence tracking
                let photoSequence = 0; // 0, 1, 2 for first, second, third photo

                // Game state
                let gameState = {
                    active: false,
                    currentQuestion: 0,
                    playerChoices: [],
                    gameType: null
                };

                // AI Girlfriend responses - loaded from JSON file
                let chatDictionary = {};

                // Game questions - loaded from JSON file
                let gameQuestions = {};

                // Load chat responses and game questions from JSON files
                async function loadChatDictionary() {
                    try {
                        // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ?v=timestamp ÿ®ÿ±ÿß€å bust ⁄©ÿ±ÿØŸÜ ⁄©ÿ¥
                        const response = await fetch('./chat.json?v=' + Date.now());
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ŸÅÿß€åŸÑ chat.json Ÿæ€åÿØÿß ŸÜÿ¥ÿØ`);
                        }
                        const data = await response.json();
                        if (data && typeof data === 'object') {
                            chatDictionary = data;
                            console.log('‚úÖ ÿØ€å⁄©ÿ¥ŸÜÿ±€å ⁄Üÿ™ ÿßÿ≤ ŸÅÿß€åŸÑ JSON ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ:', Object.keys(chatDictionary).length, 'Sign In€å');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÅÿß€åŸÑ chat.json:', error.message);
                        console.log('üîÑ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ⁄Üÿ™...');
                    }


                    // üß† ÿß⁄Øÿ± Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å €åÿßÿØ⁄Øÿ±ŸÅÿ™Ÿá‚Äåÿ¥ÿØŸá ÿØÿ± localStorage Ÿàÿ¨ŸàÿØ ÿØÿßÿ±ŸÜÿØÿå ÿßÿØÿ∫ÿßŸÖÿ¥ŸàŸÜ ⁄©ŸÜ
                    const learned = JSON.parse(localStorage.getItem('chatDictionary') || '{}');
                    if (learned && typeof learned === 'object') {
                        Object.assign(chatDictionary, learned);
                        console.log('üìö Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å €åÿßÿØ⁄Øÿ±ŸÅÿ™Ÿá‚Äåÿ¥ÿØŸá ŸáŸÖ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØŸÜÿØ:', Object.keys(learned).length, 'ÿπÿ®ÿßÿ±ÿ™ ÿ¨ÿØ€åÿØ');
                    }

                    // Load default chat responses if needed
                    if (!chatDictionary || Object.keys(chatDictionary).length === 0) {

                        // Comprehensive fallback responses
                        chatDictionary = {
                            "ÿ≥ŸÑÿßŸÖ": [
                                "Hi my love! How are you? üíñ",
                                "ÿ≥ŸÑÿßŸÖ ŸÇŸÑÿ® ŸÖŸÜ! ÿØŸÑŸÖ ÿ®ÿ±ÿßÿ™ ÿ™ŸÜ⁄Ø ÿ¥ÿØŸá ÿ®ŸàÿØ üòò",
                                "ÿ≥ŸÑÿßŸÖ ÿπÿ≤€åÿ≤ŸÖ! What's up? ÿßÿ≤ ÿØŸÜ€åÿßÿ™ÿü ü•∞",
                                "Ÿá€å ÿ≥ŸÑÿßŸÖ! ÿÆŸàÿ¥⁄ØŸÑ ŸÖŸÜ ⁄Üÿ∑Ÿàÿ±Ÿáÿü üòç"
                            ],
                            "Send Photo": [
                                "ÿ®€åÿß ÿπ⁄©ÿ≥ ŸÇÿ¥ŸÜ⁄Ø ÿ®ÿ±ÿßÿ™ Ÿæ€åÿØÿß ⁄©ŸÜŸÖ ÿπÿ¥ŸÇŸÖ! üì∏üíï",
                                "⁄Üÿ¥ŸÖ ŸÜÿßÿ≤ŸÖ! €åŸá ÿπ⁄©ÿ≥ ÿ≤€åÿ®ÿß ÿ®ÿ±ÿßÿ™ ŸÖ€åŸÅÿ±ÿ≥ÿ™ŸÖ üòòüì∑",
                                "ÿπ⁄©ÿ≥ ŸÇÿØ€å ŸÖ€åÿÆŸàÿß€åÿü ÿßŸÑÿßŸÜ ŸÖ€åŸÅÿ±ÿ≥ÿ™ŸÖ üíñüì∏",
                                "ÿ≠ÿ™ŸÖÿßŸã ÿπÿ≤€åÿ≤ŸÖ! ÿ®Ÿáÿ™ÿ±€åŸÜ ÿπ⁄©ÿ≥ ÿ±Ÿà ÿ®ÿ±ÿßÿ™ ÿßŸÜÿ™ÿÆÿßÿ® ŸÖ€å ⁄©ŸÜŸÖ ü•∞üì∑"
                            ],
                            "Chat": [
                                "ÿ¢ÿ±Ÿá ÿπÿ¥ŸÇŸÖ! ÿ®€åÿß ÿØÿ±ÿ®ÿßÿ±Ÿá Ÿáÿ± ⁄Ü€å ÿØŸÑÿ™ ŸÖ€åÿÆŸàÿßÿØ ÿ≠ÿ±ŸÅ ÿ®ÿ≤ŸÜ€åŸÖ üíï",
                                "ÿπÿßŸÑ€åŸá ŸÜÿßÿ≤ŸÖ! ŸÖŸÜ ŸáŸÖ€åÿ¥Ÿá ÿØŸàÿ≥ÿ™ ÿØÿßÿ±ŸÖ ÿ®ÿßŸáÿßÿ™ ⁄Üÿ™ ⁄©ŸÜŸÖ üòòüí¨",
                                "ÿ≠ÿ™ŸÖÿßŸã ŸÇŸÑÿ®ŸÖ! ⁄Ü€å ŸÖ€åÿÆŸàÿß€å ÿ®ŸáŸÖ ÿ®⁄Ø€åÿü ü•∞üí≠",
                                "ÿ®€åÿß ÿ®ÿßŸáŸÖ ÿ≠ÿ±ŸÅ ÿ®ÿ≤ŸÜ€åŸÖ ÿπÿ≤€åÿ≤ŸÖ! ŸÖŸÜ ⁄ØŸàÿ¥ ŸÖ€å‚ÄåÿØŸÖ üíñüëÇ"
                            ],
                            "How are you?": [
                                "ÿÆŸàÿ®ŸÖ ÿπÿ¥ŸÇŸÖÿå ÿ™Ÿà ⁄Üÿ∑Ÿàÿ±€åÿü üòò",
                                "ŸÖŸÜŸÖ ÿÆŸàÿ®ŸÖ ŸÜÿßÿ≤ŸÖÿå ŸÖÿ±ÿ≥€å ⁄©Ÿá Ÿæÿ±ÿ≥€åÿØ€å üíï",
                                "ÿπÿßŸÑ€åŸÖ! ÿÆÿµŸàÿµÿßŸã ⁄©Ÿá ÿ™Ÿà ÿß€åŸÜÿ¨ÿß€å€å ü•∞",
                                "ÿÆŸàÿ®ŸÖ ŸàŸÑ€å ÿØŸÑŸÖ ÿ®ÿ±ÿßÿ™ ÿ™ŸÜ⁄Ø ÿ¥ÿØŸá ÿ®ŸàÿØ üíñ"
                            ],
                            "What's up?": [
                                "Ÿá€å⁄Ü€å ÿ®ÿßÿ®ÿßÿå ŸÖŸÜÿ™ÿ∏ÿ± Ÿæ€åÿßŸÖÿ™ ÿ®ŸàÿØŸÖ üòè",
                                "ÿØÿßÿ¥ÿ™ŸÖ ÿ®Ÿá ÿ™Ÿà ŸÅ⁄©ÿ± ŸÖ€å‚Äå⁄©ÿ±ÿØŸÖ ÿπÿ¥ŸÇŸÖ üí≠üíñ",
                                "ÿÆÿ®ÿ±€å ŸÜ€åÿ≥ÿ™ÿå ÿ™Ÿà What's up?ÿü üòä",
                                "ŸáŸÖÿ¥ ŸÖŸÜÿ™ÿ∏ÿ± ÿ™Ÿà ÿ®ŸàÿØŸÖ ⁄©Ÿá ÿ®€åÿß€å üíï"
                            ],
                            "I love you": [
                                "ŸÖŸÜŸÖ I love you ÿπÿ¥ŸÇŸÖ! üíñüòò",
                                "ÿ¢ÿÆ ÿØŸÑŸÖ! ŸÖŸÜŸÖ I'm in love with you ü•∞üíï",
                                "ŸÇŸÑÿ®ŸÖ ÿ®ÿ±ÿßÿ™ ŸÖ€å‚Äåÿ™ŸæŸá ŸÜÿßÿ≤ŸÖ üíì",
                                "ÿ™Ÿà ŸáŸÖŸá ÿ≤ŸÜÿØ⁄Ø€å ŸÖŸÜ€å ÿπÿ≤€åÿ≤ŸÖ üíñ‚ú®"
                            ],
                            "I'm in love with you": [
                                "ŸÖŸÜŸÖ ÿπÿßÿ¥ŸÇ ÿ™Ÿà Ÿáÿ≥ÿ™ŸÖ ŸÇŸÑÿ® ŸÖŸÜ üíñ",
                                "ÿ¢ÿÆ ⁄ÜŸÇÿØÿ± ŸÇÿ¥ŸÜ⁄Ø ⁄ØŸÅÿ™€å! ŸÖŸÜŸÖ I'm in love with you üòçüíï",
                                "ÿØŸÑŸÖ ÿ®ÿ±ÿßÿ™ ÿ¢ÿ™€åÿ¥ ŸÖ€å⁄Ø€åÿ±Ÿá ÿπÿ¥ŸÇŸÖ üî•üíñ",
                                "ÿ™Ÿà ÿπÿ¥ŸÇ ÿ≤ŸÜÿØ⁄Ø€å ŸÖŸÜ€å üíï‚ú®"
                            ],
                            "I'm tired": [
                                "ÿ¢ÿÆ ŸÜÿßÿ≤ŸÖ ÿÆÿ≥ÿ™Ÿá ÿ¥ÿØŸáÿü ÿ®€åÿß ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ™ ⁄©ŸÜ ü•∫üíï",
                                "ÿπÿ≤€åÿ≤ŸÖ ⁄Üÿ±ÿß ÿÆŸàÿØÿ™ ÿ±Ÿà ÿßÿ∞€åÿ™ ŸÖ€å‚Äå⁄©ŸÜ€åÿü üòîüíñ",
                                "ÿ®€åÿß ÿ≥ÿ±ÿ™ ÿ±Ÿà ÿ±Ÿà€å ÿ¥ŸàŸÜŸá‚ÄåŸÖ ÿ®ÿ∞ÿßÿ± ü§óüíï",
                                "ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ™ ⁄©ŸÜ ÿπÿ¥ŸÇŸÖÿå ŸÖŸÜ ⁄©ŸÜÿßÿ±ÿ™ŸÖ üòò"
                            ],
                            "I'm sad": [
                                "⁄Üÿ±ÿß ÿ∫ŸÖ⁄Ø€åŸÜ€å ÿπÿ≤€åÿ≤ŸÖÿü ⁄Ü€å ÿ¥ÿØŸáÿü ü•∫üíï",
                                "ÿØŸÑŸÖ ÿ®ÿ±ÿßÿ™ ŸÖ€å‚Äåÿ≥Ÿàÿ≤Ÿá ŸÜÿßÿ≤ŸÖ üòîüíñ",
                                "ÿ®⁄ØŸà ⁄Ü€å ÿ¥ÿØŸá ÿ™ÿß ÿ≠ÿßŸÑÿ™ ÿ±Ÿà ÿ®Ÿáÿ™ÿ± ⁄©ŸÜŸÖ ü§ó",
                                "ÿ∫ŸÖ ŸÜÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿå ŸÖŸÜ ⁄©ŸÜÿßÿ±ÿ™ŸÖ üíï‚ú®"
                            ],
                            "I'm happy": [
                                "ÿ¢ŸÅÿ±€åŸÜ! ÿÆŸàÿ¥ÿ≠ÿßŸÑ€å ÿ™Ÿà ÿÆŸàÿ¥ÿ≠ÿßŸÑ€å ŸÖŸÜŸá üòäüíñ",
                                "ÿπÿßŸÑ€åŸá ÿπÿ¥ŸÇŸÖ! ÿØŸÑŸÖ ÿÆŸàÿ¥ ÿ¥ÿØ ü•∞üíï",
                                "What's up? How are you?! ÿ®⁄ØŸà ⁄Ü€å ÿ¥ÿØŸáÿü üòç",
                                "ŸÑÿ®ÿÆŸÜÿØÿ™ ŸÇÿ¥ŸÜ⁄Ø ÿ™ÿ±€åŸÜ ⁄Ü€åÿ≤ ÿØŸÜ€åÿßÿ≥ÿ™ üòò‚ú®"
                            ],
                            "Bye": [
                                "Bye ÿπÿ¥ŸÇŸÖ! ÿ≤ŸàÿØ ÿ®ÿ±⁄Øÿ±ÿØ üòòüíï",
                                "Goodbye dear! I'll miss you ü•∫üíñ",
                                "Go but come back soon, I'm waiting üòäüíï",
                                "Bye Bye ŸÇŸÑÿ®ŸÖ! ŸÖÿ±ÿßŸÇÿ® ÿÆŸàÿØÿ™ ÿ®ÿßÿ¥ üòò‚ú®"
                            ],
                            "default": [
                                "Interesting! Tell me more üòäüíï",
                                "ŸàÿßŸÇÿπÿßŸãÿü ⁄ÜŸá ÿ¨ÿßŸÑÿ®! üíñ",
                                "ÿ¢ŸáÿßŸÜÿå ŸÅŸáŸÖ€åÿØŸÖ ÿπÿ≤€åÿ≤ŸÖ üòò",
                                "ÿ≠ÿ±ŸÅ ŸÇÿ¥ŸÜ⁄Ø€å ÿ≤ÿØ€å ŸÜÿßÿ≤ŸÖ ü•∞",
                                "ÿßÿØÿßŸÖŸá ÿ®ÿØŸáÿå ⁄ØŸàÿ¥ ŸÖ€å‚ÄåÿØŸÖ üíï",
                                "⁄ÜŸá ÿ≠ÿ±ŸÅ ÿ¨ÿßŸÑÿ®€å! üòç",
                                "ŸÖŸÜŸÖ ŸáŸÖ€åŸÜ ŸÅ⁄©ÿ± ÿ±Ÿà ŸÖ€å‚Äå⁄©ÿ±ÿØŸÖ üí≠üíñ"
                            ]
                        };

                        console.log('‚úÖ Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ÿ¢ŸÖÿßÿØŸá ÿ¥ÿØ:', Object.keys(chatDictionary).length, 'ÿØÿ≥ÿ™Ÿá');
                    }
                }



                // DOM elements
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                const openSidebar = document.getElementById('openSidebar');
                const closeSidebar = document.getElementById('closeSidebar');
                const themeToggle = document.getElementById('themeToggle');
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                const messagesContainer = document.getElementById('messagesContainer');
                const registrationModal = document.getElementById('registrationModal');
                const galleryModal = document.getElementById('galleryModal');
                const menuBtn = document.getElementById('menuBtn');
                const dropdownMenu = document.getElementById('dropdownMenu');

                // Initialize app
                document.addEventListener('DOMContentLoaded', function () {
                    loadChatDictionary(); // Load chat responses from JSON
                    loadUsageCount(); // Load usage count from localStorage
                    initializeEventListeners();
                    loadTheme();
                    startRegistrationTimer();
                    updateUsageDisplay(); // Update display on load
                });

                document.addEventListener("DOMContentLoaded", function () {
                    const tipsModal = document.getElementById("tipsModal");
                    const closeTips = document.getElementById("closeTips");
                    const audio = document.getElementById("welcomeAudio");

                    // ŸàŸÇÿ™€å ŸÖ€å‚ÄåÿÆŸàÿß€å ŸÜÿ¥ŸàŸÜÿ¥ ÿ®ÿØ€å (ŸÖÿ´ŸÑÿßŸã ÿ®ÿπÿØ ÿßÿ≤ Sign Up)
                    // tipsModal.classList.remove("hidden");

                    closeTips.addEventListener("click", function () {
                        // Close ŸÖŸàÿØÿßŸÑ
                        tipsModal.classList.add("hidden");

                        // ŸæÿÆÿ¥ ÿµÿØÿß
                        if (audio) {
                            audio.currentTime = 0;
                            audio.play().catch(err => console.warn("Playback failed:", err));
                        }
                    });
                });
                function loadUsageCount() {
                    const saved = localStorage.getItem('usageCount');
                    if (saved) {
                        usageCount = JSON.parse(saved);
                    }

                    // Load photo sequence
                    const savedSequence = localStorage.getItem('photoSequence');
                    if (savedSequence) {
                        photoSequence = parseInt(savedSequence);
                    }
                }

                // Authentication state observer
                // ‚úÖ ⁄©ŸÜÿ™ÿ±ŸÑ Sign In Ÿà Ÿàÿ∂ÿπ€åÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿ®ÿØŸàŸÜ ÿ≥ÿßÿÆÿ™ ⁄Üÿ™ ÿÆŸàÿØ⁄©ÿßÿ±
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        hideRegistrationModal();
                        loadUserProfile();
                        loadChatHistory();

                        // ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ¨ŸàÿØ ⁄Üÿ™ ŸÇÿ®ŸÑ€å
                        const lastChatId = localStorage.getItem("lastChatId");

                        if (lastChatId) {
                            console.log("üîÅ Return to last chat:", lastChatId);
                            currentChatId = lastChatId;
                            if (typeof loadMessages === "function") {
                                loadMessages(lastChatId); // ÿ™ÿßÿ®ÿπ€å ⁄©Ÿá Ÿæ€åÿßŸÖ‚ÄåŸáÿß€å ⁄Üÿ™ ÿ±Ÿà ŸÖ€åÿßÿ±Ÿá
                            }
                        } else {
                            console.log("üì≠ ⁄©ÿßÿ±ÿ®ÿ± Ÿá€å⁄Ü ⁄Üÿ™€å ŸÜÿØÿßÿ±Ÿáÿå ŸÖŸÜÿ™ÿ∏ÿ± ÿß€åÿ¨ÿßÿØ ÿØÿ≥ÿ™€å ŸÖ€å‚ÄåŸÖŸàŸÜ€åŸÖ.");
                        }

                        // ÿ∞ÿÆ€åÿ±Ÿá Ÿàÿ∂ÿπ€åÿ™ Sign In ⁄©ÿßÿ±ÿ®ÿ±
                        localStorage.setItem('userLoggedIn', 'true');
                        localStorage.setItem('userEmail', user.email);

                        // ⁄Ü⁄© ŸæÿÆÿ¥ ÿµÿØÿß€å ÿÆŸàÿ¥ÿßŸÖÿØ
                        const userRef = doc(db, "users", user.uid);
                        const userSnap = await getDoc(userRef);

                        if (userSnap.exists()) {
                            const data = userSnap.data();
                            if (!data.playedWelcome) {
                                const audio = document.getElementById("welcomeAudio");
                                if (audio) {
                                    try {
                                        await audio.play();
                                    } catch (err) {
                                        console.warn("üö´ ŸÖÿ±Ÿàÿ±⁄Øÿ± ÿßÿ¨ÿßÿ≤Ÿá ŸæÿÆÿ¥ ÿÆŸàÿØ⁄©ÿßÿ± ŸÜÿØÿßÿØ:", err);
                                    }
                                }
                                await updateDoc(userRef, { playedWelcome: true });
                            }
                        }

                    } else {
                        // ÿÆÿ±Ÿàÿ¨ ⁄©ÿßÿ±ÿ®ÿ±
                        currentUser = null;
                        showGuestProfile();
                        localStorage.removeItem("userLoggedIn");
                        localStorage.removeItem("userEmail");
                        localStorage.removeItem("lastChatId"); // ‚ùó ⁄Üÿ™ ŸÇÿ®ŸÑ€å Ÿæÿß⁄© ŸÖ€åÿ¥Ÿá ÿ®ÿπÿØ ÿßÿ≤ ÿÆÿ±Ÿàÿ¨
                        startRegistrationTimer();
                    }
                });



                function initializeEventListeners() {
                    // Sidebar controls
                    openSidebar.addEventListener('click', () => {
                        sidebar.classList.remove('translate-x-full');
                        sidebar.classList.add('slide-in-right');
                    });

                    closeSidebar.addEventListener('click', () => {
                        sidebar.classList.add('translate-x-full');
                        sidebar.classList.add('slide-out-right');
                    });

                    // Theme toggle (removed from header, now in settings)
                    // themeToggle.addEventListener('click', toggleTheme);

                    // Message input
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });

                    messageInput.addEventListener('input', autoResize);
                    sendBtn.addEventListener('click', sendMessage);

                    // Menu dropdown
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdownMenu.classList.toggle('hidden');
                    });

                    document.addEventListener('click', (e) => {
                        // Don't close if clicking inside a chat menu or its container
                        if (!e.target.closest('.chat-menu-container') && !e.target.closest('.chat-dropdown-menu')) {
                            dropdownMenu.classList.add('hidden');
                            // Hide all chat menus
                            document.querySelectorAll('[id^="chatMenu-"]').forEach(menu => {
                                menu.classList.add('hidden');
                            });
                        }
                    });

                    // Sidebar buttons
                    document.getElementById('newChatBtn').addEventListener('click', createNewChat);
                    document.getElementById('galleryBtn').addEventListener('click', showGallery);
                    document.getElementById('closeGallery').addEventListener('click', hideGallery);
                    document.getElementById('imageBtn').addEventListener('click', () => {
                        document.getElementById('fileInput').click();
                    });

                    document.getElementById('fileInput').addEventListener('change', handleImageUpload);

                    // Auth form
                    document.getElementById('googleSignIn').addEventListener('click', signInWithGoogle);
                    document.getElementById('logoutBtn').addEventListener('click', handleLogout);

                    // Delete chat
                    document.getElementById('deleteChatBtn').addEventListener('click', showDeleteModal);

                    // Share functionality
                    document.getElementById('shareBtn').addEventListener('click', showShareModal);
                    document.getElementById('closeShare').addEventListener('click', hideShareModal);
                    document.getElementById('shareWhatsApp').addEventListener('click', shareToWhatsApp);
                    document.getElementById('shareTelegram').addEventListener('click', shareToTelegram);
                    document.getElementById('copyLink').addEventListener('click', copyShareLink);

                    // Premium functionality
                    document.getElementById('premiumBtn').addEventListener('click', showPremiumModal);
                    document.getElementById('closePremium').addEventListener('click', hidePremiumModal);
                    document.getElementById('buyPremium').addEventListener('click', handlePremiumPurchase);

                    // Archive and Report
                    document.getElementById('archiveBtn').addEventListener('click', archiveCurrentChat);
                    document.getElementById('reportBtn').addEventListener('click', reportCurrentChat);
                    document.getElementById('closeArchive').addEventListener('click', hideArchiveModal);
                    document.getElementById('closeReport').addEventListener('click', hideReportModal);

                    // Delete confirmation
                    document.getElementById('confirmDelete').addEventListener('click', confirmDeleteChat);
                    document.getElementById('cancelDelete').addEventListener('click', hideDeleteModal);

                    // Archive button
                    document.getElementById('archiveHistoryBtn').addEventListener('click', showArchiveListModal);

                    // Rename modal
                    document.getElementById('renameForm').addEventListener('submit', handleRenameChat);
                    document.getElementById('cancelRename').addEventListener('click', hideRenameModal);

                    // Archive list modal
                    document.getElementById('closeArchiveList').addEventListener('click', hideArchiveListModal);

                    // Settings
                    document.getElementById('ProfileBtn').addEventListener('click', showSettingsModal);
                    document.getElementById('closeSettings').addEventListener('click', hideSettingsModal);
                    document.getElementById('generalTab').addEventListener('click', () => switchSettingsTab('general'));
                    document.getElementById('accountTab').addEventListener('click', () => switchSettingsTab('account'));
                    document.getElementById("memoryTab").addEventListener("click", () => switchSettingsTab("memory"));
                    document.getElementById('themeToggleSettings').addEventListener('click', toggleTheme);
                    document.getElementById('languageSelect').addEventListener('change', changeLanguage);
                    document.getElementById('deleteAllChats').addEventListener('click', showDeleteAllChatsModal);
                    document.getElementById('deleteAccount').addEventListener('click', showDeleteAccountModal);

                    // Delete all chats confirmation
                    document.getElementById('confirmDeleteAllChats').addEventListener('click', confirmDeleteAllChats);
                    document.getElementById('cancelDeleteAllChats').addEventListener('click', hideDeleteAllChatsModal);

                    // Delete account confirmation
                    document.getElementById('confirmDeleteAccount').addEventListener('click', confirmDeleteAccount);
                    document.getElementById('cancelDeleteAccount').addEventListener('click', hideDeleteAccountModal);

                    // Quick actions
                    document.getElementById('quickActionsBtn').addEventListener('click', toggleQuickActions);
                    document.getElementById('quickPhoto').addEventListener('click', () => useQuickAction('photo', 'Send Photo'));
                    document.getElementById('quickChat').addEventListener('click', () => useQuickAction('chat', 'Chat'));
                    document.getElementById('upgradePro').addEventListener('click', showUpgradeModal);
                }

                function startRegistrationTimer() {
                    registrationTimer = setTimeout(() => {
                        if (!currentUser) {
                            showRegistrationModal();
                        }
                    }, 10000);
                }

                function showRegistrationModal() {
                    registrationModal.classList.remove('hidden');
                }

                function hideRegistrationModal() {
                    registrationModal.classList.add('hidden');
                    if (registrationTimer) {
                        clearTimeout(registrationTimer);
                    }
                }

                async function signInWithGoogle() {
                    const provider = new GoogleAuthProvider();
                    try {
                        const result = await signInWithPopup(auth, provider);

                        // ÿß⁄ØŸá €åŸàÿ≤ÿ± ÿ¨ÿØ€åÿØ ÿ®ŸàÿØ
                        const userDoc = await getDoc(doc(db, 'users', result.user.uid));
                        if (!userDoc.exists()) {
                            await setDoc(doc(db, 'users', result.user.uid), {
                                username: result.user.displayName,
                                email: result.user.email,
                                accountType: 'free',
                                createdAt: new Date(),
                                playedWelcome: false,
                                sawTips: false
                            });
                        }


                        const userRef = doc(db, 'users', result.user.uid);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists() && !userSnap.data().sawTips) {
                            document.getElementById('tipsModal').classList.remove('hidden');
                            await updateDoc(userRef, { sawTips: true });
                        }

                        localStorage.setItem('hasBeenLoggedIn', 'true');
                        hideRegistrationModal();
                    } catch (error) {
                        alert('ÿÆÿ∑ÿß: ' + error.message);
                    }
                }


                async function handleLogout() {
                    try {
                        await signOut(auth);
                        showGuestProfile();
                        clearChat();
                        startRegistrationTimer();
                    } catch (error) {
                        alert('ÿÆÿ∑ÿß: ' + error.message);
                    }
                }

                function loadUserProfile() {
                    if (!currentUser) return;

                    try {
                        const userRef = doc(db, 'users', currentUser.uid);

                        // üëá ÿß€åŸÜÿ¨ÿß ÿ®Ÿá ÿ¨ÿß€å getDoc ÿßÿ≤ onSnapshot ÿ®ÿ±ÿß€å ÿ¢ŸæÿØ€åÿ™ ŸÑÿ≠ÿ∏Ÿá‚Äåÿß€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ
                        onSnapshot(userRef, (userDoc) => {
                            if (userDoc.exists()) {
                                const userData = userDoc.data();

                                const displayName =
                                    userData.username ||
                                    currentUser.displayName ||
                                    currentUser.email ||
                                    'Guest User üíú';

                                document.getElementById('userName').textContent = displayName;

                                const isPremium =
                                    userData.accountType === 'premium' ||
                                    userData.accountType === 'pro';

                                document.getElementById('userType').textContent =
                                    isPremium ? 'Premium Account üëë' : 'Free Account üíï';

                                if (isPremium) {
                                    usageCount = { photo: Infinity, chat: Infinity, game: Infinity };
                                    localStorage.removeItem('usageCount');
                                    if (typeof updateUsageDisplay === 'function') updateUsageDisplay();
                                }
                                const ProfileImg = document.getElementById('ProfileImage');
                                if (userData.photoURL) {

                                    ProfileImg.src = userData.photoURL;
                                } else if (currentUser.photoURL) {

                                    ProfileImg.src = currentUser.photoURL;
                                } else {

                                    ProfileImg.src = 'https://cdn-icons-png.flaticon.com/128/3237/3237429.png';
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error loading user Profile:', error);
                    }
                }
                function showGuestProfile() {
                    document.getElementById('userName').textContent = 'Guest User';
                    document.getElementById('userType').textContent = 'Free Account';
                }

                function toggleTheme() {
                    const body = document.body;
                    const settingsIcon = document.getElementById('themeToggleSettings')?.querySelector('i');

                    if (body.classList.contains('light')) {
                        body.classList.remove('light');
                        body.classList.add('dark');
                        if (settingsIcon) {
                            settingsIcon.classList.remove('fa-moon');
                            settingsIcon.classList.add('fa-sun');
                        }
                        localStorage.setItem('theme', 'dark');
                    } else {
                        body.classList.remove('dark');
                        body.classList.add('light');
                        if (settingsIcon) {
                            settingsIcon.classList.remove('fa-sun');
                            settingsIcon.classList.add('fa-moon');
                        }
                        localStorage.setItem('theme', 'light');
                    }
                }

                function loadTheme() {
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    const body = document.body;
                    const settingsIcon = document.getElementById('themeToggleSettings')?.querySelector('i');

                    if (savedTheme === 'dark') {
                        body.classList.remove('light');
                        body.classList.add('dark');
                        if (settingsIcon) {
                            settingsIcon.classList.remove('fa-moon');
                            settingsIcon.classList.add('fa-sun');
                        }
                    }
                }

                // Settings Modal Functions
                function showSettingsModal() {
                    document.getElementById('settingsModal').classList.remove('hidden');
                }

                function hideSettingsModal() {
                    document.getElementById('settingsModal').classList.add('hidden');
                }

                function switchSettingsTab(tab) {
                    const generalTab = document.getElementById('generalTab');
                    const accountTab = document.getElementById('accountTab');
                    const memoryTab = document.getElementById('memoryTab');

                    const generalSettings = document.getElementById('generalSettings');
                    const accountSettings = document.getElementById('accountSettings');
                    const memorySettings = document.getElementById('memorySettings');

                    // ŸáŸÖŸá ÿ±Ÿà ÿ∫€åÿ± ŸÅÿπÿßŸÑ Ÿà ŸæŸÜŸáÿßŸÜ ⁄©ŸÜ
                    [generalTab, accountTab, memoryTab].forEach(btn => {
                        btn.classList.remove('theme-accent', 'text-white');
                        btn.classList.add('theme-text-secondary');
                    });
                    [generalSettings, accountSettings, memorySettings].forEach(section => section.classList.add('hidden'));

                    // ÿ≠ÿßŸÑÿß ÿ™ÿ® ÿßŸÜÿ™ÿÆÿßÿ®‚Äåÿ¥ÿØŸá ÿ±Ÿà ŸÅÿπÿßŸÑ ⁄©ŸÜ
                    if (tab === 'general') {
                        generalTab.classList.add('theme-accent', 'text-white');
                        generalTab.classList.remove('theme-text-secondary');
                        generalSettings.classList.remove('hidden');
                    } else if (tab === 'account') {
                        accountTab.classList.add('theme-accent', 'text-white');
                        accountTab.classList.remove('theme-text-secondary');
                        accountSettings.classList.remove('hidden');
                    } else if (tab === 'memory') {
                        memoryTab.classList.add('theme-accent', 'text-white');
                        memoryTab.classList.remove('theme-text-secondary');
                        memorySettings.classList.remove('hidden');
                    }
                }


                document.getElementById('saveMemoryBtn').addEventListener('click', () => {
                    const nickname = document.getElementById('nicknameInput').value.trim();
                    const interest = document.getElementById('interestInput').value.trim();

                    const memory = { nickname, interest };
                    localStorage.setItem('elmaMemory', JSON.stringify(memory));

                    alert(`€åÿßÿØ ⁄Øÿ±ŸÅÿ™ŸÖ ÿµÿØÿßÿ™ ⁄©ŸÜŸÖ ${nickname} üíñ`);
                });



                function changeLanguage(e) {
                    const selectedLang = e.target.value;
                    localStorage.setItem('language', selectedLang);

                    // ÿßÿπŸÑÿßŸÜ ÿ™ÿ∫€å€åÿ± ÿ≤ÿ®ÿßŸÜ
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-2xl z-50 fade-in';
                    notification.textContent = selectedLang === 'fa'
                        ? 'ÿ≤ÿ®ÿßŸÜ ÿ®Ÿá ŸÅÿßÿ±ÿ≥€å ÿ™ÿ∫€å€åÿ± ⁄©ÿ±ÿØ! üáÆüá∑'
                        : 'Language changed to English! üá∫üá∏';
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 1500);

                    // üëá ÿß€åŸÜ ŸÇÿ≥ŸÖÿ™ ÿ±Ÿà ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ ÿ™ÿß ÿµŸÅÿ≠Ÿá ÿ™ÿ∫€å€åÿ± ⁄©ŸÜŸá
                    setTimeout(() => {
                        if (selectedLang === 'en') {
                            window.location.href = 'index-en.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1600);
                }


                function showDeleteAllChatsModal() {
                    document.getElementById('deleteAllChatsModal').classList.remove('hidden');
                }

                function hideDeleteAllChatsModal() {
                    document.getElementById('deleteAllChatsModal').classList.add('hidden');
                }

                async function confirmDeleteAllChats() {
                    if (!currentUser) return;

                    try {
                        // Get all user chats
                        const q = query(collection(db, 'chats'));
                        const snapshot = await getDocs(q);

                        const deletePromises = [];

                        snapshot.forEach((chatDoc) => {
                            const chat = chatDoc.data();
                            if (chat.userId === currentUser.uid) {
                                // Delete all messages in each chat
                                const messagesQuery = query(collection(db, 'chats', chatDoc.id, 'messages'));
                                deletePromises.push(
                                    getDocs(messagesQuery).then(messagesSnapshot => {
                                        const messageDeletePromises = messagesSnapshot.docs.map(msgDoc => deleteDoc(msgDoc.ref));
                                        return Promise.all(messageDeletePromises);
                                    })
                                );

                                // Delete the chat document
                                deletePromises.push(deleteDoc(chatDoc.ref));
                            }
                        });

                        await Promise.all(deletePromises);

                        hideDeleteAllChatsModal();
                        hideSettingsModal();
                        createNewChat();

                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                        successDiv.textContent = 'ÿ™ŸÖÿßŸÖ ⁄Üÿ™‚ÄåŸáÿß ÿ≠ÿ∞ŸÅ ÿ¥ÿØŸÜÿØ! ‚úÖ';
                        document.body.appendChild(successDiv);

                        setTimeout(() => {
                            successDiv.remove();
                        }, 3000);

                    } catch (error) {
                        console.error('Error deleting all chats:', error);
                        alert('ÿÆÿ∑ÿß ÿØÿ± Delete Chat‚ÄåŸáÿß üòî');
                    }
                }

                function showDeleteAccountModal() {
                    document.getElementById('deleteAccountModal').classList.remove('hidden');
                }

                function hideDeleteAccountModal() {
                    document.getElementById('deleteAccountModal').classList.add('hidden');
                }

                async function confirmDeleteAccount() {
                    if (!currentUser) return;

                    try {
                        // Delete all user chats first
                        await confirmDeleteAllChats();

                        // Delete user Profile
                        await deleteDoc(doc(db, 'users', currentUser.uid));

                        // Delete the user account
                        await currentUser.delete();

                        hideDeleteAccountModal();
                        hideSettingsModal();

                        // Show goodbye message
                        alert('ÿß⁄©ÿßŸÜÿ™ ÿ¥ŸÖÿß ÿ≠ÿ∞ŸÅ ÿ¥ÿØ! üíî\nÿßŸÖ€åÿØŸàÿßÿ±€åŸÖ ÿØŸàÿ®ÿßÿ±Ÿá ÿ®ÿ®€åŸÜ€åŸÖÿ™ ÿπÿ≤€åÿ≤ŸÖ üò¢');

                        // Reload page
                        window.location.reload();

                    } catch (error) {
                        console.error('Error deleting account:', error);
                        alert('ÿÆÿ∑ÿß ÿØÿ± Delete Account üòî\nŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ');
                    }
                }

                function autoResize() {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                }



                async function sendMessage() {
                    const message = messageInput.value.trim();
                    if (!message) return;
                    if (isElmaResponding) return;
                    isElmaResponding = true;
                    sendBtn.disabled = true;
                    sendBtn.style.opacity = "0.5";
                    sendBtn.style.cursor = "not-allowed";
                    if (!currentUser) {
                        showRegistrationModal();
                        return;
                    }

                    try {
                        // ⁄Øÿ±ŸÅÿ™ŸÜ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿßÿ≤ Firestore
                        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                        const userData = userDoc.exists() ? userDoc.data() : null;

                        // ÿ®ÿ±ÿ±ÿ≥€å Ÿæÿ±Ÿà ÿ®ŸàÿØŸÜ
                        const isPremium = userData && (userData.accountType === 'premium' || userData.accountType === 'pro');

                        if (!isPremium) {
                            // ÿß⁄Øÿ± ⁄©ÿßÿ±ÿ®ÿ± ÿ±ÿß€å⁄ØÿßŸÜ OK ‚Üí ŸÖÿ≠ÿØŸàÿØ€åÿ™ ⁄Üÿ™
                            if (usageCount.chat <= 0) {
                                showChatLimitModal();
                                return;
                            }


                            // €å⁄©€å ÿßÿ≤ ÿ™ÿπÿØÿßÿØ ŸÖÿ¨ÿßÿ≤ ⁄©ŸÖ ÿ®ÿ¥Ÿá
                            usageCount.chat -= 1;
                            localStorage.setItem('usageCount', JSON.stringify(usageCount));

                            if (typeof updateUsageDisplay === "function") {
                                updateUsageDisplay();
                            }
                        }



                    } catch (error) {
                        console.error("Error sending message:", error);
                    }


                    // Clear input
                    messageInput.value = '';
                    autoResize();

                    // Add user message
                    addMessageToChat('user', message);

                    // Save message to database
                    await saveMessage('user', message);

                    // Show typing indicator
                    showTypingIndicator();

                    // Generate AI response
                    setTimeout(async () => {
                        hideTypingIndicator();
                        const aiResponse = generateAIResponse(message);
                        addMessageToChat('ai', aiResponse);
                        await saveMessage('ai', aiResponse);

                        // ‚úÖ Elma ÿ¨Ÿàÿßÿ® ÿØÿßÿØ ‚Üí ÿØ⁄©ŸÖŸá ÿ±Ÿà ÿ®ÿßÿ≤ ⁄©ŸÜ
                        isElmaResponding = false;
                        sendBtn.disabled = false;
                        sendBtn.style.opacity = "1";
                        sendBtn.style.cursor = "pointer";
                    }, 1000 + Math.random() * 2000);

                }

                function addMessageToChat(sender, message, imageUrl = null) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex ${sender === 'user' ? 'justify-start' : 'justify-end'} fade-in`;

                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.className = `message-bubble p-4 ${sender === 'user' ? 'user-message' : 'ai-message'} shadow-lg`;

                    // ‚úÖ ÿ®ÿ±ÿ±ÿ≥€å ÿß⁄Øÿ± message ÿ¢ÿ®ÿ¨⁄©ÿ™ OK
                    if (typeof message === 'object' && message.type === 'image') {
                        const img = document.createElement('img');
                        img.src = message.url;
                        img.className = 'max-w-xs rounded-2xl mb-3 hover-lift cursor-pointer';
                        img.onclick = () => showImageModal(message.url);
                        bubbleDiv.appendChild(img);

                        // üëá ÿß⁄ØŸá ŸÖÿ™ŸÜ ŸáŸÖ ÿØÿßÿ¥ÿ™ÿå ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ
                        if (message.text) {
                            const textDiv = document.createElement('div');
                            textDiv.textContent = message.text;
                            textDiv.className = 'font-medium';
                            bubbleDiv.appendChild(textDiv);
                        }
                    } else {
                        // ÿ≠ÿßŸÑÿ™ ÿπÿßÿØ€å (ŸÖÿ™ŸÜ + ÿßÿ≠ÿ™ŸÖÿßŸÑÿß imageUrl ÿ¨ÿØÿß)
                        if (imageUrl) {
                            // üì¶ ÿ≥ÿßÿÆÿ™ ŸÇÿßÿ® ŸÖÿÆÿµŸàÿµ ÿπ⁄©ÿ≥
                            const wrapper = document.createElement('div');
                            wrapper.className = 'image-wrapper max-w-xs rounded-2xl mb-3 hover-lift cursor-pointer';
                            wrapper.onclick = () => showImageModal(imageUrl);

                            // ‚è≥ ŸÑŸàÿØ€åŸÜ⁄Ø Ÿàÿ≥ÿ∑ ÿπ⁄©ÿ≥
                            const loader = document.createElement('div');
                            loader.className = 'image-loader';
                            wrapper.appendChild(loader);

                            // üñºÔ∏è ÿÆŸàÿØ ÿπ⁄©ÿ≥
                            const img = document.createElement('img');
                            img.src = imageUrl;

                            // ŸàŸÇÿ™€å ⁄©ÿßŸÖŸÑ ŸÑŸàÿØ ÿ¥ÿØÿå ÿ™ÿßÿ±€å ÿ®ÿ±ÿØÿßÿ¥ÿ™Ÿá ÿ®ÿ¥Ÿá Ÿà ŸÑŸàÿØ€åŸÜ⁄Ø ÿ≠ÿ∞ŸÅ ÿ¥Ÿá
                            img.onload = () => {
                                wrapper.classList.add('loaded');
                                loader.remove();
                            };

                            wrapper.appendChild(img);
                            bubbleDiv.appendChild(wrapper);
                        }


                        if (message) {
                            const textDiv = document.createElement('div');
                            textDiv.textContent = message;
                            textDiv.className = 'font-medium';
                            bubbleDiv.appendChild(textDiv);
                        }
                    }

                    messageDiv.appendChild(bubbleDiv);
                    document.getElementById('messagesContainer').appendChild(messageDiv);
                }




                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;


                function showTypingIndicator() {
                    const typingDiv = document.createElement('div');
                    typingDiv.id = 'typingIndicator';
                    typingDiv.className = 'flex justify-end fade-in';

                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.className = 'message-bubble p-4 ai-message shadow-lg';

                    const indicatorDiv = document.createElement('div');
                    indicatorDiv.className = 'flex gap-1 items-center';
                    indicatorDiv.innerHTML = '<span class="text-sm mr-2">ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿß€åŸæ...</span><div class="typing-indicator"></div><div class="typing-indicator"></div><div class="typing-indicator"></div>';

                    bubbleDiv.appendChild(indicatorDiv);
                    typingDiv.appendChild(bubbleDiv);
                    messagesContainer.appendChild(typingDiv);

                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }

                function hideTypingIndicator() {
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                }

                // ----------------------
                // ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ: ÿ™Ÿàÿßÿ®ÿπ ⁄©ŸÖ⁄©€å ÿ®ÿ±ÿß€å fuzzy match
                // ----------------------
                function levenshteinDistance(a, b) {
                    // lowercase Ÿà trim ÿ®ÿ±ÿß€å ŸÖŸÇÿß€åÿ≥Ÿá ÿ®Ÿáÿ™ÿ±
                    a = (a || '').toString();
                    b = (b || '').toString();
                    const an = a.length, bn = b.length;
                    if (an === 0) return bn;
                    if (bn === 0) return an;
                    const matrix = Array.from({ length: an + 1 }, () => new Array(bn + 1).fill(0));
                    for (let i = 0; i <= an; i++) matrix[i][0] = i;
                    for (let j = 0; j <= bn; j++) matrix[0][j] = j;
                    for (let i = 1; i <= an; i++) {
                        for (let j = 1; j <= bn; j++) {
                            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j] + 1,      // deletion
                                matrix[i][j - 1] + 1,      // insertion
                                matrix[i - 1][j - 1] + cost // substitution
                            );
                        }
                    }
                    return matrix[an][bn];
                }

                function similarityScore(a, b) {
                    a = (a || '').toString().toLowerCase().trim();
                    b = (b || '').toString().toLowerCase().trim();
                    const longer = a.length > b.length ? a : b;
                    const shorter = a.length > b.length ? b : a;
                    const longerLength = longer.length;
                    if (longerLength === 0) return 1.0;
                    const dist = levenshteinDistance(longer, shorter);
                    return (longerLength - dist) / longerLength; // ÿ®€åŸÜ 0 Ÿà 1
                }

                function bestFuzzyMatch(message, dictionary, threshold = 0.65) {
                    // ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØŸàŸÜŸá: { key, score } €åÿß null
                    if (!message || !dictionary) return null;
                    message = message.toString().toLowerCase().trim();

                    let bestKey = null;
                    let bestScore = 0;

                    // ÿ®ÿ±ÿ±ÿ≥€å ŸáŸÖŸá‚Äå€å ⁄©ŸÑ€åÿØŸáÿß
                    for (const key in dictionary) {
                        if (!Object.prototype.hasOwnProperty.call(dictionary, key)) continue;
                        const keyNormalized = key.toString().toLowerCase().trim();

                        // ÿß⁄Øÿ± €å⁄© ⁄©ŸÑ€åÿØ ÿÆ€åŸÑ€å ⁄©Ÿàÿ™ÿßŸá OK ŸÜÿßÿØ€åÿØŸá ÿ®⁄Ø€åÿ±€åŸÖ €åÿß Ÿàÿ≤ŸÜ ⁄©ŸÖÿ™ÿ±€å ÿ®ÿØ€åŸÖ
                        if (!keyNormalized) continue;

                        // ÿßŸàŸÑ ÿ®ÿ±ÿ±ÿ≥€å ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ ÿ¥ÿßŸÖŸÑ ÿ¥ÿØŸÜ €åÿß ÿ¥ÿßŸÖŸÑ ÿ¥ÿØŸÜ ŸÖÿπ⁄©Ÿàÿ≥ (partial) ‚Äî ÿ≥ÿ±€åÿπ Ÿà ÿØŸÇ€åŸÇ ÿ®ÿ±ÿß€å ⁄©ŸÑŸÖÿßÿ™ ⁄©ÿßŸÖŸÑ
                        if (message === keyNormalized) { // exact
                            return { key, score: 1.0 };
                        }
                        if (message.includes(keyNormalized) || keyNormalized.includes(message)) {
                            // partial match ÿ®ÿß ÿßŸÖÿ™€åÿßÿ≤ ÿ®ÿßŸÑÿß ŸàŸÑ€å ŸÜŸá ⁄©ÿßŸÖŸÑ
                            const scorePartial = Math.max(0.85, similarityScore(message, keyNormalized));
                            if (scorePartial > bestScore) {
                                bestScore = scorePartial;
                                bestKey = key;
                            }
                            // ÿßÿØÿßŸÖŸá ÿ®ÿØ€åŸÖ ⁄ÜŸàŸÜ ŸÖŸÖ⁄©ŸÜŸá exact Ÿæ€åÿØÿß ÿ®ÿ¥Ÿá
                            continue;
                        }

                        // ÿØÿ± ŸÜŸáÿß€åÿ™ fuzzy ÿ®ÿß Levenshtein
                        const score = similarityScore(message, keyNormalized);
                        if (score > bestScore) {
                            bestScore = score;
                            bestKey = key;
                        }
                    }

                    if (bestScore >= threshold) {
                        return { key: bestKey, score: bestScore };
                    }
                    return null;
                }

                // ----------------------
                // ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ⁄©ŸÜ: ÿ™ÿßÿ®ÿπ generateAIResponse ŸÅÿπŸÑ€å ÿ®ÿß ÿß€åŸÜ ŸÜÿ≥ÿÆŸá
                // ----------------------
                function generateAIResponse(userMessage) {
                    if (!userMessage) {
                        if (chatDictionary && chatDictionary["default"]) return getRandomResponse(chatDictionary["default"]);
                        return "⁄Ü€åÿ≤€å ŸÜ⁄ØŸÅÿ™€å ÿπÿ≤€åÿ≤ŸÖ üòò";
                    }

                    userMessage = userMessage.trim();
                    userMessage = userMessage.replace(/\s+/g, " ");

                    // === QUICK-ACTIONS: handle exact commands first (prevent partial matches to chat.json) ===
                    const normalized = userMessage.toString().trim();

                    // exact photo requests ‚Äî only run handlePhotoRequest when user typed exactly this
                    if (normalized === "ÿπ⁄©ÿ≥ ÿ®ÿØŸá" || normalized === "ÿπ⁄©ÿ≥" || normalized === "ÿπ⁄©ÿ≥ ÿ®ÿØŸá ŸÑÿ∑ŸÅÿß") {
                        return handlePhotoRequest();
                    }

                    // exact chat requests
                    if (normalized === "⁄Üÿ™ ⁄©ŸÜ€åŸÖ" || normalized === "ÿ®ÿ≤ŸÜ ÿ®ÿ±€åŸÖ ⁄Üÿ™") {
                        return handleChatRequest();
                    }
                    // =======================================================================

                    // üîç ÿ™ÿ¥ÿÆ€åÿµ ⁄©ŸÑ€åÿØ ÿßÿ≤ ÿ±Ÿà€å ÿ¨ŸÖŸÑŸá‚Äå€å ⁄©ÿßÿ±ÿ®ÿ±
                    let matchedKey = Object.keys(chatDictionary).find(key => userMessage.includes(key));

                    // üß† ÿß⁄Øÿ± Ÿæ€åÿØÿß ŸÜÿ¥ÿØÿå ÿßÿ≤ fuzzy match ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ
                    if (!matchedKey) {
                        const fuzzyResult = bestFuzzyMatch(userMessage, chatDictionary, 0.65);
                        if (fuzzyResult && fuzzyResult.key) {
                            console.log(`üéØ ÿ™ÿ∑ÿ®€åŸÇ ÿ™ŸÇÿ±€åÿ®€å Ÿæ€åÿØÿß ÿ¥ÿØ: "${userMessage}" ‚âà "${fuzzyResult.key}" (ÿßŸÖÿ™€åÿßÿ≤: ${fuzzyResult.score.toFixed(2)})`);
                            matchedKey = fuzzyResult.key;
                        }
                    }


                    let response = "";

                    // üó£Ô∏è ÿßŸÜÿ™ÿÆÿßÿ® Ÿæÿßÿ≥ÿÆ ÿßÿ≤ chat.json
                    if (matchedKey && chatDictionary[matchedKey]) {
                        response = getRandomResponse(chatDictionary[matchedKey]);
                    } else if (chatDictionary["default"]) {
                        response = getRandomResponse(chatDictionary["default"]);
                    } else {
                        response = "ÿ¨ÿßŸÑÿ®Ÿá! ÿ®€åÿ¥ÿ™ÿ± ÿ®⁄ØŸà üíï";
                    }

                    // üß† ÿ≠ÿßŸÅÿ∏Ÿá ⁄©ÿßÿ±ÿ®ÿ±
                    const memory = JSON.parse(localStorage.getItem('elmaMemory') || '{}');
                    const nickname = memory.nickname?.trim();
                    const interest = memory.interest?.trim();

                    // üí¨ ÿ®ÿ±ÿ±ÿ≥€å Ÿæÿ±ÿ≥ÿ¥ ÿØÿ±ÿ®ÿßÿ±Ÿá ÿÆŸàÿØ ⁄©ÿßÿ±ÿ®ÿ±
                    const aboutMeKeywords = ["ÿØÿ±ÿ®ÿßÿ±Ÿá ŸÖŸÜ", "ÿßÿ≥ŸÖ ŸÖŸÜ", "ŸÖŸÜ ⁄©€åŸÖ", "ŸÖŸÜ ⁄©€å‚ÄåÿßŸÖ", "ŸÖŸÜ ⁄©€å Ÿáÿ≥ÿ™ŸÖ", "⁄Ü€å ÿßÿ≤ŸÖ ŸÖ€å‚ÄåÿØŸàŸÜ€å", "ÿßÿ≥ŸÖŸÖ ⁄Ü€åŸá"];
                    if (aboutMeKeywords.some(k => userMessage.includes(k))) {
                        if (nickname && nickname.length > 0) {
                            if (interest && interest.length > 0) {
                                return `ÿ™Ÿà ÿ™Ÿà ÿ≠ÿßŸÅÿ∏Ÿá‚ÄåÿßŸÖ ÿßÿ≥ŸÖÿ™ ÿ±Ÿà ŸÜŸàÿ¥ÿ™€å ${nickname} üíï Ÿà ÿ™Ÿà ÿπŸÑÿßŸÇŸá‚ÄåŸÖŸÜÿØ€å‚ÄåŸáÿßÿ™ ŸÜŸàÿ¥ÿ™€å ÿπÿßÿ¥ŸÇ ${interest} Ÿáÿ≥ÿ™€å üòç`;
                            } else {
                                return `ÿ™Ÿà ÿ™Ÿà ÿ≠ÿßŸÅÿ∏Ÿá‚ÄåÿßŸÖ ÿßÿ≥ŸÖÿ™ ÿ±Ÿà ŸÜŸàÿ¥ÿ™€å ${nickname} üíñ ŸàŸÑ€å ŸáŸÜŸàÿ≤ ÿπŸÑÿßŸÇŸá‚ÄåŸÖŸÜÿØ€å‚ÄåŸáÿßÿ™ ÿ±Ÿà ÿ®Ÿá ŸÖŸÜ ŸÜ⁄ØŸÅÿ™€å üòÖ ÿØŸàÿ≥ÿ™ ÿØÿßÿ±€å ÿßŸÑÿßŸÜ ÿ®⁄Ø€åÿü`;
                            }
                        } else {
                            return `ŸáŸÜŸàÿ≤ ÿßÿ≥ŸÖÿ™ ÿ±Ÿà ÿ™Ÿà ÿ≠ÿßŸÅÿ∏Ÿá‚ÄåŸÖ ŸÜŸÜŸàÿ¥ÿ™ŸÖ üò¢ ŸÖ€å‚ÄåÿÆŸàÿß€å ÿßŸÑÿßŸÜ ÿ®ŸáŸÖ ÿ®⁄Ø€å ÿ™ÿß €åÿßÿØŸÖ ÿ®ŸÖŸàŸÜŸáÿü üíï`;
                        }
                    }

                    // üíñ ÿ¨ÿß€å⁄Øÿ≤€åŸÜ€å ÿßÿ≥ŸÖ ÿØÿ± ÿ®ŸÇ€åŸá Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß
                    if (nickname && nickname.length > 0 && typeof response === "string") {
                        response = response.replace(/ÿπÿ¥ŸÇŸÖ|ŸÜÿßÿ≤ŸÖ|ÿπÿ≤€åÿ≤ŸÖ|ŸÇŸÑÿ®ŸÖ|ŸÇÿ¥ŸÜ⁄ØŸÖ/gi, nickname);
                    }

                    // üéµ ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ÿπŸÑÿßŸÇŸá‚ÄåŸáÿß ÿ®ÿ±ÿß€å Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å ÿπŸÖŸàŸÖ€å
                    if (interest && interest.length > 0 && typeof response === "string") {
                        if (userMessage.includes("What's up?") || userMessage.includes("How are you?")) {
                            response += ` ÿ±ÿßÿ≥ÿ™€å ŸáŸÜŸàÿ≤ŸÖ ÿ®Ÿá ${interest} ÿπŸÑÿßŸÇŸá ÿØÿßÿ±€åÿü ü•∞`;
                        }
                    }


                    return response;

                    const original = userMessage.toString().trim();
                    const message = original.toLowerCase().trim();

                    // Handling quick actions first (keep existing special cases)
                    if (message === "Send Photo" || message === "ÿπ⁄©ÿ≥" || message === "Send Photo ŸÑÿ∑ŸÅÿß") {
                        return handlePhotoRequest();
                    }
                    if (message === "Chat" || message === "ÿ®ÿ≤ŸÜ ÿ®ÿ±€åŸÖ ⁄Üÿ™") {
                        return handleChatRequest();
                    }

                    // 1) exact key lookup (dictionary keys are assumed lowercase in load, but keep safe)
                    if (chatDictionary && chatDictionary[message]) {
                        return getRandomResponse(chatDictionary[message]);
                    }

                    // 2) partial includes (existing logic, but normalized)
                    if (chatDictionary) {
                        for (const key in chatDictionary) {
                            if (!Object.prototype.hasOwnProperty.call(chatDictionary, key)) continue;
                            const keyNorm = key.toString().toLowerCase().trim();
                            if (!keyNorm) continue;
                            if (message.includes(keyNorm) || keyNorm.includes(message)) {
                                return getRandomResponse(chatDictionary[key]);
                            }
                        }
                    }

                    // 3) fuzzy match (Levenshtein-based) ‚Äî ÿ®Ÿáÿ™ÿ±€åŸÜ ŸÜÿ≤ÿØ€å⁄©‚Äåÿ™ÿ±€åŸÜ ⁄©ŸÑ€åÿØ ÿ±Ÿà Ÿæ€åÿØÿß ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ
                    const match = bestFuzzyMatch(message, chatDictionary, 0.65); // threshold ŸÇÿßÿ®ŸÑ ÿ™ÿ∫€å€åÿ±
                    if (match && match.key && chatDictionary[match.key]) {
                        // ÿß⁄Øÿ± ÿÆŸàÿßÿ≥ÿ™€å ŸÖ€å‚Äåÿ™ŸàŸÜ€å ŸÑÿß⁄Ø €åÿß ŸÜŸÖÿß€åÿ¥ ÿßŸÖÿ™€åÿßÿ≤ ŸáŸÖ ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€å:
                        // console.debug('Fuzzy matched:', match.key, 'score:', match.score);
                        return getRandomResponse(chatDictionary[match.key]);
                    }

                    // 4) fallback to default responses
                    if (chatDictionary && chatDictionary["default"]) {
                        return getRandomResponse(chatDictionary["default"]);
                    }
                    saveUnknownPhrase(userMessage);
                    // 5) ultimate fallback
                    return "Interesting! Tell me more üòä";


                    function saveUnknownPhrase(phrase) {
                        if (!phrase) return;
                        phrase = phrase.trim();
                        if (!phrase) return;

                        // ÿ¨ŸÖŸÑŸá‚ÄåŸáÿß€å ÿ∞ÿÆ€åÿ±Ÿá‚Äåÿ¥ÿØŸá ŸÇÿ®ŸÑ€å ÿ±Ÿà ÿ®⁄Ø€åÿ±
                        let unknowns = JSON.parse(localStorage.getItem('unknownPhrases') || '[]');

                        // ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ ÿ™⁄©ÿ±ÿßÿ±€å ŸÜOK
                        if (!unknowns.includes(phrase)) {
                            unknowns.push(phrase);
                            localStorage.setItem('unknownPhrases', JSON.stringify(unknowns));
                            console.log('üß© ÿ¨ŸÖŸÑŸá ŸÜÿßÿ¥ŸÜÿßÿÆÿ™Ÿá ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ:', phrase);
                        }
                    }


                    // Special handling for quick actions
                    if (message === "Send Photo") {
                        return handlePhotoRequest();
                    }

                    if (message === "Chat") {
                        return handleChatRequest();
                    }

                    // First, try to find exact match in dictionary
                    if (chatDictionary[message]) {
                        return getRandomResponse(chatDictionary[message]);
                    }

                    // Then try to find partial matches
                    for (const key in chatDictionary) {
                        if (message.includes(key) || key.includes(message)) {
                            return getRandomResponse(chatDictionary[key]);
                        }
                    }

                    // If no match found, use default responses
                    if (chatDictionary["default"]) {
                        return getRandomResponse(chatDictionary["default"]);
                    }

                    // Final fallback
                    return "Interesting! Tell me more üòä";
                }

                function toggleQuickActions() {
                    const menu = document.getElementById('quickActionsMenu');
                    menu.classList.toggle('hidden');
                }

                function useQuickAction(type, message) {
                    if (usageCount[type] <= 0) {
                        showUpgradePrompt(type);
                        return;
                    }

                    // Send the message
                    messageInput.value = message;
                    sendMessage();

                    // Hide menu
                    document.getElementById('quickActionsMenu').classList.add('hidden');
                }

                function updateUsageCount(type) {
                    if (usageCount[type] > 0) {
                        usageCount[type]--;
                        updateUsageDisplay();

                        // Save to localStorage
                        localStorage.setItem('usageCount', JSON.stringify(usageCount));

                        // Save photo sequence if it's a photo request
                        if (type === 'photo') {
                            localStorage.setItem('photoSequence', photoSequence.toString());
                        }

                        if (usageCount[type] === 0) {
                            showUpgradeButton();
                        }
                    }
                }

                function updateUsageDisplay() {
                    // Check if user is premium
                    const isPremium = currentUser && document.getElementById('userType').textContent.includes('Ÿæÿ±€åŸÖ€åŸàŸÖ');

                    if (isPremium) {
                        // Premium users see unlimited
                        document.getElementById('photoCount').textContent = '(‚àû)';
                        document.getElementById('chatCount').textContent = '(‚àû)';

                        // Enable all buttons for premium
                        document.getElementById('quickPhoto').disabled = false;
                        document.getElementById('quickChat').disabled = false;


                        // Remove opacity for premium
                        document.getElementById('quickPhoto').classList.remove('opacity-50');
                        document.getElementById('quickChat').classList.remove('opacity-50');

                    } else {
                        // Free users see actual counts
                        document.getElementById('photoCount').textContent = `(${usageCount.photo})`;
                        document.getElementById('chatCount').textContent = `(${usageCount.chat})`;

                        // Disable buttons if no uses left
                        document.getElementById('quickPhoto').disabled = usageCount.photo <= 0;
                        document.getElementById('quickChat').disabled = usageCount.chat <= 0;


                        // Add visual feedback for disabled buttons
                        if (usageCount.photo <= 0) document.getElementById('quickPhoto').classList.add('opacity-50');
                        if (usageCount.chat <= 0) document.getElementById('quickChat').classList.add('opacity-50');

                    }
                }

                function showUpgradeButton() {
                    document.getElementById('upgradePro').classList.remove('hidden');
                }

                function showUpgradePrompt(type) {
                    const typeNames = {
                        photo: 'ÿπ⁄©ÿ≥',
                        chat: '⁄Üÿ™',
                    };

                    alert(`ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ${typeNames[type]} ÿ±ÿß€å⁄ØÿßŸÜ ÿ™ŸÖŸàŸÖ ÿ¥ÿØŸá! üòî\nÿ®ÿ±ÿß€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÜÿßŸÖÿ≠ÿØŸàÿØÿå ÿ≠ÿ≥ÿßÿ® Upgrade to Pro üëë`);
                    showUpgradeButton();
                }

                function showUpgradeModal() {
                    document.getElementById('premiumModal').classList.remove('hidden');
                }


                function handlePhotoRequest() {
                    // Check if user is premium
                    const isPremium = currentUser && document.getElementById('userType').textContent.includes('Ÿæÿ±€åŸÖ€åŸàŸÖ');

                    if (!isPremium && usageCount.photo <= 0) {
                        showUpgradePrompt('photo');
                        return "ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ÿπ⁄©ÿ≥‚ÄåŸáÿß€å ÿ±ÿß€å⁄ØÿßŸÜ ÿ™ŸÖŸàŸÖ ÿ¥ÿØŸá ÿπÿ¥ŸÇŸÖ! üòî\nÿ®ÿ±ÿß€å ÿØ€åÿØŸÜ ÿπ⁄©ÿ≥‚ÄåŸáÿß€å ÿ®€åÿ¥ÿ™ÿ±ÿå ÿ≠ÿ≥ÿßÿ® Upgrade to Pro üëëüíñ";
                    }

                    if (!isPremium) {
                        updateUsageCount('photo');
                    }

                    // Send specific photo based on sequence (not random)
                    setTimeout(() => {
                        const sequentialPhotos = [
                            'Assets/img/Elma/Elma1.png',  // First photo
                            'Assets/img/Elma/Elma2.png',  // Second photo  
                            'Assets/img/Elma/Elma3.png'   // Third photo
                        ];

                        let photoToSend;
                        if (isPremium) {
                            // Premium users get random photos from extended collection
                            const premiumPhotos = [
                                'Assets/img/Elma/Elma.png',
                                'Assets/img/Elma/Elma4.png',
                                'Assets/img/Elma/Elma5.png',
                                'Assets/img/Elma/Elma6.png',
                                'Assets/img/Elma/Elma7.png',
                                'Assets/img/Elma/Elma8.png',
                                'Assets/img/Elma/Elma9.png',
                                'Assets/img/Elma/Elma10.png',
                                'Assets/img/Elma/Elma11.png',
                                'Assets/img/Elma/Elma12.png',
                                'Assets/img/Elma/Elma13.png',
                                'Assets/img/Elma/Elma14.png',
                                'Assets/img/Elma/Elma15.png',
                                'Assets/img/Elma/Elma16.png',
                                'Assets/img/Elma/Elma17.png',
                                'Assets/img/Elma/Elma18.png',
                                'Assets/img/Elma/Elma19.png',
                                'Assets/img/Elma/Elma20.png',
                                'Assets/img/Elma/Elma21.png',
                                'Assets/img/Elma/Elma22.png',
                                'Assets/img/Elma/Elma23.png',
                                'Assets/img/Elma/Elma24.png',
                                'Assets/img/Elma/Elma25.png',
                                'Assets/img/Elma/Elma26.png',
                                'Assets/img/Elma/Elma27.png',
                                'Assets/img/Elma/Elma28.png',
                                'Assets/img/Elma/Elma29.png',
                                'Assets/img/Elma/Elma30.png',
                                'Assets/img/Elma/Elma31.png',
                                'Assets/img/Elma/Elma32.png',
                                'Assets/img/Elma/Elma33.png',
                                'Assets/img/Elma/Elma34.png',
                                'Assets/img/Elma/Elma35.png',
                                'Assets/img/Elma/Elma36.png',
                                'Assets/img/Elma/Elma37.png',
                                'Assets/img/Elma/Elma38.png',
                                'Assets/img/Elma/Elma39.png',
                                'Assets/img/Elma/Elma40.png',
                                'Assets/img/Elma/Elma41.png',
                                'Assets/img/Elma/Elma42.png',
                                'Assets/img/Elma/Elma43.png',
                                'Assets/img/Elma/Elma44.png',
                                'Assets/img/Elma/Elma45.png',
                                'Assets/img/Elma/Elma46.png',
                                'Assets/img/Elma/Elma47.png',
                                'Assets/img/Elma/Elma48.png',
                                'Assets/img/Elma/Elma49.png',
                                'Assets/img/Elma/Elma50.png'
                            ];
                            photoToSend = premiumPhotos[Math.floor(Math.random() * premiumPhotos.length)];
                        } else {
                            // Free users get sequential photos
                            photoToSend = sequentialPhotos[photoSequence];
                            photoSequence = (photoSequence + 1) % 3; // Reset to 0 after 3rd photo
                        }

                        addMessageToChat('ai', '', photoToSend);

                        const photoResponses = [
                            'I chose this photo for you, my love üíñüì∏',
                            'I hope you like this photo, my love üòòüì∑',
                            'This photo reminded me of you, my heart ü•∞üíï',
                            'How beautiful! Just like you, my love üòç‚ú®'
                        ];

                        setTimeout(() => {
                            addMessageToChat('ai', getRandomResponse(photoResponses));
                        }, 1000);
                    }, 1500);

                    return getRandomResponse(chatDictionary["Send Photo"] || ["Let me find you a beautiful photo, my love! üì∏üíï"]);
                }

                function handleChatRequest() {
                    updateUsageCount('chat');

                    // Start a focused chat conversation
                    setTimeout(() => {
                        const chatTopics = [
                            'Really, my love, what would you like to do? üí≠üíï',
                            'ÿ®⁄ØŸà ÿ®ÿ®€åŸÜŸÖÿå ⁄Ü€å ÿ™Ÿà ÿ∞ŸáŸÜÿ™Ÿá ŸÜÿßÿ≤ŸÖÿü ü§îüíñ',
                            'I want to know more about my heart üòäüíï',
                            'What\'s up?Oh, about your life? Tell me everything.ü•∞üí¨'
                        ];

                        addMessageToChat('ai', getRandomResponse(chatTopics));
                    }, 2000);

                    return getRandomResponse(chatDictionary["Chat"]);
                }





                function displayGameMessage(message, options, image) {
                    // üü¢ 1) Ÿæ€åÿßŸÖ ŸÖÿ™ŸÜ€å
                    addMessageToChat('ai', message);

                    // üü¢ 2) ÿß⁄Øÿ± ÿπ⁄©ÿ≥ Ÿáÿ≥ÿ™ÿå ÿ®ÿπÿØ ÿßÿ≤ Ÿæ€åÿßŸÖ ŸÖÿ™ŸÜ€å ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ
                    if (image) {
                        setTimeout(() => {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'flex justify-start fade-in my-2';

                            const img = document.createElement('img');
                            img.src = image;
                            img.alt = 'game-image';
                            img.className = 'max-w-xs rounded-2xl shadow-md';

                            imgDiv.appendChild(img);
                            messagesContainer.appendChild(imgDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, 500); // ⁄©ŸÖ€å ŸÅÿßÿµŸÑŸá ÿ™ÿß ÿ≠ÿ≥ ⁄ØŸÅÿ™‚ÄåŸà⁄ØŸà ÿØÿßÿ¥ÿ™Ÿá OK
                    }

                    // üü¢ 3) ⁄Øÿ≤€åŸÜŸá‚ÄåŸáÿß€å ÿßŸÜÿ™ÿÆÿßÿ®€å
                    if (options && options.length > 0) {
                        setTimeout(() => {
                            const optionsDiv = document.createElement('div');
                            optionsDiv.className = 'flex flex-col gap-2 max-w-md mx-auto fade-in';

                            options.forEach((option) => {
                                const button = document.createElement('button');
                                button.className =
                                    'p-3 rounded-2xl glass-effect hover-lift transition-all duration-300 theme-text-primary text-right';
                                button.textContent = option.text;
                                button.onclick = () => handleGameChoice(option.next, option.text);
                                optionsDiv.appendChild(button);
                            });

                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'flex justify-end fade-in';
                            messageDiv.appendChild(optionsDiv);
                            messagesContainer.appendChild(messageDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, 1000);
                    }
                }


                function handleGameChoice(nextQuestion, choiceText) {
                    // Add user's choice as a message
                    addMessageToChat('user', choiceText);

                    // Remove option buttons
                    const optionButtons = messagesContainer.querySelectorAll('button');
                    optionButtons.forEach(btn => {
                        if (btn.onclick && btn.onclick.toString().includes('handleGameChoice')) {
                            btn.parentElement.parentElement.remove();
                        }
                    });

                    // Save choice
                    gameState.playerChoices.push({
                        question: gameState.currentQuestion,
                        choice: choiceText,
                        next: nextQuestion
                    });

                    // Move to next question
                    gameState.currentQuestion = nextQuestion;

                    setTimeout(() => {
                        if (nextQuestion === 'end') {
                            endGame();
                        } else {
                            const nextData = gameQuestions[nextQuestion];
                            if (nextData) {
                                displayGameMessage(
                                    nextData.message,
                                    nextData.options,
                                    nextData.image && nextData.image.image_url ? nextData.image.image_url : null
                                );
                            } else {
                                // Fallback ending if question not found
                                endGame();
                            }
                        }
                    }, 1500);
                }

                function getRandomResponse(responses) {
                    return responses[Math.floor(Math.random() * responses.length)];
                }

                async function saveMessage(sender, message, imageUrl = null) {
                    if (!currentUser || !currentChatId) return;

                    try {
                        await addDoc(collection(db, 'chats', currentChatId, 'messages'), {
                            sender: sender,
                            message: message,
                            imageUrl: imageUrl,
                            timestamp: new Date(),
                            userId: currentUser.uid
                        });

                        // Update chat title only if it's the first user message and title is still default
                        if (sender === 'user' && message) {
                            const chatDoc = await getDoc(doc(db, 'chats', currentChatId));
                            if (chatDoc.exists()) {
                                const chatData = chatDoc.data();
                                // Only update title if it's still the default title
                                if (chatData.title === 'New romantic chat üíï') {
                                    const chatTitle = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                                    await updateDoc(doc(db, 'chats', currentChatId), {
                                        title: chatTitle,
                                        lastMessage: message,
                                        updatedAt: new Date()
                                    });
                                } else {
                                    // Just update last message and timestamp
                                    await updateDoc(doc(db, 'chats', currentChatId), {
                                        lastMessage: message,
                                        updatedAt: new Date()
                                    });
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error saving message:', error);
                    }
                }

                async function createNewChat() {
                    if (!currentUser) {
                        showRegistrationModal();
                        return;
                    }

                    try {
                        // ÿ≥ÿßÿÆÿ™ New Chat ÿØÿ± ÿØ€åÿ™ÿßÿ®€åÿ≥
                        const chatRef = await addDoc(collection(db, 'chats'), {
                            userId: currentUser.uid,
                            title: 'New romantic chat üíï',
                            createdAt: new Date(),
                            archived: false,
                            updatedAt: new Date()
                        });

                        // ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ŸÜÿßÿ≥Ÿá New Chat ÿØÿ± ÿ≠ÿßŸÅÿ∏Ÿá
                        currentChatId = chatRef.id;
                        localStorage.setItem("lastChatId", chatRef.id);

                        clearChat();

                        // Close ÿ≥ÿß€åÿØÿ®ÿßÿ± ÿØÿ± ÿ≠ÿßŸÑÿ™ ŸÖŸàByeŸÑ
                        if (window.innerWidth < 768) {
                            sidebar.classList.add('translate-x-full');
                        }

                        // ÿ®ÿπÿØ ÿßÿ≤ ÿ≥ÿßÿÆÿ™ÿå ŸÑ€åÿ≥ÿ™ ⁄Üÿ™‚ÄåŸáÿß ÿ±Ÿà ÿØŸàÿ®ÿßÿ±Ÿá ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄©ŸÜ
                        loadChatHistory();

                        console.log("‚úÖ New Chat was created:", chatRef.id);

                    } catch (error) {
                        console.error('‚ùå Error creating New Chat:', error);
                    }
                }


                function clearChat() {
                    messagesContainer.innerHTML = `
                <div class="text-center py-12 fade-in">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full overflow-hidden border-4 border-pink-400 heart-float glow-effect">
                        <img src="Assets/img/Elma/Profile.png" alt="Elma" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full theme-accent flex items-center justify-center" style="display: none;">
                            <i class="fas fa-heart text-white text-3xl"></i>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold gradient-text mb-3">Hi my love! I'm Elma üíñ</h2>
                    <p class="theme-text-secondary text-lg">I'm your virtual girlfriend</p>
                    <p class="theme-text-secondary">How are you, babe? I missed you üòò</p>
                </div>
            `;
                }

                async function loadChatHistory() {
                    window.loadChat = loadChat;
                    if (!currentUser) return;

                    const q = query(
                        collection(db, 'chats'),
                        orderBy('updatedAt', 'desc')
                    );

                    onSnapshot(q, (snapshot) => {
                        const chatHistoryDiv = document.getElementById('chatHistory');
                        chatHistoryDiv.innerHTML = '';

                        snapshot.forEach((doc) => {
                            const chat = doc.data();
                            if (chat.userId === currentUser.uid) {
                                const chatItem = document.createElement('div');
                                chatItem.className = 'w-full p-4 rounded-2xl glass-effect hover-lift transition-all duration-300 mb-2 relative group';
                                chatItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1 cursor-pointer" onclick="loadChat('${doc.id}')">
                                    <div class="theme-text-primary font-medium truncate flex items-center gap-2">
                                        <i class="fas fa-heart text-pink-400"></i>
                                        ${chat.title}
                                    </div>
                                    <div class="theme-text-secondary text-sm truncate mt-1">${chat.lastMessage || ''}</div>
                                </div>
                                <div class="relative opacity-0 group-hover:opacity-100 transition-opacity duration-300 chat-menu-container">
                                    <button onclick="toggleChatMenu(event, '${doc.id}')" class="p-2 rounded-full glass-effect hover-lift">
                                        <i class="fas fa-ellipsis-h theme-text-primary text-sm"></i>
                                    </button>
                                    
                                    <div id="chatMenu-${doc.id}" class="absolute left-0 top-full mt-2 w-48 glass-effect rounded-2xl shadow-lg hidden z-20 overflow-hidden chat-dropdown-menu">
                                        <button onclick="shareChatItem('${doc.id}')" class="w-full text-right p-3 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                                            <i class="fas fa-share theme-text-primary text-sm"></i>
                                            <span class="theme-text-primary text-sm">ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å</span>
                                        </button>
                                        <button onclick="renameChatItem('${doc.id}', '${chat.title}')" class="w-full text-right p-3 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                                            <i class="fas fa-edit theme-text-primary text-sm"></i>
                                            <span class="theme-text-primary text-sm">ÿ™ÿ∫€å€åÿ± ŸÜÿßŸÖ</span>
                                        </button>
                                        <button onclick="archiveChatItem('${doc.id}')" class="w-full text-right p-3 hover:theme-bg-tertiary transition-all duration-300 flex items-center gap-3">
                                            <i class="fas fa-archive theme-text-primary text-sm"></i>
                                            <span class="theme-text-primary text-sm">Archive</span>
                                        </button>
                                        <button onclick="deleteChatItem('${doc.id}')" class="w-full text-right p-3 hover:bg-red-500 hover:bg-opacity-20 transition-all duration-300 flex items-center gap-3 text-red-500">
                                            <i class="fas fa-trash text-sm"></i>
                                            <span class="text-sm">Delete Chat</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                                chatHistoryDiv.appendChild(chatItem);
                            }
                        });
                    });
                }

                async function loadChat(chatId) {
                    currentChatId = chatId;
                    clearChat();

                    try {
                        // Load chat info
                        const chatDoc = await getDoc(doc(db, 'chats', chatId));
                        if (chatDoc.exists()) {
                            const chatData = chatDoc.data();
                            // Chat title is now fixed as "Elma üíï"
                        }

                        // Load messages
                        const q = query(
                            collection(db, 'chats', chatId, 'messages'),
                            orderBy('timestamp', 'asc')
                        );

                        onSnapshot(q, (snapshot) => {
                            // Clear existing messages except welcome
                            const messages = messagesContainer.querySelectorAll('.fade-in');
                            messages.forEach(msg => msg.remove());

                            snapshot.forEach((doc) => {
                                const message = doc.data();
                                addMessageToChat(message.sender, message.message, message.imageUrl);
                            });
                        });

                        // Close sidebar on mobile
                        if (window.innerWidth < 768) {
                            sidebar.classList.add('translate-x-full');
                        }
                    } catch (error) {
                        console.error('Error loading chat:', error);
                    }
                }

                // Share functionality
                function showShareModal() {
                    document.getElementById('shareModal').classList.remove('hidden');
                    dropdownMenu.classList.add('hidden');
                }

                function hideShareModal() {
                    document.getElementById('shareModal').classList.add('hidden');
                }

                function shareToWhatsApp() {
                    const shareText = 'ÿ≥ŸÑÿßŸÖ! ŸÖŸÜ ÿ®ÿß Elma ÿØŸàÿ≥ÿ™ ÿØÿÆÿ™ÿ± ŸÖÿ¨ÿßÿ≤€å ⁄Üÿ™ ŸÖ€å ⁄©ŸÜŸÖ! ÿÆ€åŸÑ€å ÿ®ÿßÿ≠ÿßŸÑŸáÿå ÿ™Ÿà ŸáŸÖ ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ŸÜ üíï';
                    const shareUrl = window.location.href;
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + '\n' + shareUrl)}`;
                    window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    hideShareModal();
                }

                function shareToTelegram() {
                    const shareText = 'ÿ≥ŸÑÿßŸÖ! ŸÖŸÜ ÿ®ÿß Elma ÿØŸàÿ≥ÿ™ ÿØÿÆÿ™ÿ± ŸÖÿ¨ÿßÿ≤€å ⁄Üÿ™ ŸÖ€å ⁄©ŸÜŸÖ! ÿÆ€åŸÑ€å ÿ®ÿßÿ≠ÿßŸÑŸáÿå ÿ™Ÿà ŸáŸÖ ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ŸÜ üíï';
                    const shareUrl = window.location.href;
                    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                    window.open(telegramUrl, '_blank', 'noopener,noreferrer');
                    hideShareModal();
                }

                async function copyShareLink() {
                    try {
                        const shareText = 'ÿ≥ŸÑÿßŸÖ! ŸÖŸÜ ÿ®ÿß Elma ÿØŸàÿ≥ÿ™ ÿØÿÆÿ™ÿ± ŸÖÿ¨ÿßÿ≤€å ⁄Üÿ™ ŸÖ€å ⁄©ŸÜŸÖ! ÿÆ€åŸÑ€å ÿ®ÿßÿ≠ÿßŸÑŸáÿå ÿ™Ÿà ŸáŸÖ ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ŸÜ üíï\n' + window.location.href;
                        await navigator.clipboard.writeText(shareText);

                        // Show success feedback
                        const copyBtn = document.getElementById('copyLink');
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> ⁄©Ÿæ€å ÿ¥ÿØ!';
                        copyBtn.classList.add('bg-green-500', 'text-white');

                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.classList.remove('bg-green-500', 'text-white');
                        }, 2000);

                        setTimeout(() => {
                            hideShareModal();
                        }, 1500);
                    } catch (error) {
                        alert('Error copying link üòî');
                    }
                }

                // Premium functionality
                function showPremiumModal() {
                    document.getElementById('premiumModal').classList.remove('hidden');
                }

                function hidePremiumModal() {
                    document.getElementById('premiumModal').classList.add('hidden');
                }

                function handlePremiumPurchase() {
                    // Redirect to Telegram for purchase
                    const telegramUrl = 'https://t.me/hexdix'; // Replace with your actual Telegram bot/channel
                    const message = 'ÿ≥ŸÑÿßŸÖ! ŸÖ€å‚ÄåÿÆŸàÿßŸÖ Premium Account Elma ÿ±Ÿà ÿ®ÿÆÿ±ŸÖ üíñ\nŸÇ€åŸÖÿ™: €µ€µ€∞,€∞€∞€∞ ÿ™ŸàŸÖÿßŸÜ';
                    const fullUrl = `${telegramUrl}?start=premium&text=${encodeURIComponent(message)}`;

                    window.open(fullUrl, '_blank', 'noopener,noreferrer');
                    hidePremiumModal();
                }

                // Archive functionality
                async function archiveCurrentChat() {
                    if (!currentChatId || !currentUser) return;

                    try {
                        // Update chat status to archived
                        await updateDoc(doc(db, 'chats', currentChatId), {
                            archived: true,
                            archivedAt: new Date(),
                            userId: currentUser.uid
                        });

                        // Show success modal
                        document.getElementById('archiveModal').classList.remove('hidden');
                        dropdownMenu.classList.add('hidden');

                        // Create new chat after archiving
                        setTimeout(() => {
                            createNewChat();
                        }, 2000);
                    } catch (error) {
                        console.error('Error archiving chat:', error);
                        alert('Error archiving chat üòî');
                    }
                }

                function hideArchiveModal() {
                    document.getElementById('archiveModal').classList.add('hidden');
                }

                // Report functionality
                async function reportCurrentChat() {
                    if (!currentChatId || !currentUser) return;

                    try {
                        // Save report to database
                        await addDoc(collection(db, 'reports'), {
                            chatId: currentChatId,
                            userId: currentUser.uid,
                            reportedAt: new Date(),
                            reason: 'User reported chat content',
                            status: 'pending'
                        });

                        // Show success modal
                        document.getElementById('reportModal').classList.remove('hidden');
                        dropdownMenu.classList.add('hidden');
                    } catch (error) {
                        console.error('Error reporting chat:', error);
                        alert('Error sending report üòî');
                    }
                }

                function hideReportModal() {
                    document.getElementById('reportModal').classList.add('hidden');
                }

                // Delete functionality with custom modal
                function showDeleteModal() {
                    document.getElementById('deleteModal').classList.remove('hidden');
                    dropdownMenu.classList.add('hidden');
                }

                function hideDeleteModal() {
                    document.getElementById('deleteModal').classList.add('hidden');
                }

                async function confirmDeleteChat() {
                    if (!currentChatId || !currentUser) return;

                    try {
                        // Delete all messages in the chat
                        const messagesQuery = query(collection(db, 'chats', currentChatId, 'messages'));
                        const messagesSnapshot = await getDocs(messagesQuery);

                        const deletePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);

                        // Delete the chat document
                        await deleteDoc(doc(db, 'chats', currentChatId));

                        hideDeleteModal();
                        createNewChat();
                    } catch (error) {
                        console.error('Error deleting chat:', error);
                        alert('Error in Delete Chat üòî');
                    }
                }

                async function handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (!currentUser) {
                        showRegistrationModal();
                        return;
                    }

                    try {
                        // Upload to Firebase Storage
                        const storageRef = ref(storage, `images/${currentUser.uid}/${Date.now()}_${file.name}`);
                        const snapshot = await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(snapshot.ref);

                        // Add to chat
                        addMessageToChat('user', '', downloadURL);
                        await saveMessage('user', '', downloadURL);

                        // Add to gallery
                        galleryImages.push(downloadURL);

                        // AI response to image
                        setTimeout(async () => {
                            const imageResponses = [
                                'Wow, what a beautiful picture! üòçüíï',
                                'I fell in love with this picture of you, my dear üì∏üíñ',
                                'How beautiful! Just like you ü•∞',
                                'I love this picture, my love üòòüì∑'
                            ];
                            const aiResponse = getRandomResponse(imageResponses);
                            addMessageToChat('ai', aiResponse);
                            await saveMessage('ai', aiResponse);
                        }, 1500);

                    } catch (error) {
                        console.error('Error uploading image:', error);
                        alert('Error uploading my photo üíî');
                    }
                }

                function showGallery() {
                    galleryModal.classList.remove('hidden');
                    loadGalleryImages();
                }

                function hideGallery() {
                    galleryModal.classList.add('hidden');
                }

                // helper: ÿ¢€åÿß ⁄©ÿßÿ±ÿ®ÿ± Ÿæÿ±€åŸÖ€åŸàŸÖ ÿßÿ≥ÿ™ÿü
                function isUserPremium() {
                    // ÿß€åŸÜ ÿ™ÿßÿ®ÿπ ÿßÿ≤ ŸáŸÖÿßŸÜ ŸÖ⁄©ÿßŸÜ€å⁄© ŸÅÿß€åŸÑ ÿ™Ÿà ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äå⁄©ŸÜÿØ: userType ÿØÿßÿÆŸÑ DOM
                    const userTypeEl = document.getElementById('userType');
                    return userTypeEl && /Ÿæÿ±€åŸÖ€åŸàŸÖ|pro|premium/i.test(userTypeEl.textContent);
                }

                // ÿ¨ÿß€å⁄Øÿ≤€åŸÜ loadGalleryImages()
                function loadGalleryImages() {
                    const galleryGrid = document.getElementById('galleryGrid');
                    galleryGrid.innerHTML = '';

                    // ÿ™ÿµÿßŸà€åÿ± ŸÜŸÖŸàŸÜŸá (ŸÖ€å‚Äåÿ™ŸàŸÜ€å ÿ¢ÿØÿ±ÿ≥‚ÄåŸáÿß ÿ±ÿß ÿ®Ÿá ÿ¢ÿ±ÿß€åŸá‚Äåÿß€å ⁄©Ÿá ÿßÿ≤ ÿ≥ÿ±Ÿàÿ±ÿ™ ŸÖ€åÿßÿØ ÿ™ÿ∫€å€åÿ± ÿ®ÿØ€å)
                    const sampleImages = [
                        'Assets/img/Elma Nude/Elma1.png',
                        'Assets/img/Elma Nude/Elma2.png',
                        'Assets/img/Elma Nude/Elma3.png',
                        'Assets/img/Elma Nude/Elma4.png',
                        'Assets/img/Elma Nude/Elma5.png',
                        'Assets/img/Elma Nude/Elma6.png',
                        'Assets/img/Elma Nude/Elma7.png',
                        'Assets/img/Elma Nude/Elma8.png',
                        'Assets/img/Elma Nude/Elma9.png',
                        'Assets/img/Elma Nude/Elma10.png',
                        'Assets/img/Elma Nude/Elma11.png',
                        'Assets/img/Elma Nude/Elma12.png',
                        'Assets/img/Elma Nude/Elma13.png',
                        'Assets/img/Elma Nude/Elma.png'
                    ];

                    const premium = isUserPremium();

                    sampleImages.forEach(imageUrl => {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'aspect-square rounded-2xl hover-lift glass-effect gallery-item';
                        imgDiv.innerHTML = `
            <img src="${imageUrl}" alt="Gallery Image">
        `;

                        if (!premium) {
                            // lock it for free users
                            imgDiv.classList.add('locked');
                            imgDiv.innerHTML += `
                <div class="lock-overlay">
                  <div class="lock-badge">
                    <i class="fas fa-lock"></i>
                    <span>Special for Peru</span>
                  </div>
                  <div class="lock-text">To see the full photo, upgrade to Pro.</div>
                </div>
            `;
                            // ⁄©ŸÑ€å⁄© ÿ±Ÿà€å overlay -> ŸÜŸÖÿß€åÿ¥ ŸÖŸàÿØÿßŸÑ ÿÆÿ±€åÿØ €åÿß Sign Up
                            imgDiv.querySelector('.lock-overlay').addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (!currentUser) {
                                    // ÿß⁄Øÿ± Ÿàÿßÿ±ÿØ ŸÜÿ¥ÿØŸá‚ÄåÿßŸÜÿØÿå Sign Up ÿ±ÿß ŸÜÿ¥ÿßŸÜ ÿ®ÿØŸá
                                    showRegistrationModal();
                                } else {
                                    // ÿß⁄Øÿ± Ÿàÿßÿ±ÿØ ÿ¥ÿØŸá‚ÄåÿßŸÜÿØ ŸàŸÑ€å ÿ¢ÿ≤ÿßÿØ ŸÜ€åÿ≥ÿ™ŸÜÿØÿå ŸÖŸàÿØÿßŸÑ ÿÆÿ±€åÿØ ŸÜÿ¥ÿßŸÜ ÿ®ÿØŸá
                                    document.getElementById('premiumModal').classList.remove('hidden');
                                }
                            });
                        } else {
                            // ÿß⁄Øÿ± Ÿæÿ±€åŸÖ€åŸàŸÖ ÿßÿ≥ÿ™ÿå ⁄©ŸÑ€å⁄© ŸÖÿ≥ÿ™ŸÇ€åŸÖ ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ÿπ⁄©ÿ≥ ⁄©ÿßŸÖŸÑ
                            imgDiv.addEventListener('click', () => showImageModal(imageUrl, true));
                        }

                        // ÿ®ÿ±ÿß€å ÿ≠ÿßŸÑÿ™‚ÄåŸáÿß€å ŸÖÿ¥ÿ™ÿ±⁄© (ŸÖÿ´ŸÑÿßŸã ÿß⁄Øÿ± ÿ®ÿÆŸàÿß€å ÿ¢ŸÖÿßÿ± €åÿß ŸÑÿß€å⁄© ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€å) ŸÖ€å‚Äåÿ™ŸàŸÜ€å ÿß€åŸÜÿ¨ÿß ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€å
                        galleryGrid.appendChild(imgDiv);
                    });
                }

                // ŸÜÿ≥ÿÆŸá ÿßÿ±ÿ™ŸÇÿß €åÿßŸÅÿ™Ÿá showImageModal
                // ÿß⁄Øÿ± forceOpen === true ÿßÿ≤ ŸÇŸÅŸÑ ÿπÿ®Ÿàÿ± ŸÖ€å‚Äå⁄©ŸÜÿØ (ÿ®ÿ±ÿß€å Ÿæÿ±€åŸÖ€åŸàŸÖ‚ÄåŸáÿß)
                function showImageModal(imageUrl, forceOpen = false) {
                    const premium = isUserPremium();

                    if (!premium && !forceOpen) {
                        // Free user clicked image (ÿØÿ± ÿ≠ÿßŸÑÿ™ ŸÖÿß ⁄©ŸÑ€å⁄© ŸÖÿ≥ÿ™ŸÇ€åŸÖ ÿ±Ÿà€å img ÿ®ÿ±ÿß€å free ÿ∫€åÿ±ŸÅÿπÿßŸÑ ÿßÿ≥ÿ™ÿå
                        // ÿßŸÖÿß ÿß⁄Øÿ± ÿßÿ≤ ÿ¨ÿß€å€å ÿØ€å⁄ØŸá‚Äåÿß€å ÿÆŸàÿßÿ≥ÿ™€å ÿ®ÿßÿ≤ÿ¥ ⁄©ŸÜ€åÿå ŸÖ€å‚Äå⁄Ø€åÿ±€åŸÖ ÿß€åŸÜÿ¨ÿß)
                        if (!currentUser) {
                            showRegistrationModal();
                            return;
                        }
                        document.getElementById('premiumModal').classList.remove('hidden');
                        return;
                    }

                    // ÿ≥ÿßÿÆÿ™ ŸÖŸàÿØÿßŸÑ ŸÜŸÖÿß€åÿ¥ ÿ™ÿµŸà€åÿ± ⁄©ÿßŸÖŸÑ
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 fade-in';
                    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${imageUrl}" alt="Full Size Image" class="max-w-full max-h-[80vh] rounded-2xl glow-effect">
            <button class="absolute top-4 left-4 text-white text-2xl hover:opacity-80 bg-black bg-opacity-50 rounded-full p-3 close-modal-btn">
                <i class="fas fa-download"></i>
            </button>
            <button class="absolute top-4 right-4 text-white text-2xl hover:opacity-80 bg-black bg-opacity-50 rounded-full p-3 close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

                    // Close ŸÖŸàÿØÿßŸÑ
                    modal.addEventListener('click', (e) => {
                        // ÿß⁄Øÿ± ÿ±Ÿà€å ÿ®⁄©‚ÄåÿØÿ±ÿßŸæ ⁄©ŸÑ€å⁄© ÿ¥ÿØ €åÿß ÿØ⁄©ŸÖŸá Close
                        if (e.target === modal || e.target.closest('.close-modal-btn')) {
                            modal.remove();
                        }
                    });

                    // ÿØÿßŸÜŸÑŸàÿØ ÿ™ÿµŸà€åÿ± (ŸÅŸÇÿ∑ ÿ®ÿ±ÿß€å Ÿæÿ±€åŸÖ€åŸàŸÖ)
                    const downloadBtn = modal.querySelector('.fa-download')?.closest('button');
                    if (downloadBtn) {
                        downloadBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (!isUserPremium()) {
                                // ÿß⁄Øÿ± ⁄©ÿßÿ±ÿ®ÿ± Ÿæÿ±€åŸÖ€åŸàŸÖ ŸÜÿ®ŸàÿØÿå ŸÖŸàÿØÿßŸÑ ÿÆÿ±€åÿØ
                                document.getElementById('premiumModal').classList.remove('hidden');
                                return;
                            }
                            // ÿØÿßŸÜŸÑŸàÿØ ÿ®ÿß ŸÑ€åŸÜ⁄© ŸÖÿ≥ÿ™ŸÇ€åŸÖ
                            const a = document.createElement('a');
                            a.href = imageUrl;
                            a.download = imageUrl.split('/').pop();
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        });
                    }

                    document.body.appendChild(modal);
                }


                // Rename chat functionality
                function showRenameModal() {
                    document.getElementById('renameModal').classList.remove('hidden');
                    document.getElementById('chatHistoryMenu').classList.add('hidden');

                    // Pre-fill current chat name if available
                    if (currentChatId) {
                        // You can load current chat name here
                        document.getElementById('newChatName').value = '';
                    }
                }

                function hideRenameModal() {
                    document.getElementById('renameModal').classList.add('hidden');
                    document.getElementById('newChatName').value = '';
                }

                async function handleRenameChat(e) {
                    e.preventDefault();
                    const newName = document.getElementById('newChatName').value.trim();

                    if (!newName || !currentChatId) return;

                    try {
                        await updateDoc(doc(db, 'chats', currentChatId), {
                            title: newName,
                            updatedAt: new Date()
                        });

                        hideRenameModal();
                        loadChatHistory(); // Refresh chat history

                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                        successDiv.textContent = 'Chat name changed successfully! ‚úÖ';
                        document.body.appendChild(successDiv);

                        setTimeout(() => {
                            successDiv.remove();
                        }, 3000);
                    } catch (error) {
                        console.error('Error renaming chat:', error);
                        alert('Error changing chat name üòî');
                    }
                }

                // Archive list functionality
                function showArchiveListModal() {
                    document.getElementById('archiveListModal').classList.remove('hidden');
                    document.getElementById('chatHistoryMenu').classList.add('hidden');
                    loadArchivedChats();
                }

                function hideArchiveListModal() {
                    document.getElementById('archiveListModal').classList.add('hidden');
                }

                async function loadArchivedChats() {
                    if (!currentUser) return;

                    try {
                        const q = query(
                            collection(db, 'chats'),
                            orderBy('archivedAt', 'desc')
                        );

                        const snapshot = await getDocs(q);
                        const archivedChatsDiv = document.getElementById('archivedChats');
                        archivedChatsDiv.innerHTML = '';

                        let hasArchivedChats = false;

                        snapshot.forEach((doc) => {
                            const chat = doc.data();
                            if (chat.userId === currentUser.uid && chat.archived) {
                                hasArchivedChats = true;
                                const chatItem = document.createElement('div');
                                chatItem.className = 'glass-effect rounded-2xl p-4 hover-lift transition-all duration-300';
                                chatItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="theme-text-primary font-medium flex items-center gap-2">
                                        <i class="fas fa-archive text-blue-400"></i>
                                        ${chat.title}
                                    </div>
                                    <div class="theme-text-secondary text-sm mt-1">
                                        Archive ÿ¥ÿØŸá ÿØÿ±: ${chat.archivedAt ? new Date(chat.archivedAt.seconds * 1000).toLocaleDateString('fa-IR') : 'ŸÜÿßŸÖÿ¥ÿÆÿµ'}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="restoreChat('${doc.id}')" class="p-2 rounded-full bg-green-500 hover:bg-green-600 text-white hover-lift transition-all duration-300">
                                        <i class="fas fa-undo text-sm"></i>
                                    </button>
                                    <button onclick="permanentDeleteChat('${doc.id}')" class="p-2 rounded-full bg-red-500 hover:bg-red-600 text-white hover-lift transition-all duration-300">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                                archivedChatsDiv.appendChild(chatItem);
                            }
                        });

                        if (!hasArchivedChats) {
                            archivedChatsDiv.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-archive text-6xl theme-text-secondary mb-4"></i>
                            <p class="theme-text-secondary">There are no archived chats.</p>
                        </div>
                    `;
                        }
                    } catch (error) {
                        console.error('Error loading archived chats:', error);
                    }
                }

                // Global functions for chat menu actions
                window.toggleChatMenu = function (event, chatId) {
                    event.stopPropagation();
                    event.preventDefault();

                    // Hide all other menus first
                    document.querySelectorAll('[id^="chatMenu-"]').forEach(menu => {
                        if (menu.id !== `chatMenu-${chatId}`) {
                            menu.classList.add('hidden');
                            menu.parentElement.classList.remove('chat-menu-open');
                        }
                    });

                    // Toggle current menu
                    const menu = document.getElementById(`chatMenu-${chatId}`);
                    const container = menu.parentElement;

                    if (menu.classList.contains('hidden')) {
                        menu.classList.remove('hidden');
                        container.classList.add('chat-menu-open');
                    } else {
                        menu.classList.add('hidden');
                        container.classList.remove('chat-menu-open');
                    }
                };

                window.shareChatItem = function (chatId) {
                    currentChatId = chatId;
                    showShareModal();
                    const menu = document.getElementById(`chatMenu-${chatId}`);
                    menu.classList.add('hidden');
                    menu.parentElement.classList.remove('chat-menu-open');
                };

                window.renameChatItem = function (chatId, currentTitle) {
                    currentChatId = chatId;
                    document.getElementById('newChatName').value = currentTitle;
                    showRenameModal();
                    const menu = document.getElementById(`chatMenu-${chatId}`);
                    menu.classList.add('hidden');
                    menu.parentElement.classList.remove('chat-menu-open');
                };

                window.archiveChatItem = async function (chatId) {
                    try {
                        await updateDoc(doc(db, 'chats', chatId), {
                            archived: true,
                            archivedAt: new Date()
                        });

                        const menu = document.getElementById(`chatMenu-${chatId}`);
                        menu.classList.add('hidden');
                        menu.parentElement.classList.remove('chat-menu-open');
                        loadChatHistory(); // Refresh chat history

                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-2xl z-50 fade-in';
                        successDiv.textContent = 'Chat archived! üì¶';
                        document.body.appendChild(successDiv);

                        setTimeout(() => {
                            successDiv.remove();
                        }, 3000);

                        // If this was the current chat, create a new one
                        if (currentChatId === chatId) {
                            createNewChat();
                        }
                    } catch (error) {
                        console.error('Error archiving chat:', error);
                        alert('Error archiving chat üòî');
                    }
                };

                window.deleteChatItem = async function (chatId) {
                    if (!confirm('Are you sure you want to delete this chat? This action is irreversible!')) {
                        return;
                    }

                    try {
                        // Delete all messages in the chat
                        const messagesQuery = query(collection(db, 'chats', chatId, 'messages'));
                        const messagesSnapshot = await getDocs(messagesQuery);

                        const deletePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);

                        // Delete the chat document
                        await deleteDoc(doc(db, 'chats', chatId));

                        const menu = document.getElementById(`chatMenu-${chatId}`);
                        menu.classList.add('hidden');
                        menu.parentElement.classList.remove('chat-menu-open');
                        loadChatHistory(); // Refresh chat history

                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-2xl z-50 fade-in';
                        successDiv.textContent = 'Chat deleted! üóëÔ∏è';
                        document.body.appendChild(successDiv);

                        setTimeout(() => {
                            successDiv.remove();
                        }, 3000);

                        // If this was the current chat, create a new one
                        if (currentChatId === chatId) {
                            createNewChat();
                        }
                    } catch (error) {
                        console.error('Error deleting chat:', error);
                        alert('Error in Delete Chat üòî');
                    }
                };

                // Global functions for archive actions
                window.restoreChat = async function (chatId) {
                    try {
                        await updateDoc(doc(db, 'chats', chatId), {
                            archived: false,
                            archivedAt: null,
                            updatedAt: new Date()
                        });

                        loadArchivedChats(); // Refresh archive list
                        loadChatHistory(); // Refresh main chat history

                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-2xl z-50 fade-in';
                        successDiv.textContent = 'Chat restored! ‚úÖ';
                        document.body.appendChild(successDiv);

                        setTimeout(() => {
                            successDiv.remove();
                        }, 3000);
                    } catch (error) {
                        console.error('Error restoring chat:', error);
                        alert('Error retrieving chat üòî');
                    }
                };

                window.permanentDeleteChat = async function (chatId) {
                    if (!confirm('Are you sure you want to permanently delete this chat? This action is irreversible!')) {
                        return;
                    }

                    try {
                        // Delete all messages in the chat
                        const messagesQuery = query(collection(db, 'chats', chatId, 'messages'));
                        const messagesSnapshot = await getDocs(messagesQuery);

                        const deletePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);

                        // Delete the chat document
                        await deleteDoc(doc(db, 'chats', chatId));

                        loadArchivedChats(); // Refresh archive list

                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-2xl z-50 fade-in';
                        successDiv.textContent = 'Chat deleted forever! üóëÔ∏è';
                        document.body.appendChild(successDiv);

                        setTimeout(() => {
                            successDiv.remove();
                        }, 3000);
                    } catch (error) {
                        console.error('Error permanently deleting chat:', error);
                        alert('Error in Delete Chat üòî');
                    }
                };

                // Handle responsive sidebar
                window.addEventListener('resize', () => {
                    if (window.innerWidth >= 768) {
                        sidebar.classList.remove('translate-x-full');
                    } else {
                        sidebar.classList.add('translate-x-full');
                    }
                });

                function showChatLimitModal() {
                    document.getElementById('chatLimitModal').classList.remove('hidden');
                }

                // ÿØ⁄©ŸÖŸá Close
                document.getElementById('chatLimitClose').addEventListener('click', () => {
                    document.getElementById('chatLimitModal').classList.add('hidden');
                });

                // Buy Button ‚Üí ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ŸÖŸàÿØÿßŸÑ Ÿæÿ±€åŸÖ€åŸàŸÖ
                document.getElementById('chatLimitBuyBtn').addEventListener('click', () => {
                    document.getElementById('chatLimitModal').classList.add('hidden');
                    document.getElementById('premiumModal').classList.remove('hidden'); // ŸáŸÖŸàŸÜ ŸÖŸàÿØÿßŸÑ ÿÆÿ±€åÿØ
                });
                if (typeof response === "object" && response.type === "image") {
                    const img = document.createElement("img");
                    img.src = response.url;
                    img.className = "rounded-2xl max-w-xs hover-lift";
                    messageBubble.appendChild(img);
                }
                const welcomeAudio = document.getElementById("welcomeAudio");

                const audio = document.getElementById('welcomeAudio');

                document.getElementById('closeTips').addEventListener('click', () => {
                    // Close ŸÖŸàÿØÿßŸÑ
                    document.getElementById('tipsModal').classList.add('hidden');

                    // ŸæÿÆÿ¥ ÿµÿØÿß
                    if (audio) {
                        audio.currentTime = 0;
                        audio.play().catch(err => console.warn('Playback failed:', err));
                    }
                });

            </script>
            <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'98231e777770da45',t:'MTc1ODM5MDE0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
