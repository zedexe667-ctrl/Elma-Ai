<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ورود ادمین Elma 👑</title>
  <script src="https://kit.fontawesome.com/a2e0e6ad49.js" crossorigin="anonymous"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center">

  <!-- 🔐 صفحه ورود ادمین -->
  <div id="loginSection"
    class="glass-effect bg-gray-800 bg-opacity-70 p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-6 gradient-text">ورود ادمین Elma 👑</h1>

    <input id="adminEmail" type="email" placeholder="ایمیل ادمین"
      class="w-full p-3 mb-4 rounded-xl border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">

    <input id="adminPassword" type="password" placeholder="رمز عبور"
      class="w-full p-3 mb-4 rounded-xl border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">

    <button id="loginBtn"
      class="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl hover:scale-105 transition-all font-semibold">
      ورود
    </button>

    <p id="loginMsg" class="mt-4 text-sm text-red-400 hidden"></p>
  </div>

  <!-- 👑 پنل مدیریت -->
  <div id="adminPanel"
    class="hidden glass-effect bg-gray-800 bg-opacity-70 p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-6 gradient-text">🎯 پنل مدیریت Elma</h1>

    <div class="space-y-4 text-right">
      <label class="block text-sm">ایمیل کاربر:</label>
      <input id="userEmail" type="email"
        class="w-full p-3 rounded-xl border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400"
        placeholder="example@email.com">

      <label class="block text-sm mt-4">نوع حساب:</label>
      <select id="newType"
        class="w-full p-3 rounded-xl border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">
        <option value="free">رایگان 💕</option>
        <option value="premium">پریمیوم 👑</option>
      </select>

      <label class="block text-sm mt-4">مدت اشتراک:</label>
      <select id="planMonths"
        class="w-full p-3 rounded-xl border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">
        <option value="0">بدون تمدید</option>
        <option value="3">۳ ماه</option>
        <option value="6">۶ ماه</option>
        <option value="12">۱۲ ماه</option>
      </select>

      <button id="updateUser"
        class="w-full mt-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl hover:scale-105 transition-all font-semibold">
        <i class="fas fa-sync-alt mr-2"></i> به‌روزرسانی حساب
      </button>

      <p id="updateMsg" class="mt-4 text-sm text-green-400 hidden"></p>
    </div>

    <button id="logoutBtn" class="mt-8 text-sm text-gray-300 hover:text-red-400 transition-all duration-200">
      خروج از حساب
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDocs, query, where, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // 🔥 تنظیمات Firebase (جایگزین کن)
    const firebaseConfig = {
      apiKey: "AIzaSyD_Ar1zFTBS9DDFlAflPt2IpcQ5y8EI5pE",
      authDomain: "zed-exe-48839.firebaseapp.com",
      projectId: "zed-exe-48839",
      storageBucket: "zed-exe-48839.firebasestorage.app",
      messagingSenderId: "283941493182",
      appId: "1:283941493182:web:7a9deae50c01c9feb8c1ef",
      measurementId: "G-014WZDJBSL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 📌 فقط ایمیل‌های ادمین
    const adminEmails = ["elma.ai@gmail.com"];

    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");

    const userEmail = document.getElementById("userEmail");
    const newType = document.getElementById("newType");
    const planMonths = document.getElementById("planMonths");
    const updateUser = document.getElementById("updateUser");
    const updateMsg = document.getElementById("updateMsg");
    const logoutBtn = document.getElementById("logoutBtn");

    // 🔐 ورود ادمین
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("adminEmail").value.trim();
      const password = document.getElementById("adminPassword").value.trim();

      if (!email || !password) {
        showMsg("ایمیل و رمز عبور را وارد کنید", true);
        return;
      }

      try {
        const res = await signInWithEmailAndPassword(auth, email, password);
        if (adminEmails.includes(res.user.email)) {
          loginSection.classList.add("hidden");
          adminPanel.classList.remove("hidden");
        } else {
          showMsg("⛔️ این حساب ادمین نیست!", true);
          await signOut(auth);
        }
      } catch (err) {
        showMsg("❌ خطا در ورود: " + err.message, true);
      }
    });

    // 🚪 خروج
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      adminPanel.classList.add("hidden");
      loginSection.classList.remove("hidden");
    });

    // 👁️ بررسی وضعیت ورود
    onAuthStateChanged(auth, (user) => {
      if (user && adminEmails.includes(user.email)) {
        loginSection.classList.add("hidden");
        adminPanel.classList.remove("hidden");
      } else {
        adminPanel.classList.add("hidden");
        loginSection.classList.remove("hidden");
      }
    });

    // ⚙️ بروزرسانی حساب کاربر
    updateUser.addEventListener("click", async () => {
      updateMsg.classList.add("hidden");
      const email = userEmail.value.trim();
      const type = newType.value;
      const months = parseInt(planMonths.value);

      if (!email) {
        showMsg("ایمیل کاربر را وارد کنید", true);
        return;
      }

      try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const snap = await getDocs(q);

        if (snap.empty) {
          showMsg("❗️کاربری با این ایمیل پیدا نشد", true);
          return;
        }

        for (const docSnap of snap.docs) {
          const userRef = doc(db, "users", docSnap.id);
          const data = docSnap.data();

          const now = new Date();
          let newExpiry = new Date();
          const currentExpiry = data.premiumExpiry ? new Date(data.premiumExpiry) : null;

          if (type === "premium" && months > 0) {
            if (currentExpiry && currentExpiry > now) {
              newExpiry = new Date(currentExpiry);
              newExpiry.setMonth(newExpiry.getMonth() + months);
            } else {
              newExpiry.setMonth(now.getMonth() + months);
            }

            await updateDoc(userRef, {
              accountType: "premium",
              purchasedPlus: true,
              premiumExpiry: newExpiry.toISOString()
            });

            showMsg(`✅ حساب ${email} تا ${newExpiry.toLocaleDateString("fa-IR")} تمدید شد`);
          } else {
            await updateDoc(userRef, { accountType: type });
            showMsg(`✅ حساب ${email} به "${type}" تغییر کرد`);
          }
        }
      } catch (err) {
        showMsg("❌ خطا در بروزرسانی حساب: " + err.message, true);
      }
    });

    // 📩 پیام
    function showMsg(msg, isError = false) {
      loginMsg.textContent = msg;
      loginMsg.classList.remove("hidden");
      loginMsg.classList.toggle("text-red-400", isError);
      loginMsg.classList.toggle("text-green-400", !isError);
      updateMsg.textContent = msg;
      updateMsg.classList.remove("hidden");
      updateMsg.classList.toggle("text-red-400", isError);
      updateMsg.classList.toggle("text-green-400", !isError);
    }
  </script>

  <style>
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
    }

    .gradient-text {
      background: linear-gradient(to right, #f472b6, #8b5cf6);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
  </style>

</body>

</html>
